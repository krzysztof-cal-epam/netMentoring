√<
\C:\netMentoring\04_layered_architectures\CartServiceConsoleApp\IdentityServerApi\SeedData.cs
	namespace		 	
IdentityServerApi		
 
;		 
public 
class 
SeedData 
{ 
public 

static 
void 
EnsureSeedData %
(% &
WebApplication& 4
app5 8
)8 9
{ 
using 
( 
var 
scope 
= 
app 
. 
Services '
.' (
GetRequiredService( :
<: ; 
IServiceScopeFactory; O
>O P
(P Q
)Q R
.R S
CreateScopeS ^
(^ _
)_ `
)` a
{ 	
var 
context 
= 
scope 
.  
ServiceProvider  /
./ 0
GetRequiredService0 B
<B C 
ApplicationDbContextC W
>W X
(X Y
)Y Z
;Z [
context 
. 
Database 
. 
Migrate $
($ %
)% &
;& '
var 
userMgr 
= 
scope 
.  
ServiceProvider  /
./ 0
GetRequiredService0 B
<B C
UserManagerC N
<N O
ApplicationUserO ^
>^ _
>_ `
(` a
)a b
;b c
var 
alice 
= 
userMgr 
.  
FindByNameAsync  /
(/ 0
$str0 7
)7 8
.8 9
Result9 ?
;? @
if 
( 
alice 
== 
null 
) 
{ 
alice 
= 
new 
ApplicationUser +
{ 
UserName 
= 
$str &
,& '
Email 
= 
$str 2
,2 3
EmailConfirmed "
=# $
true% )
,) *
} 
; 
var 
result 
= 
userMgr $
.$ %
CreateAsync% 0
(0 1
alice1 6
,6 7
$str8 B
)B C
.C D
ResultD J
;J K
if 
( 
! 
result 
. 
	Succeeded %
)% &
{   
throw!! 
new!! 
	Exception!! '
(!!' (
result!!( .
.!!. /
Errors!!/ 5
.!!5 6
First!!6 ;
(!!; <
)!!< =
.!!= >
Description!!> I
)!!I J
;!!J K
}"" 
result$$ 
=$$ 
userMgr$$  
.$$  !
AddClaimsAsync$$! /
($$/ 0
alice$$0 5
,$$5 6
new$$7 :
Claim$$; @
[$$@ A
]$$A B
{$$B C
new%% 
Claim%%  %
(%%% &
JwtClaimTypes%%& 3
.%%3 4
Name%%4 8
,%%8 9
$str%%: G
)%%G H
,%%H I
new&& 
Claim&&  %
(&&% &
JwtClaimTypes&&& 3
.&&3 4
	GivenName&&4 =
,&&= >
$str&&? F
)&&F G
,&&G H
new'' 
Claim''  %
(''% &
JwtClaimTypes''& 3
.''3 4

FamilyName''4 >
,''> ?
$str''@ G
)''G H
,''H I
new(( 
Claim((  %
(((% &
JwtClaimTypes((& 3
.((3 4
WebSite((4 ;
,((; <
$str((= O
)((O P
,((P Q
})) 
))) 
.)) 
Result)) !
;))! "
if** 
(** 
!** 
result** 
.** 
	Succeeded** %
)**% &
{++ 
throw,, 
new,, 
	Exception,, '
(,,' (
result,,( .
.,,. /
Errors,,/ 5
.,,5 6
First,,6 ;
(,,; <
),,< =
.,,= >
Description,,> I
),,I J
;,,J K
}-- 
Log.. 
... 
Debug.. 
(.. 
$str.. )
)..) *
;..* +
}// 
else00 
{11 
Log22 
.22 
Debug22 
(22 
$str22 0
)220 1
;221 2
}33 
var55 
bob55 
=55 
userMgr55 
.55 
FindByNameAsync55 -
(55- .
$str55. 3
)553 4
.554 5
Result555 ;
;55; <
if66 
(66 
bob66 
==66 
null66 
)66 
{77 
bob88 
=88 
new88 
ApplicationUser88 )
{99 
UserName:: 
=:: 
$str:: $
,::$ %
Email;; 
=;; 
$str;; 0
,;;0 1
EmailConfirmed<< "
=<<# $
true<<% )
}== 
;== 
var>> 
result>> 
=>> 
userMgr>> $
.>>$ %
CreateAsync>>% 0
(>>0 1
bob>>1 4
,>>4 5
$str>>6 @
)>>@ A
.>>A B
Result>>B H
;>>H I
if?? 
(?? 
!?? 
result?? 
.?? 
	Succeeded?? %
)??% &
{@@ 
throwAA 
newAA 
	ExceptionAA '
(AA' (
resultAA( .
.AA. /
ErrorsAA/ 5
.AA5 6
FirstAA6 ;
(AA; <
)AA< =
.AA= >
DescriptionAA> I
)AAI J
;AAJ K
}BB 
resultDD 
=DD 
userMgrDD  
.DD  !
AddClaimsAsyncDD! /
(DD/ 0
bobDD0 3
,DD3 4
newDD5 8
ClaimDD9 >
[DD> ?
]DD? @
{DD@ A
newEE 
ClaimEE  %
(EE% &
JwtClaimTypesEE& 3
.EE3 4
NameEE4 8
,EE8 9
$strEE: E
)EEE F
,EEF G
newFF 
ClaimFF  %
(FF% &
JwtClaimTypesFF& 3
.FF3 4
	GivenNameFF4 =
,FF= >
$strFF? D
)FFD E
,FFE F
newGG 
ClaimGG  %
(GG% &
JwtClaimTypesGG& 3
.GG3 4

FamilyNameGG4 >
,GG> ?
$strGG@ G
)GGG H
,GGH I
newHH 
ClaimHH  %
(HH% &
JwtClaimTypesHH& 3
.HH3 4
WebSiteHH4 ;
,HH; <
$strHH= M
)HHM N
,HHN O
newII 
ClaimII  %
(II% &
$strII& 0
,II0 1
$strII2 =
)II= >
}JJ 
)JJ 
.JJ 
ResultJJ !
;JJ! "
ifKK 
(KK 
!KK 
resultKK 
.KK 
	SucceededKK %
)KK% &
{LL 
throwMM 
newMM 
	ExceptionMM '
(MM' (
resultMM( .
.MM. /
ErrorsMM/ 5
.MM5 6
FirstMM6 ;
(MM; <
)MM< =
.MM= >
DescriptionMM> I
)MMI J
;MMJ K
}NN 
LogOO 
.OO 
DebugOO 
(OO 
$strOO '
)OO' (
;OO( )
}PP 
elseQQ 
{RR 
LogSS 
.SS 
DebugSS 
(SS 
$strSS .
)SS. /
;SS/ 0
}TT 
}UU 	
}VV 
}WW äB
[C:\netMentoring\04_layered_architectures\CartServiceConsoleApp\IdentityServerApi\Program.cs
Log 
. 
Logger 

= 
new 
LoggerConfiguration $
($ %
)% &
. 
WriteTo 
. 
Console 
( 
) 
.		 !
CreateBootstrapLogger		 
(		 
)		 
;		 
Log 
. 
Information 
( 
$str 
) 
; 
try 
{ 
var 
builder 
= 
WebApplication  
.  !
CreateBuilder! .
(. /
args/ 3
)3 4
;4 5
builder 
. 
Host 
. 

UseSerilog 
( 
( 
ctx  
,  !
lc" $
)$ %
=>& (
lc) +
. 	
WriteTo	 
. 
Console 
( 
outputTemplate '
:' (
$str	) ã
)
ã å
. 	
Enrich	 
. 
FromLogContext 
( 
)  
. 	
ReadFrom	 
. 
Configuration 
(  
ctx  #
.# $
Configuration$ 1
)1 2
)2 3
;3 4
builder 
. 
Services 
. 
AddCors 
( 
options $
=>% '
{ 
options 
. 
	AddPolicy 
( 
$str $
,$ %
builder& -
=>. 0
builder1 8
.8 9
AllowAnyOrigin9 G
(G H
)H I
.I J
AllowAnyMethodJ X
(X Y
)Y Z
.Z [
AllowAnyHeader[ i
(i j
)j k
)k l
;l m
} 
) 
; 
builder 
. 
ConfigureServices 
( 
) 
;  
var 
app 
= 
builder 
. 
Build 
( 
) 
; 
app 
. 
UseCors 
( 
$str 
) 
; 
app!! 
.!! 
ConfigurePipeline!! 
(!! 
)!! 
;!! 
if## 
(## 
args## 
.## 
Contains## 
(## 
$str## 
)## 
)## 
{$$ 
Log%% 
.%% 
Information%% 
(%% 
$str%% -
)%%- .
;%%. /
using&& 
(&& 
var&& 
scope&& 
=&& 
app&& 
.&& 
Services&& '
.&&' (
CreateScope&&( 3
(&&3 4
)&&4 5
)&&5 6
{'' 	
var(( 
userManager(( 
=(( 
scope(( #
.((# $
ServiceProvider(($ 3
.((3 4
GetRequiredService((4 F
<((F G
UserManager((G R
<((R S
IdentityUser((S _
>((_ `
>((` a
(((a b
)((b c
;((c d
var)) 
roleManager)) 
=)) 
scope)) #
.))# $
ServiceProvider))$ 3
.))3 4
GetRequiredService))4 F
<))F G
RoleManager))G R
<))R S
IdentityRole))S _
>))_ `
>))` a
())a b
)))b c
;))c d
var** 
context** 
=** 
scope** 
.**  
ServiceProvider**  /
.**/ 0
GetRequiredService**0 B
<**B C 
ApplicationDbContext**C W
>**W X
(**X Y
)**Y Z
;**Z [
await,, 
context,, 
.,, 
Database,, "
.,," #
MigrateAsync,,# /
(,,/ 0
),,0 1
;,,1 2
await.. 

EnsureRole.. 
(.. 
roleManager.. (
,..( )
$str..* 3
)..3 4
;..4 5
await// 

EnsureRole// 
(// 
roleManager// (
,//( )
$str//* 9
)//9 :
;//: ;
var11 
user11 
=11 
await11 
userManager11 (
.11( )
FindByNameAsync11) 8
(118 9
$str119 C
)11C D
;11D E
if22 
(22 
user22 
==22 
null22 
)22 
{33 
user44 
=44 
new44 
IdentityUser44 '
{44( )
UserName44* 2
=443 4
$str445 ?
,44? @
Email44A F
=44G H
$str44I _
}44` a
;44a b
var55 
result55 
=55 
await55 "
userManager55# .
.55. /
CreateAsync55/ :
(55: ;
user55; ?
,55? @
$str55A N
)55N O
;55O P
if66 
(66 
result66 
.66 
	Succeeded66 $
)66$ %
{77 
await88 
userManager88 %
.88% &
AddToRoleAsync88& 4
(884 5
user885 9
,889 :
$str88; D
)88D E
;88E F
}99 
else:: 
{;; 
Log<< 
.<< 
Error<< 
(<< 
$str<< ?
,<<? @
string<<A G
.<<G H
Join<<H L
(<<L M
$str<<M Q
,<<Q R
result<<S Y
.<<Y Z
Errors<<Z `
.<<` a
Select<<a g
(<<g h
e<<h i
=><<j l
e<<m n
.<<n o
Description<<o z
)<<z {
)<<{ |
)<<| }
;<<} ~
}== 
}>> 
}?? 	
Log@@ 
.@@ 
Information@@ 
(@@ 
$str@@ 9
)@@9 :
;@@: ;
returnAA 
;AA 
}BB 
appDD 
.DD 
RunDD 
(DD 
)DD 
;DD 
}EE 
catchFF 
(FF 
	ExceptionFF 
exFF 
)FF 
whenFF 
(FF 
exFF 
isFF  
notFF! $ 
HostAbortedExceptionFF% 9
)FF9 :
{GG 
LogHH 
.HH 
FatalHH 
(HH 
exHH 
,HH 
$strHH '
)HH' (
;HH( )
}II 
finallyJJ 
{KK 
LogLL 
.LL 
InformationLL 
(LL 
$strLL (
)LL( )
;LL) *
LogMM 
.MM 
CloseAndFlushMM 
(MM 
)MM 
;MM 
}NN 
asyncPP 
TaskPP 


EnsureRolePP 
(PP 
RoleManagerPP !
<PP! "
IdentityRolePP" .
>PP. /
roleManagerPP0 ;
,PP; <
stringPP= C
roleNamePPD L
)PPL M
{QQ 
ifRR 
(RR 
!RR 	
awaitRR	 
roleManagerRR 
.RR 
RoleExistsAsyncRR *
(RR* +
roleNameRR+ 3
)RR3 4
)RR4 5
{SS 
varTT 
resultTT 
=TT 
awaitTT 
roleManagerTT &
.TT& '
CreateAsyncTT' 2
(TT2 3
newTT3 6
IdentityRoleTT7 C
(TTC D
roleNameTTD L
)TTL M
)TTM N
;TTN O
ifUU 

(UU 
!UU 
resultUU 
.UU 
	SucceededUU 
)UU 
{VV 	
LogWW 
.WW 
ErrorWW 
(WW 
$strWW >
,WW> ?
roleNameWW@ H
,WWH I
stringWWJ P
.WWP Q
JoinWWQ U
(WWU V
$strWWV Z
,WWZ [
resultWW\ b
.WWb c
ErrorsWWc i
.WWi j
SelectWWj p
(WWp q
eWWq r
=>WWs u
eWWv w
.WWw x
Description	WWx É
)
WWÉ Ñ
)
WWÑ Ö
)
WWÖ Ü
;
WWÜ á
}XX 	
}YY 
}ZZ æO
cC:\netMentoring\04_layered_architectures\CartServiceConsoleApp\IdentityServerApi\Pages\Telemetry.cs
	namespace 	
IdentityServerApi
 
. 
Pages !
;! "
public 
static 
class 
	Telemetry 
{ 
private 
static 
readonly 
string "
ServiceVersion# 1
=2 3
typeof4 :
(: ;
	Telemetry; D
)D E
.E F
AssemblyF N
.N O
GetNameO V
(V W
)W X
.X Y
VersionY `
!` a
.a b
ToStringb j
(j k
)k l
;l m
public 

static 
readonly 
string !
ServiceName" -
=. /
typeof0 6
(6 7
	Telemetry7 @
)@ A
.A B
AssemblyB J
.J K
GetNameK R
(R S
)S T
.T U
NameU Y
!Y Z
;Z [
public 

static 
class 
Metrics 
{ 
public!! 
static!! 
class!! 
Counters!! $
{"" 	
public## 
const## 
string## 
Consent##  '
=##( )
$str##* @
;##@ A
public$$ 
const$$ 
string$$ 
GrantsRevokedName$$  1
=$$2 3
$str$$4 Q
;$$Q R
public%% 
const%% 
string%% 
UserLoginName%%  -
=%%. /
$str%%0 I
;%%I J
public&& 
const&& 
string&& 
UserLogoutName&&  .
=&&/ 0
$str&&1 K
;&&K L
}'' 	
public,, 
static,, 
class,, 
Tags,,  
{-- 	
public.. 
const.. 
string.. 
Client..  &
=..' (
$str..) 1
;..1 2
public// 
const// 
string// 
Error//  %
=//& '
$str//( /
;/// 0
public00 
const00 
string00 
Idp00  #
=00$ %
$str00& +
;00+ ,
public11 
const11 
string11 
Remember11  (
=11) *
$str11+ 5
;115 6
public22 
const22 
string22 
Scope22  %
=22& '
$str22( /
;22/ 0
public33 
const33 
string33 
Consent33  '
=33( )
$str33* 3
;333 4
}44 	
public99 
static99 
class99 
	TagValues99 %
{:: 	
public;; 
const;; 
string;; 
Granted;;  '
=;;( )
$str;;* 3
;;;3 4
public<< 
const<< 
string<< 
Denied<<  &
=<<' (
$str<<) 1
;<<1 2
}== 	
privateDD 
staticDD 
readonlyDD 
MeterDD  %
MeterDD& +
=DD, -
newDD. 1
MeterDD2 7
(DD7 8
ServiceNameDD8 C
,DDC D
ServiceVersionDDE S
)DDS T
;DDT U
privateFF 
staticFF 
CounterFF 
<FF 
longFF #
>FF# $
ConsentCounterFF% 3
=FF4 5
MeterFF6 ;
.FF; <
CreateCounterFF< I
<FFI J
longFFJ N
>FFN O
(FFO P
CountersFFP X
.FFX Y
ConsentFFY `
)FF` a
;FFa b
publicNN 
staticNN 
voidNN 
ConsentGrantedNN )
(NN) *
stringNN* 0
clientIdNN1 9
,NN9 :
IEnumerableNN; F
<NNF G
stringNNG M
>NNM N
scopesNNO U
,NNU V
boolNNW [
rememberNN\ d
)NNd e
{OO 	!
ArgumentNullExceptionPP !
.PP! "
ThrowIfNullPP" -
(PP- .
scopesPP. 4
)PP4 5
;PP5 6
foreachRR 
(RR 
varRR 
scopeRR 
inRR !
scopesRR" (
)RR( )
{SS 
ConsentCounterTT 
.TT 
AddTT "
(TT" #
$numTT# $
,TT$ %
newUU 
(UU 
TagsUU 
.UU 
ClientUU #
,UU# $
clientIdUU% -
)UU- .
,UU. /
newVV 
(VV 
TagsVV 
.VV 
ScopeVV "
,VV" #
scopeVV$ )
)VV) *
,VV* +
newWW 
(WW 
TagsWW 
.WW 
RememberWW %
,WW% &
rememberWW' /
)WW/ 0
,WW0 1
newXX 
(XX 
TagsXX 
.XX 
ConsentXX $
,XX$ %
	TagValuesXX& /
.XX/ 0
GrantedXX0 7
)XX7 8
)XX8 9
;XX9 :
}YY 
}ZZ 	
publicbb 
staticbb 
voidbb 
ConsentDeniedbb (
(bb( )
stringbb) /
clientIdbb0 8
,bb8 9
IEnumerablebb: E
<bbE F
stringbbF L
>bbL M
scopesbbN T
)bbT U
{cc 	!
ArgumentNullExceptiondd !
.dd! "
ThrowIfNulldd" -
(dd- .
scopesdd. 4
)dd4 5
;dd5 6
foreachee 
(ee 
varee 
scopeee 
inee !
scopesee" (
)ee( )
{ff 
ConsentCountergg 
.gg 
Addgg "
(gg" #
$numgg# $
,gg$ %
newgg& )
(gg) *
Tagsgg* .
.gg. /
Clientgg/ 5
,gg5 6
clientIdgg7 ?
)gg? @
,gg@ A
newggB E
(ggE F
TagsggF J
.ggJ K
ScopeggK P
,ggP Q
scopeggR W
)ggW X
,ggX Y
newggZ ]
(gg] ^
Tagsgg^ b
.ggb c
Consentggc j
,ggj k
	TagValuesggl u
.ggu v
Deniedggv |
)gg| }
)gg} ~
;gg~ 
}hh 
}ii 	
privatekk 
statickk 
Counterkk 
<kk 
longkk #
>kk# $ 
GrantsRevokedCounterkk% 9
=kk: ;
Meterkk< A
.kkA B
CreateCounterkkB O
<kkO P
longkkP T
>kkT U
(kkU V
CounterskkV ^
.kk^ _
GrantsRevokedNamekk_ p
)kkp q
;kkq r
publicqq 
staticqq 
voidqq 
GrantsRevokedqq (
(qq( )
stringqq) /
?qq/ 0
clientIdqq1 9
)qq9 :
=>rr  
GrantsRevokedCounterrr #
.rr# $
Addrr$ '
(rr' (
$numrr( )
,rr) *
tagrr+ .
:rr. /
newrr0 3
(rr3 4
Tagsrr4 8
.rr8 9
Clientrr9 ?
,rr? @
clientIdrrA I
)rrI J
)rrJ K
;rrK L
privatett 
statictt 
Countertt 
<tt 
longtt #
>tt# $
UserLoginCountertt% 5
=tt6 7
Metertt8 =
.tt= >
CreateCountertt> K
<ttK L
longttL P
>ttP Q
(ttQ R
CountersttR Z
.ttZ [
UserLoginNamett[ h
)tth i
;tti j
publiczz 
staticzz 
voidzz 
	UserLoginzz $
(zz$ %
stringzz% +
?zz+ ,
clientIdzz- 5
,zz5 6
stringzz7 =
idpzz> A
)zzA B
=>{{ 
UserLoginCounter{{ 
.{{  
Add{{  #
({{# $
$num{{$ %
,{{% &
new{{' *
({{* +
Tags{{+ /
.{{/ 0
Client{{0 6
,{{6 7
clientId{{8 @
){{@ A
,{{A B
new{{C F
({{F G
Tags{{G K
.{{K L
Idp{{L O
,{{O P
idp{{Q T
){{T U
){{U V
;{{V W
public
ÇÇ 
static
ÇÇ 
void
ÇÇ 
UserLoginFailure
ÇÇ +
(
ÇÇ+ ,
string
ÇÇ, 2
?
ÇÇ2 3
clientId
ÇÇ4 <
,
ÇÇ< =
string
ÇÇ> D
idp
ÇÇE H
,
ÇÇH I
string
ÇÇJ P
error
ÇÇQ V
)
ÇÇV W
=>
ÉÉ 
UserLoginCounter
ÉÉ 
.
ÉÉ  
Add
ÉÉ  #
(
ÉÉ# $
$num
ÉÉ$ %
,
ÉÉ% &
new
ÉÉ' *
(
ÉÉ* +
Tags
ÉÉ+ /
.
ÉÉ/ 0
Client
ÉÉ0 6
,
ÉÉ6 7
clientId
ÉÉ8 @
)
ÉÉ@ A
,
ÉÉA B
new
ÉÉC F
(
ÉÉF G
Tags
ÉÉG K
.
ÉÉK L
Idp
ÉÉL O
,
ÉÉO P
idp
ÉÉQ T
)
ÉÉT U
,
ÉÉU V
new
ÉÉW Z
(
ÉÉZ [
Tags
ÉÉ[ _
.
ÉÉ_ `
Error
ÉÉ` e
,
ÉÉe f
error
ÉÉg l
)
ÉÉl m
)
ÉÉm n
;
ÉÉn o
private
ÖÖ 
static
ÖÖ 
Counter
ÖÖ 
<
ÖÖ 
long
ÖÖ #
>
ÖÖ# $
UserLogoutCounter
ÖÖ% 6
=
ÖÖ7 8
Meter
ÖÖ9 >
.
ÖÖ> ?
CreateCounter
ÖÖ? L
<
ÖÖL M
long
ÖÖM Q
>
ÖÖQ R
(
ÖÖR S
Counters
ÖÖS [
.
ÖÖ[ \
UserLogoutName
ÖÖ\ j
)
ÖÖj k
;
ÖÖk l
public
ãã 
static
ãã 
void
ãã 

UserLogout
ãã %
(
ãã% &
string
ãã& ,
?
ãã, -
idp
ãã. 1
)
ãã1 2
=>
åå 
UserLogoutCounter
åå  
.
åå  !
Add
åå! $
(
åå$ %
$num
åå% &
,
åå& '
tag
åå( +
:
åå+ ,
new
åå- 0
(
åå0 1
Tags
åå1 5
.
åå5 6
Idp
åå6 9
,
åå9 :
idp
åå; >
)
åå> ?
)
åå? @
;
åå@ A
}
çç 
}éé ﬁ&
yC:\netMentoring\04_layered_architectures\CartServiceConsoleApp\IdentityServerApi\Pages\ServerSideSessions\Index.cshtml.cs
	namespace

 	
IdentityServerApi


 
.

 
Pages

 !
.

! "
ServerSideSessions

" 4
{ 
public 

class 

IndexModel 
: 
	PageModel '
{ 
private 
readonly %
ISessionManagementService 2
?2 3%
_sessionManagementService4 M
;M N
public 

IndexModel 
( %
ISessionManagementService 3
?3 4$
sessionManagementService5 M
=N O
nullP T
)T U
{ 	%
_sessionManagementService %
=& '$
sessionManagementService( @
;@ A
} 	
public 
QueryResult 
< 
UserSession &
>& '
?' (
UserSessions) 5
{6 7
get8 ;
;; <
set= @
;@ A
}B C
[ 	
BindProperty	 
( 
SupportsGet !
=" #
true$ (
)( )
]) *
public 
string 
? 
DisplayNameFilter (
{) *
get+ .
;. /
set0 3
;3 4
}5 6
[ 	
BindProperty	 
( 
SupportsGet !
=" #
true$ (
)( )
]) *
public 
string 
? 
SessionIdFilter &
{' (
get) ,
;, -
set. 1
;1 2
}3 4
[ 	
BindProperty	 
( 
SupportsGet !
=" #
true$ (
)( )
]) *
public 
string 
? 
SubjectIdFilter &
{' (
get) ,
;, -
set. 1
;1 2
}3 4
[   	
BindProperty  	 
(   
SupportsGet   !
=  " #
true  $ (
)  ( )
]  ) *
public!! 
string!! 
?!! 
Token!! 
{!! 
get!! "
;!!" #
set!!$ '
;!!' (
}!!) *
[## 	
BindProperty##	 
(## 
SupportsGet## !
=##" #
true##$ (
)##( )
]##) *
public$$ 
string$$ 
?$$ 
Prev$$ 
{$$ 
get$$ !
;$$! "
set$$# &
;$$& '
}$$( )
public&& 
async&& 
Task&& 
OnGet&& 
(&&  
)&&  !
{'' 	
if(( 
((( %
_sessionManagementService(( )
!=((* ,
null((- 1
)((1 2
{)) 
UserSessions** 
=** 
await** $%
_sessionManagementService**% >
.**> ?
QuerySessionsAsync**? Q
(**Q R
new**R U
SessionQuery**V b
{++ 
ResultsToken,,  
=,,! "
Token,,# (
,,,( )
RequestPriorResults-- '
=--( )
Prev--* .
==--/ 1
$str--2 8
,--8 9
DisplayName.. 
=..  !
DisplayNameFilter.." 3
,..3 4
	SessionId// 
=// 
SessionIdFilter//  /
,/// 0
	SubjectId00 
=00 
SubjectIdFilter00  /
}11 
)11 
;11 
}22 
}33 	
[55 	
BindProperty55	 
]55 
public66 
string66 
?66 
	SessionId66  
{66! "
get66# &
;66& '
set66( +
;66+ ,
}66- .
public88 
async88 
Task88 
<88 
IActionResult88 '
>88' (
OnPost88) /
(88/ 0
)880 1
{99 	!
ArgumentNullException:: !
.::! "
ThrowIfNull::" -
(::- .%
_sessionManagementService::. G
)::G H
;::H I
await<< %
_sessionManagementService<< +
.<<+ ,
RemoveSessionsAsync<<, ?
(<<? @
new<<@ C!
RemoveSessionsContext<<D Y
{<<Z [
	SessionId== 
=== 
	SessionId== %
,==% &
}>> 
)>> 
;>> 
return?? 
RedirectToPage?? !
(??! "
$str??" =
,??= >
new??? B
{??C D
Token??E J
,??J K
DisplayNameFilter??L ]
,??] ^
SessionIdFilter??_ n
,??n o
SubjectIdFilter??p 
,	?? Ä
Prev
??Å Ö
}
??Ü á
)
??á à
;
??à â
}@@ 	
}AA 
}BB ¿ 
rC:\netMentoring\04_layered_architectures\CartServiceConsoleApp\IdentityServerApi\Pages\SecurityHeadersAttribute.cs
	namespace 	
IdentityServerApi
 
. 
Pages !
;! "
public		 
sealed		 
class		 $
SecurityHeadersAttribute		 ,
:		- .!
ActionFilterAttribute		/ D
{

 
public 

override 
void 
OnResultExecuting *
(* +"
ResultExecutingContext+ A
contextB I
)I J
{ !
ArgumentNullException 
. 
ThrowIfNull )
() *
context* 1
,1 2
nameof3 9
(9 :
context: A
)A B
)B C
;C D
var 
result 
= 
context 
. 
Result #
;# $
if 

( 
result 
is 

PageResult  
)  !
{ 	
if 
( 
! 
context 
. 
HttpContext $
.$ %
Response% -
.- .
Headers. 5
.5 6
ContainsKey6 A
(A B
$strB Z
)Z [
)[ \
{ 
context 
. 
HttpContext #
.# $
Response$ ,
., -
Headers- 4
.4 5
Append5 ;
(; <
$str< T
,T U
$strV _
)_ `
;` a
} 
if 
( 
! 
context 
. 
HttpContext $
.$ %
Response% -
.- .
Headers. 5
.5 6
ContainsKey6 A
(A B
$strB S
)S T
)T U
{ 
context 
. 
HttpContext #
.# $
Response$ ,
., -
Headers- 4
.4 5
Append5 ;
(; <
$str< M
,M N
$strO U
)U V
;V W
} 
var 
csp 
= 
$str	 ú
;
ú ù
if&& 
(&& 
!&& 
context&& 
.&& 
HttpContext&& $
.&&$ %
Response&&% -
.&&- .
Headers&&. 5
.&&5 6
ContainsKey&&6 A
(&&A B
$str&&B [
)&&[ \
)&&\ ]
{'' 
context(( 
.(( 
HttpContext(( #
.((# $
Response(($ ,
.((, -
Headers((- 4
.((4 5
Append((5 ;
(((; <
$str((< U
,((U V
csp((W Z
)((Z [
;(([ \
})) 
if++ 
(++ 
!++ 
context++ 
.++ 
HttpContext++ $
.++$ %
Response++% -
.++- .
Headers++. 5
.++5 6
ContainsKey++6 A
(++A B
$str++B ]
)++] ^
)++^ _
{,, 
context-- 
.-- 
HttpContext-- #
.--# $
Response--$ ,
.--, -
Headers--- 4
.--4 5
Append--5 ;
(--; <
$str--< W
,--W X
csp--Y \
)--\ ]
;--] ^
}.. 
var11 
referrer_policy11 
=11  !
$str11" /
;11/ 0
if22 
(22 
!22 
context22 
.22 
HttpContext22 $
.22$ %
Response22% -
.22- .
Headers22. 5
.225 6
ContainsKey226 A
(22A B
$str22B S
)22S T
)22T U
{33 
context44 
.44 
HttpContext44 #
.44# $
Response44$ ,
.44, -
Headers44- 4
.444 5
Append445 ;
(44; <
$str44< M
,44M N
referrer_policy44O ^
)44^ _
;44_ `
}55 
}66 	
}77 
}88 Ù	
oC:\netMentoring\04_layered_architectures\CartServiceConsoleApp\IdentityServerApi\Pages\Redirect\Index.cshtml.cs
	namespace 	
IdentityServerApi
 
. 
Pages !
.! "
Redirect" *
;* +
[

 
AllowAnonymous

 
]

 
public 
class 

IndexModel 
: 
	PageModel #
{ 
public 

string 
? 
RedirectUri 
{  
get! $
;$ %
set& )
;) *
}+ ,
public 

IActionResult 
OnGet 
( 
string %
?% &
redirectUri' 2
)2 3
{ 
if 

( 
! 
Url 
. 

IsLocalUrl 
( 
redirectUri '
)' (
)( )
{ 	
return 
RedirectToPage !
(! "
$str" 5
)5 6
;6 7
} 	
RedirectUri 
= 
redirectUri !
;! "
return 
Page 
( 
) 
; 
} 
} ﬁ9
]C:\netMentoring\04_layered_architectures\CartServiceConsoleApp\IdentityServerApi\Pages\Log.cs
	namespace 	
IdentityServerApi
 
. 
Pages !
;! "
internal 
static	 
class 
Log 
{ 
private 
static	 
readonly 
Action 
<  
ILogger  '
,' (
string) /
?/ 0
,0 1
	Exception2 ;
?; <
>< =

_invalidId> H
=I J
LoggerMessageK X
.X Y
DefineY _
<_ `
string` f
?f g
>g h
(h i
LogLevel		 
.		 
Error		 
,		 
EventIds

 
.

 
	InvalidId

 
,

 
$str 
) 
; 
public 

static 
void 
	InvalidId  
(  !
this! %
ILogger& -
logger. 4
,4 5
string6 <
?< =
id> @
)@ A
{ 

_invalidId 
( 
logger 
, 
id 
, 
null #
)# $
;$ %
} 
private 
static	 
readonly 
Action 
<  
ILogger  '
,' (
string) /
?/ 0
,0 1
	Exception2 ;
?; <
>< =&
_invalidBackchannelLoginId> X
=Y Z
LoggerMessage[ h
.h i
Definei o
<o p
stringp v
?v w
>w x
(x y
LogLevel 	
.	 

Warning
 
, 
EventIds 	
.	 
%
InvalidBackchannelLoginId
 #
,# $
$str $
)$ %
;% &
public 
static 
void %
InvalidBackchannelLoginId -
(- .
this. 2
ILogger3 :
logger; A
,A B
stringC I
?I J
idK M
)M N
{ &
_invalidBackchannelLoginId 
( 
logger #
,# $
id% '
,' (
null) -
)- .
;. /
} 
private 
static	 
Action 
< 
ILogger 
, 
IEnumerable  +
<+ ,
string, 2
>2 3
,3 4
	Exception5 >
?> ?
>? @
_externalClaimsA P
=Q R
LoggerMessageS `
.` a
Definea g
<g h
IEnumerableh s
<s t
stringt z
>z {
>{ |
(| }
LogLevel 

.
 
Debug 
, 
EventIds 

.
 
ExternalClaims 
, 
$str 
) 
; 
public!! 
static!! 
void!! 
ExternalClaims!! "
(!!" #
this!!# '
ILogger!!( /
logger!!0 6
,!!6 7
IEnumerable!!8 C
<!!C D
string!!D J
>!!J K
claims!!L R
)!!R S
{"" 
_externalClaims## 
(## 
logger## 
,## 
claims##  
,##  !
null##" &
)##& '
;##' (
}$$ 
private&& 
static&&	 
Action&& 
<&& 
ILogger&& 
,&& 
string&&  &
,&&& '
	Exception&&( 1
?&&1 2
>&&2 3.
"_noMatchingBackchannelLoginRequest&&4 V
=&&W X
LoggerMessage&&Y f
.&&f g
Define&&g m
<&&m n
string&&n t
>&&t u
(&&u v
LogLevel'' 

.''
 
Error'' 
,'' 
EventIds(( 

.((
 -
!NoMatchingBackchannelLoginRequest(( ,
,((, -
$str)) 2
)))2 3
;))3 4
public++ 
static++ 
void++ -
!NoMatchingBackchannelLoginRequest++ 5
(++5 6
this++6 :
ILogger++; B
logger++C I
,++I J
string++K Q
id++R T
)++T U
{,, .
"_noMatchingBackchannelLoginRequest-- $
(--$ %
logger--% +
,--+ ,
id--- /
,--/ 0
null--1 5
)--5 6
;--6 7
}.. 
private00 
static00	 
Action00 
<00 
ILogger00 
,00 
string00  &
,00& '
	Exception00( 1
?001 2
>002 3%
_noConsentMatchingRequest004 M
=00N O
LoggerMessage00P ]
.00] ^
Define00^ d
<00d e
string00e k
>00k l
(00l m
LogLevel11 

.11
 
Error11 
,11 
EventIds22 

.22
 $
NoConsentMatchingRequest22 #
,22# $
$str33 4
)334 5
;335 6
public55 
static55 
void55 $
NoConsentMatchingRequest55 ,
(55, -
this55- 1
ILogger552 9
logger55: @
,55@ A
string55B H
	returnUrl55I R
)55R S
{66 %
_noConsentMatchingRequest77 
(77 
logger77 "
,77" #
	returnUrl77$ -
,77- .
null77/ 3
)773 4
;774 5
}88 
};; 
internal== 
static==	 
class== 
EventIds== 
{>> 
private?? 
const??	 
int?? 
UIEventsStart??  
=??! "
$num??# (
;??( )
privateDD 
constDD 
intDD 
ConsentEventsStartDD (
=DD) *
UIEventsStartDD+ 8
+DD9 :
$numDD; ?
;DD? @
publicEE 

constEE 
intEE 
	InvalidIdEE 
=EE  
ConsentEventsStartEE! 3
+EE4 5
$numEE6 7
;EE7 8
publicFF 
constFF 
intFF $
NoConsentMatchingRequestFF *
=FF+ ,
ConsentEventsStartFF- ?
+FF@ A
$numFFB C
;FFC D
privateKK 
constKK	 
intKK $
ExternalLoginEventsStartKK +
=KK, -
UIEventsStartKK. ;
+KK< =
$numKK> B
;KKB C
publicLL 

constLL 
intLL 
ExternalClaimsLL #
=LL$ %$
ExternalLoginEventsStartLL& >
+LL? @
$numLLA B
;LLB C
privateQQ 
constQQ	 
intQQ 
CibaEventsStartQQ "
=QQ# $
UIEventsStartQQ% 2
+QQ3 4
$numQQ5 9
;QQ9 :
publicRR 
constRR 
intRR %
InvalidBackchannelLoginIdRR +
=RR, -
CibaEventsStartRR. =
+RR> ?
$numRR@ A
;RRA B
publicSS 

constSS 
intSS -
!NoMatchingBackchannelLoginRequestSS 6
=SS7 8
CibaEventsStartSS9 H
+SSI J
$numSSK L
;SSL M
}WW ◊
fC:\netMentoring\04_layered_architectures\CartServiceConsoleApp\IdentityServerApi\Pages\Index.cshtml.cs
	namespace		 	
IdentityServerApi		
 
.		 
Pages		 !
.		! "
Home		" &
;		& '
[ 
AllowAnonymous 
] 
public 
class 
Index 
: 
	PageModel 
{ 
public 

Index 
( !
IdentityServerLicense &
?& '
license( /
=0 1
null2 6
)6 7
{ 
License 
= 
license 
; 
} 
public 

string 
Version 
{ 
get 
=> 
typeof 
( 
Duende 
. 
IdentityServer +
.+ ,
Hosting, 3
.3 4$
IdentityServerMiddleware4 L
)L M
.M N
AssemblyN V
. 
GetCustomAttribute 
<  1
%AssemblyInformationalVersionAttribute  E
>E F
(F G
)G H
? 
.  
InformationalVersion "
." #
Split# (
(( )
$char) ,
), -
.- .
First. 3
(3 4
)4 5
?? 
$str 
; 
} 
public 
!
IdentityServerLicense  
?  !
License" )
{* +
get, /
;/ 0
}1 2
} ˜
tC:\netMentoring\04_layered_architectures\CartServiceConsoleApp\IdentityServerApi\Pages\IdentityServerSuppressions.cs
[ 
assembly 	
:	 

SuppressMessage 
( 
$str #
,# $
$str% W
,W X
JustificationY f
=g h
$str	i í
)
í ì
]
ì î
[ 
assembly 	
:	 

SuppressMessage 
( 
$str #
,# $
$str% W
,W X
JustificationY f
=g h
$str	i í
)
í ì
]
ì î
[ 
assembly 	
:	 

SuppressMessage 
( 
$str (
,( )
$str* f
,f g
Justificationh u
=v w
$str	x ›
)
› ﬁ
]
ﬁ ﬂ
[ 
assembly 	
:	 

SuppressMessage 
( 
$str #
,# $
$str% I
,I J
JustificationK X
=Y Z
$str	[ Ü
,
Ü á
Scope
à ç
=
é è
$str
ê ò
,
ò ô
Target
ö †
=
° ¢
$str
£ …
)
…  
]
  À
[ 
assembly 	
:	 

SuppressMessage 
( 
$str #
,# $
$str% P
,P Q
JustificationR _
=` a
$str	b à
,
à â
Scope
ä è
=
ê ë
$str
í ò
,
ò ô
Target
ö †
=
° ¢
$str
£ ‡
)
‡ ·
]
· ‚
[ 
assembly 	
:	 

SuppressMessage 
( 
$str #
,# $
$str% S
,S T
JustificationU b
=c d
$str	e ±
,
± ≤
Scope
≥ ∏
=
π ∫
$str
ª ∆
,
∆ «
Target
» Œ
=
œ –
$str
— Û
)
Û Ù
]
Ù ı
[ 
assembly 	
:	 

SuppressMessage 
( 
$str #
,# $
$str% T
,T U
JustificationV c
=d e
$str	f «
,
« »
Scope
… Œ
=
œ –
$str
— ◊
,
◊ ÿ
Target
Ÿ ﬂ
=
‡ ·
$str
‚ ã
)
ã å
]
å ç
[ 
assembly 	
:	 

SuppressMessage 
( 
$str #
,# $
$str% T
,T U
JustificationV c
=d e
$str	f «
,
« »
Scope
… Œ
=
œ –
$str
— ◊
,
◊ ÿ
Target
Ÿ ﬂ
=
‡ ·
$str
‚ â
)
â ä
]
ä ã
[ 
assembly 	
:	 

SuppressMessage 
( 
$str (
,( )
$str* R
,R S
JustificationT a
=b c
$str	d £
,
£ §
Scope
• ™
=
´ ¨
$str
≠ µ
,
µ ∂
Target
∑ Ω
=
æ ø
$str
¿ è
)
è ê
]
ê ëü
nC:\netMentoring\04_layered_architectures\CartServiceConsoleApp\IdentityServerApi\Pages\Home\Error\ViewModel.cs
	namespace 	
IdentityServerApi
 
. 
Pages !
.! "
Error" '
;' (
public 
class 
	ViewModel 
{		 
public

 

	ViewModel

 
(

 
)

 
{ 
} 
public 

	ViewModel 
( 
string 
error !
)! "
{ 
Error 
= 
new 
ErrorMessage  
{! "
Error# (
=) *
error+ 0
}1 2
;2 3
} 
public 

ErrorMessage 
? 
Error 
{  
get! $
;$ %
set& )
;) *
}+ ,
} á
qC:\netMentoring\04_layered_architectures\CartServiceConsoleApp\IdentityServerApi\Pages\Home\Error\Index.cshtml.cs
	namespace 	
IdentityServerApi
 
. 
Pages !
.! "
Error" '
;' (
[

 
AllowAnonymous

 
]

 
[ 
SecurityHeaders 
] 
public 
class 
Index 
: 
	PageModel 
{ 
private 
readonly -
!IIdentityServerInteractionService 6
_interaction7 C
;C D
private 
readonly 
IWebHostEnvironment (
_environment) 5
;5 6
public 

	ViewModel 
View 
{ 
get 
;  
set! $
;$ %
}& '
=( )
new* -
(- .
). /
;/ 0
public 

Index 
( -
!IIdentityServerInteractionService 2
interaction3 >
,> ?
IWebHostEnvironment@ S
environmentT _
)_ `
{ 
_interaction 
= 
interaction "
;" #
_environment 
= 
environment "
;" #
} 
public 

async 
Task 
OnGet 
( 
string "
?" #
errorId$ +
)+ ,
{ 
var 
message 
= 
await 
_interaction (
.( ) 
GetErrorContextAsync) =
(= >
errorId> E
)E F
;F G
if 

( 
message 
!= 
null 
) 
{ 	
View 
. 
Error 
= 
message  
;  !
if!! 
(!! 
!!! 
_environment!! 
.!! 
IsDevelopment!! +
(!!+ ,
)!!, -
)!!- .
{"" 
message$$ 
.$$ 
ErrorDescription$$ (
=$$) *
null$$+ /
;$$/ 0
}%% 
}&& 	
}'' 
}(( ﬁ
jC:\netMentoring\04_layered_architectures\CartServiceConsoleApp\IdentityServerApi\Pages\Grants\ViewModel.cs
	namespace 	
IdentityServerApi
 
. 
Pages !
.! "
Grants" (
;( )
public 
class 
	ViewModel 
{ 
public 

IEnumerable 
< 
GrantViewModel %
>% &
Grants' -
{. /
get0 3
;3 4
set5 8
;8 9
}: ;
=< =

Enumerable> H
.H I
EmptyI N
<N O
GrantViewModelO ]
>] ^
(^ _
)_ `
;` a
}		 
public 
class 
GrantViewModel 
{ 
public 

string 
? 
ClientId 
{ 
get !
;! "
set# &
;& '
}( )
public 

string 
? 

ClientName 
{ 
get  #
;# $
set% (
;( )
}* +
public 

string 
? 
	ClientUrl 
{ 
get "
;" #
set$ '
;' (
}) *
public 

string 
? 
ClientLogoUrl  
{! "
get# &
;& '
set( +
;+ ,
}- .
public 

string 
? 
Description 
{  
get! $
;$ %
set& )
;) *
}+ ,
public 

DateTime 
Created 
{ 
get !
;! "
set# &
;& '
}( )
public 

DateTime 
? 
Expires 
{ 
get "
;" #
set$ '
;' (
}) *
public 

IEnumerable 
< 
string 
> 
IdentityGrantNames 1
{2 3
get4 7
;7 8
set9 <
;< =
}> ?
=@ A

EnumerableB L
.L M
EmptyM R
<R S
stringS Y
>Y Z
(Z [
)[ \
;\ ]
public 

IEnumerable 
< 
string 
> 
ApiGrantNames ,
{- .
get/ 2
;2 3
set4 7
;7 8
}9 :
=; <

Enumerable= G
.G H
EmptyH M
<M N
stringN T
>T U
(U V
)V W
;W X
} ˇ1
mC:\netMentoring\04_layered_architectures\CartServiceConsoleApp\IdentityServerApi\Pages\Grants\Index.cshtml.cs
	namespace 	
IdentityServerApi
 
. 
Pages !
.! "
Grants" (
;( )
[ 
SecurityHeaders 
] 
[ 
	Authorize 

]
 
public 
class 
Index 
: 
	PageModel 
{ 
private 
readonly -
!IIdentityServerInteractionService 6
_interaction7 C
;C D
private 
readonly 
IClientStore !
_clients" *
;* +
private 
readonly 
IResourceStore #

_resources$ .
;. /
private 
readonly 
IEventService "
_events# *
;* +
public 

Index 
( -
!IIdentityServerInteractionService 2
interaction3 >
,> ?
IClientStore 
clients 
, 
IResourceStore 
	resources  
,  !
IEventService 
events 
) 
{ 
_interaction 
= 
interaction "
;" #
_clients 
= 
clients 
; 

_resources 
= 
	resources 
; 
_events 
= 
events 
; 
}   
public"" 

	ViewModel"" 
View"" 
{"" 
get"" 
;""  
set""! $
;""$ %
}""& '
=""( )
default""* 1
!""1 2
;""2 3
public$$ 

async$$ 
Task$$ 
OnGet$$ 
($$ 
)$$ 
{%% 
var&& 
grants&& 
=&& 
await&& 
_interaction&& '
.&&' (!
GetAllUserGrantsAsync&&( =
(&&= >
)&&> ?
;&&? @
var(( 
list(( 
=(( 
new(( 
List(( 
<(( 
GrantViewModel(( *
>((* +
(((+ ,
)((, -
;((- .
foreach)) 
()) 
var)) 
grant)) 
in)) 
grants)) $
)))$ %
{** 	
var++ 
client++ 
=++ 
await++ 
_clients++ '
.++' (
FindClientByIdAsync++( ;
(++; <
grant++< A
.++A B
ClientId++B J
)++J K
;++K L
if,, 
(,, 
client,, 
!=,, 
null,, 
),, 
{-- 
var.. 
	resources.. 
=.. 
await..  %

_resources..& 0
...0 1%
FindResourcesByScopeAsync..1 J
(..J K
grant..K P
...P Q
Scopes..Q W
)..W X
;..X Y
var00 
item00 
=00 
new00 
GrantViewModel00 -
(00- .
)00. /
{11 
ClientId22 
=22 
client22 %
.22% &
ClientId22& .
,22. /

ClientName33 
=33  
client33! '
.33' (

ClientName33( 2
??333 5
client336 <
.33< =
ClientId33= E
,33E F
ClientLogoUrl44 !
=44" #
client44$ *
.44* +
LogoUri44+ 2
,442 3
	ClientUrl55 
=55 
client55  &
.55& '
	ClientUri55' 0
,550 1
Description66 
=66  !
grant66" '
.66' (
Description66( 3
,663 4
Created77 
=77 
grant77 #
.77# $
CreationTime77$ 0
,770 1
Expires88 
=88 
grant88 #
.88# $

Expiration88$ .
,88. /
IdentityGrantNames99 &
=99' (
	resources99) 2
.992 3
IdentityResources993 D
.99D E
Select99E K
(99K L
x99L M
=>99N P
x99Q R
.99R S
DisplayName99S ^
??99_ a
x99b c
.99c d
Name99d h
)99h i
.99i j
ToArray99j q
(99q r
)99r s
,99s t
ApiGrantNames:: !
=::" #
	resources::$ -
.::- .
	ApiScopes::. 7
.::7 8
Select::8 >
(::> ?
x::? @
=>::A C
x::D E
.::E F
DisplayName::F Q
??::R T
x::U V
.::V W
Name::W [
)::[ \
.::\ ]
ToArray::] d
(::d e
)::e f
};; 
;;; 
list== 
.== 
Add== 
(== 
item== 
)== 
;== 
}>> 
}?? 	
ViewAA 
=AA 
newAA 
	ViewModelAA 
{BB 	
GrantsCC 
=CC 
listCC 
}DD 	
;DD	 

}EE 
[GG 
BindPropertyGG 
]GG 
publicHH 

stringHH 
?HH 
ClientIdHH 
{HH 
getHH !
;HH! "
setHH# &
;HH& '
}HH( )
publicJJ 

asyncJJ 
TaskJJ 
<JJ 
IActionResultJJ #
>JJ# $
OnPostJJ% +
(JJ+ ,
)JJ, -
{KK 
awaitLL 
_interactionLL 
.LL "
RevokeUserConsentAsyncLL 1
(LL1 2
ClientIdLL2 :
)LL: ;
;LL; <
awaitMM 
_eventsMM 
.MM 

RaiseAsyncMM  
(MM  !
newMM! $
GrantsRevokedEventMM% 7
(MM7 8
UserMM8 <
.MM< =
GetSubjectIdMM= I
(MMI J
)MMJ K
,MMK L
ClientIdMMM U
)MMU V
)MMV W
;MMW X
	TelemetryNN 
.NN 
MetricsNN 
.NN 
GrantsRevokedNN '
(NN' (
ClientIdNN( 0
)NN0 1
;NN1 2
returnPP 
RedirectToPagePP 
(PP 
$strPP -
)PP- .
;PP. /
}QQ 
}RR ≈
xC:\netMentoring\04_layered_architectures\CartServiceConsoleApp\IdentityServerApi\Pages\ExternalLogin\Challenge.cshtml.cs
	namespace

 	
IdentityServerApi


 
.

 
Pages

 !
.

! "
ExternalLogin

" /
;

/ 0
[ 
AllowAnonymous 
] 
[ 
SecurityHeaders 
] 
public 
class 
	Challenge 
: 
	PageModel "
{ 
private 
readonly -
!IIdentityServerInteractionService 6
_interactionService7 J
;J K
public 

	Challenge 
( -
!IIdentityServerInteractionService 6
interactionService7 I
)I J
{ 
_interactionService 
= 
interactionService 0
;0 1
} 
public 

IActionResult 
OnGet 
( 
string %
scheme& ,
,, -
string. 4
?4 5
	returnUrl6 ?
)? @
{ 
if 

( 
string 
. 
IsNullOrEmpty  
(  !
	returnUrl! *
)* +
)+ ,
	returnUrl- 6
=7 8
$str9 =
;= >
if 

( 
Url 
. 

IsLocalUrl 
( 
	returnUrl $
)$ %
==& (
false) .
&&/ 1
_interactionService2 E
.E F
IsValidReturnUrlF V
(V W
	returnUrlW `
)` a
==b d
falsee j
)j k
{ 	
throw 
new 
ArgumentException '
(' (
$str( <
)< =
;= >
}   	
var## 
props## 
=## 
new## $
AuthenticationProperties## 0
{$$ 	
RedirectUri%% 
=%% 
Url%% 
.%% 
Page%% "
(%%" #
$str%%# <
)%%< =
,%%= >
Items'' 
='' 
{(( 
{)) 
$str)) 
,)) 
	returnUrl)) (
}))) *
,))* +
{** 
$str** 
,** 
scheme** "
}**# $
,**$ %
}++ 
},, 	
;,,	 

return.. 
	Challenge.. 
(.. 
props.. 
,.. 
scheme..  &
)..& '
;..' (
}// 
}00 Ò§
wC:\netMentoring\04_layered_architectures\CartServiceConsoleApp\IdentityServerApi\Pages\ExternalLogin\Callback.cshtml.cs
	namespace 	
IdentityServerApi
 
. 
Pages !
.! "
ExternalLogin" /
;/ 0
[ 
AllowAnonymous 
] 
[ 
SecurityHeaders 
] 
public 
class 
Callback 
: 
	PageModel !
{ 
private 
readonly 
UserManager  
<  !
ApplicationUser! 0
>0 1
_userManager2 >
;> ?
private 
readonly 
SignInManager "
<" #
ApplicationUser# 2
>2 3
_signInManager4 B
;B C
private 
readonly -
!IIdentityServerInteractionService 6
_interaction7 C
;C D
private 
readonly 
ILogger 
< 
Callback %
>% &
_logger' .
;. /
private 
readonly 
IEventService "
_events# *
;* +
public 

Callback 
( -
!IIdentityServerInteractionService )
interaction* 5
,5 6
IEventService 
events 
, 
ILogger 
< 
Callback 
> 
logger  
,  !
UserManager   
<   
ApplicationUser   #
>  # $
userManager  % 0
,  0 1
SignInManager!! 
<!! 
ApplicationUser!! %
>!!% &
signInManager!!' 4
)!!4 5
{"" 
_userManager## 
=## 
userManager## "
;##" #
_signInManager$$ 
=$$ 
signInManager$$ &
;$$& '
_interaction%% 
=%% 
interaction%% "
;%%" #
_logger&& 
=&& 
logger&& 
;&& 
_events'' 
='' 
events'' 
;'' 
}(( 
public** 

async** 
Task** 
<** 
IActionResult** #
>**# $
OnGet**% *
(*** +
)**+ ,
{++ 
var-- 
result-- 
=-- 
await-- 
HttpContext-- &
.--& '
AuthenticateAsync--' 8
(--8 9#
IdentityServerConstants--9 P
.--P Q.
"ExternalCookieAuthenticationScheme--Q s
)--s t
;--t u
if.. 

(.. 
result.. 
... 
	Succeeded.. 
!=.. 
true..  $
)..$ %
{// 	
throw00 
new00 %
InvalidOperationException00 /
(00/ 0
$"000 2
$str002 Q
{00Q R
result00S Y
.00Y Z
Failure00Z a
}00b c
"00c d
)00d e
;00e f
}11 	
var33 
externalUser33 
=33 
result33 !
.33! "
	Principal33" +
??33, .
throw44 
new44 %
InvalidOperationException44 /
(44/ 0
$str440 c
)44c d
;44d e
if66 

(66 
_logger66 
.66 
	IsEnabled66 
(66 
LogLevel66 &
.66& '
Debug66' ,
)66, -
)66- .
{77 	
var88 
externalClaims88 
=88  
externalUser88! -
.88- .
Claims88. 4
.884 5
Select885 ;
(88; <
c88< =
=>88> @
$"88A C
{88C D
c88D E
.88E F
Type88F J
}88J K
$str88K M
{88M N
c88N O
.88O P
Value88P U
}88U V
"88V W
)88W X
;88X Y
_logger99 
.99 
ExternalClaims99 "
(99" #
externalClaims99# 1
)991 2
;992 3
}:: 	
var@@ 
userIdClaim@@ 
=@@ 
externalUser@@ &
.@@& '
	FindFirst@@' 0
(@@0 1
JwtClaimTypes@@1 >
.@@> ?
Subject@@? F
)@@F G
??@@H J
externalUserAA &
.AA& '
	FindFirstAA' 0
(AA0 1

ClaimTypesAA1 ;
.AA; <
NameIdentifierAA< J
)AAJ K
??AAL N
throwBB 
newBB  #%
InvalidOperationExceptionBB$ =
(BB= >
$strBB> N
)BBN O
;BBO P
varDD 
providerDD 
=DD 
resultDD 
.DD 

PropertiesDD (
.DD( )
ItemsDD) .
[DD. /
$strDD/ 7
]DD7 8
??DD9 ;
throwDD< A
newDDB E%
InvalidOperationExceptionDDF _
(DD_ `
$str	DD` â
)
DDâ ä
;
DDä ã
varEE 
providerUserIdEE 
=EE 
userIdClaimEE (
.EE( )
ValueEE) .
;EE. /
varHH 
userHH 
=HH 
awaitHH 
_userManagerHH %
.HH% &
FindByLoginAsyncHH& 6
(HH6 7
providerHH7 ?
,HH? @
providerUserIdHHA O
)HHO P
;HHP Q
ifII 

(II 
userII 
==II 
nullII 
)II 
{JJ 	
userNN 
=NN 
awaitNN "
AutoProvisionUserAsyncNN /
(NN/ 0
providerNN0 8
,NN8 9
providerUserIdNN: H
,NNH I
externalUserNNJ V
.NNV W
ClaimsNNW ]
)NN] ^
;NN^ _
}OO 	
varTT !
additionalLocalClaimsTT !
=TT" #
newTT$ '
ListTT( ,
<TT, -
ClaimTT- 2
>TT2 3
(TT3 4
)TT4 5
;TT5 6
varUU 
localSignInPropsUU 
=UU 
newUU "$
AuthenticationPropertiesUU# ;
(UU; <
)UU< =
;UU= >'
CaptureExternalLoginContextVV #
(VV# $
resultVV$ *
,VV* +!
additionalLocalClaimsVV, A
,VVA B
localSignInPropsVVC S
)VVS T
;VVT U
awaitYY 
_signInManagerYY 
.YY !
SignInWithClaimsAsyncYY 2
(YY2 3
userYY3 7
,YY7 8
localSignInPropsYY9 I
,YYI J!
additionalLocalClaimsYYK `
)YY` a
;YYa b
await\\ 
HttpContext\\ 
.\\ 
SignOutAsync\\ &
(\\& '#
IdentityServerConstants\\' >
.\\> ?.
"ExternalCookieAuthenticationScheme\\? a
)\\a b
;\\b c
var__ 
	returnUrl__ 
=__ 
result__ 
.__ 

Properties__ )
.__) *
Items__* /
[__/ 0
$str__0 ;
]__; <
??__= ?
$str__@ D
;__D E
varbb 
contextbb 
=bb 
awaitbb 
_interactionbb (
.bb( )(
GetAuthorizationContextAsyncbb) E
(bbE F
	returnUrlbbF O
)bbO P
;bbP Q
awaitcc 
_eventscc 
.cc 

RaiseAsynccc  
(cc  !
newcc! $!
UserLoginSuccessEventcc% :
(cc: ;
providercc; C
,ccC D
providerUserIdccE S
,ccS T
userccU Y
.ccY Z
IdccZ \
,cc\ ]
usercc^ b
.ccb c
UserNameccc k
,cck l
trueccm q
,ccq r
contextccs z
?ccz {
.cc{ |
Client	cc| Ç
.
ccÇ É
ClientId
ccÉ ã
)
ccã å
)
ccå ç
;
ccç é
	Telemetrydd 
.dd 
Metricsdd 
.dd 
	UserLogindd #
(dd# $
contextdd$ +
?dd+ ,
.dd, -
Clientdd- 3
.dd3 4
ClientIddd4 <
,dd< =
providerdd> F
!ddF G
)ddG H
;ddH I
ifff 

(ff 
contextff 
!=ff 
nullff 
)ff 
{gg 	
ifhh 
(hh 
contexthh 
.hh 
IsNativeClienthh &
(hh& '
)hh' (
)hh( )
{ii 
returnll 
thisll 
.ll 
LoadingPagell '
(ll' (
	returnUrlll( 1
)ll1 2
;ll2 3
}mm 
}nn 	
returnpp 
Redirectpp 
(pp 
	returnUrlpp !
)pp! "
;pp" #
}qq 
[ss 
Systemss 
.ss 
Diagnosticsss 
.ss 
CodeAnalysisss $
.ss$ %
SuppressMessagess% 4
(ss4 5
$strss5 B
,ssB C
$str	ssD á
,
ssá à
Justification
ssâ ñ
=
ssó ò
$str
ssô §
)
ss§ •
]
ss• ¶
privatett 
asynctt 
Tasktt 
<tt 
ApplicationUsertt &
>tt& '"
AutoProvisionUserAsynctt( >
(tt> ?
stringtt? E
providerttF N
,ttN O
stringttP V
providerUserIdttW e
,tte f
IEnumerablettg r
<ttr s
Claimtts x
>ttx y
claims	ttz Ä
)
ttÄ Å
{uu 
varvv 
subvv 
=vv 
Guidvv 
.vv 
NewGuidvv 
(vv 
)vv  
.vv  !
ToStringvv! )
(vv) *
)vv* +
;vv+ ,
varxx 
userxx 
=xx 
newxx 
ApplicationUserxx &
{yy 	
Idzz 
=zz 
subzz 
,zz 
UserName{{ 
={{ 
sub{{ 
,{{ 
}|| 	
;||	 

var 
email 
= 
claims 
. 
FirstOrDefault )
() *
x* +
=>, .
x/ 0
.0 1
Type1 5
==6 8
JwtClaimTypes9 F
.F G
EmailG L
)L M
?M N
.N O
ValueO T
??U W
claims
ÄÄ 
.
ÄÄ 
FirstOrDefault
ÄÄ )
(
ÄÄ) *
x
ÄÄ* +
=>
ÄÄ, .
x
ÄÄ/ 0
.
ÄÄ0 1
Type
ÄÄ1 5
==
ÄÄ6 8

ClaimTypes
ÄÄ9 C
.
ÄÄC D
Email
ÄÄD I
)
ÄÄI J
?
ÄÄJ K
.
ÄÄK L
Value
ÄÄL Q
;
ÄÄQ R
if
ÅÅ 

(
ÅÅ 
email
ÅÅ 
!=
ÅÅ 
null
ÅÅ 
)
ÅÅ 
{
ÇÇ 	
user
ÉÉ 
.
ÉÉ 
Email
ÉÉ 
=
ÉÉ 
email
ÉÉ 
;
ÉÉ 
}
ÑÑ 	
var
áá 
filtered
áá 
=
áá 
new
áá 
List
áá 
<
áá  
Claim
áá  %
>
áá% &
(
áá& '
)
áá' (
;
áá( )
var
ää 
name
ää 
=
ää 
claims
ää 
.
ää 
FirstOrDefault
ää (
(
ää( )
x
ää) *
=>
ää+ -
x
ää. /
.
ää/ 0
Type
ää0 4
==
ää5 7
JwtClaimTypes
ää8 E
.
ääE F
Name
ääF J
)
ääJ K
?
ääK L
.
ääL M
Value
ääM R
??
ääS U
claims
ãã 
.
ãã 
FirstOrDefault
ãã (
(
ãã( )
x
ãã) *
=>
ãã+ -
x
ãã. /
.
ãã/ 0
Type
ãã0 4
==
ãã5 7

ClaimTypes
ãã8 B
.
ããB C
Name
ããC G
)
ããG H
?
ããH I
.
ããI J
Value
ããJ O
;
ããO P
if
åå 

(
åå 
name
åå 
!=
åå 
null
åå 
)
åå 
{
çç 	
filtered
éé 
.
éé 
Add
éé 
(
éé 
new
éé 
Claim
éé "
(
éé" #
JwtClaimTypes
éé# 0
.
éé0 1
Name
éé1 5
,
éé5 6
name
éé7 ;
)
éé; <
)
éé< =
;
éé= >
}
èè 	
else
êê 
{
ëë 	
var
íí 
first
íí 
=
íí 
claims
íí 
.
íí 
FirstOrDefault
íí -
(
íí- .
x
íí. /
=>
íí0 2
x
íí3 4
.
íí4 5
Type
íí5 9
==
íí: <
JwtClaimTypes
íí= J
.
ííJ K
	GivenName
ííK T
)
ííT U
?
ííU V
.
ííV W
Value
ííW \
??
íí] _
claims
ìì 
.
ìì 
FirstOrDefault
ìì -
(
ìì- .
x
ìì. /
=>
ìì0 2
x
ìì3 4
.
ìì4 5
Type
ìì5 9
==
ìì: <

ClaimTypes
ìì= G
.
ììG H
	GivenName
ììH Q
)
ììQ R
?
ììR S
.
ììS T
Value
ììT Y
;
ììY Z
var
îî 
last
îî 
=
îî 
claims
îî 
.
îî 
FirstOrDefault
îî ,
(
îî, -
x
îî- .
=>
îî/ 1
x
îî2 3
.
îî3 4
Type
îî4 8
==
îî9 ;
JwtClaimTypes
îî< I
.
îîI J

FamilyName
îîJ T
)
îîT U
?
îîU V
.
îîV W
Value
îîW \
??
îî] _
claims
ïï 
.
ïï 
FirstOrDefault
ïï ,
(
ïï, -
x
ïï- .
=>
ïï/ 1
x
ïï2 3
.
ïï3 4
Type
ïï4 8
==
ïï9 ;

ClaimTypes
ïï< F
.
ïïF G
Surname
ïïG N
)
ïïN O
?
ïïO P
.
ïïP Q
Value
ïïQ V
;
ïïV W
if
ññ 
(
ññ 
first
ññ 
!=
ññ 
null
ññ 
&&
ññ  
last
ññ! %
!=
ññ& (
null
ññ) -
)
ññ- .
{
óó 
filtered
òò 
.
òò 
Add
òò 
(
òò 
new
òò  
Claim
òò! &
(
òò& '
JwtClaimTypes
òò' 4
.
òò4 5
Name
òò5 9
,
òò9 :
first
òò; @
+
òòA B
$str
òòC F
+
òòG H
last
òòI M
)
òòM N
)
òòN O
;
òòO P
}
ôô 
else
öö 
if
öö 
(
öö 
first
öö 
!=
öö 
null
öö "
)
öö" #
{
õõ 
filtered
úú 
.
úú 
Add
úú 
(
úú 
new
úú  
Claim
úú! &
(
úú& '
JwtClaimTypes
úú' 4
.
úú4 5
Name
úú5 9
,
úú9 :
first
úú; @
)
úú@ A
)
úúA B
;
úúB C
}
ùù 
else
ûû 
if
ûû 
(
ûû 
last
ûû 
!=
ûû 
null
ûû !
)
ûû! "
{
üü 
filtered
†† 
.
†† 
Add
†† 
(
†† 
new
††  
Claim
††! &
(
††& '
JwtClaimTypes
††' 4
.
††4 5
Name
††5 9
,
††9 :
last
††; ?
)
††? @
)
††@ A
;
††A B
}
°° 
}
¢¢ 	
var
§§ 
identityResult
§§ 
=
§§ 
await
§§ "
_userManager
§§# /
.
§§/ 0
CreateAsync
§§0 ;
(
§§; <
user
§§< @
)
§§@ A
;
§§A B
if
•• 

(
•• 
!
•• 
identityResult
•• 
.
•• 
	Succeeded
•• %
)
••% &
throw
••' ,
new
••- 0'
InvalidOperationException
••1 J
(
••J K
identityResult
••K Y
.
••Y Z
Errors
••Z `
.
••` a
First
••a f
(
••f g
)
••g h
.
••h i
Description
••i t
)
••t u
;
••u v
if
ßß 

(
ßß 
filtered
ßß 
.
ßß 
Count
ßß 
!=
ßß 
$num
ßß 
)
ßß  
{
®® 	
identityResult
©© 
=
©© 
await
©© "
_userManager
©©# /
.
©©/ 0
AddClaimsAsync
©©0 >
(
©©> ?
user
©©? C
,
©©C D
filtered
©©E M
)
©©M N
;
©©N O
if
™™ 
(
™™ 
!
™™ 
identityResult
™™ 
.
™™  
	Succeeded
™™  )
)
™™) *
throw
™™+ 0
new
™™1 4'
InvalidOperationException
™™5 N
(
™™N O
identityResult
™™O ]
.
™™] ^
Errors
™™^ d
.
™™d e
First
™™e j
(
™™j k
)
™™k l
.
™™l m
Description
™™m x
)
™™x y
;
™™y z
}
´´ 	
identityResult
≠≠ 
=
≠≠ 
await
≠≠ 
_userManager
≠≠ +
.
≠≠+ ,
AddLoginAsync
≠≠, 9
(
≠≠9 :
user
≠≠: >
,
≠≠> ?
new
≠≠@ C
UserLoginInfo
≠≠D Q
(
≠≠Q R
provider
≠≠R Z
,
≠≠Z [
providerUserId
≠≠\ j
,
≠≠j k
provider
≠≠l t
)
≠≠t u
)
≠≠u v
;
≠≠v w
if
ÆÆ 

(
ÆÆ 
!
ÆÆ 
identityResult
ÆÆ 
.
ÆÆ 
	Succeeded
ÆÆ %
)
ÆÆ% &
throw
ÆÆ' ,
new
ÆÆ- 0'
InvalidOperationException
ÆÆ1 J
(
ÆÆJ K
identityResult
ÆÆK Y
.
ÆÆY Z
Errors
ÆÆZ `
.
ÆÆ` a
First
ÆÆa f
(
ÆÆf g
)
ÆÆg h
.
ÆÆh i
Description
ÆÆi t
)
ÆÆt u
;
ÆÆu v
return
∞∞ 
user
∞∞ 
;
∞∞ 
}
±± 
private
µµ 
static
µµ 
void
µµ )
CaptureExternalLoginContext
µµ 3
(
µµ3 4 
AuthenticateResult
µµ4 F
externalResult
µµG U
,
µµU V
List
µµW [
<
µµ[ \
Claim
µµ\ a
>
µµa b
localClaims
µµc n
,
µµn o'
AuthenticationPropertiesµµp à 
localSignInPropsµµâ ô
)µµô ö
{
∂∂ #
ArgumentNullException
∑∑ 
.
∑∑ 
ThrowIfNull
∑∑ )
(
∑∑) *
externalResult
∑∑* 8
.
∑∑8 9
	Principal
∑∑9 B
,
∑∑B C
nameof
∑∑D J
(
∑∑J K
externalResult
∑∑K Y
.
∑∑Y Z
	Principal
∑∑Z c
)
∑∑c d
)
∑∑d e
;
∑∑e f
localClaims
∫∫ 
.
∫∫ 
Add
∫∫ 
(
∫∫ 
new
∫∫ 
Claim
∫∫ !
(
∫∫! "
JwtClaimTypes
∫∫" /
.
∫∫/ 0
IdentityProvider
∫∫0 @
,
∫∫@ A
externalResult
∫∫B P
.
∫∫P Q

Properties
∫∫Q [
?
∫∫[ \
.
∫∫\ ]
Items
∫∫] b
[
∫∫b c
$str
∫∫c k
]
∫∫k l
??
∫∫m o
$str∫∫p ã
)∫∫ã å
)∫∫å ç
;∫∫ç é
var
ææ 
sid
ææ 
=
ææ 
externalResult
ææ  
.
ææ  !
	Principal
ææ! *
.
ææ* +
Claims
ææ+ 1
.
ææ1 2
FirstOrDefault
ææ2 @
(
ææ@ A
x
ææA B
=>
ææC E
x
ææF G
.
ææG H
Type
ææH L
==
ææM O
JwtClaimTypes
ææP ]
.
ææ] ^
	SessionId
ææ^ g
)
ææg h
;
ææh i
if
øø 

(
øø 
sid
øø 
!=
øø 
null
øø 
)
øø 
{
¿¿ 	
localClaims
¡¡ 
.
¡¡ 
Add
¡¡ 
(
¡¡ 
new
¡¡ 
Claim
¡¡  %
(
¡¡% &
JwtClaimTypes
¡¡& 3
.
¡¡3 4
	SessionId
¡¡4 =
,
¡¡= >
sid
¡¡? B
.
¡¡B C
Value
¡¡C H
)
¡¡H I
)
¡¡I J
;
¡¡J K
}
¬¬ 	
var
≈≈ 
idToken
≈≈ 
=
≈≈ 
externalResult
≈≈ $
.
≈≈$ %

Properties
≈≈% /
?
≈≈/ 0
.
≈≈0 1
GetTokenValue
≈≈1 >
(
≈≈> ?
$str
≈≈? I
)
≈≈I J
;
≈≈J K
if
∆∆ 

(
∆∆ 
idToken
∆∆ 
!=
∆∆ 
null
∆∆ 
)
∆∆ 
{
«« 	
localSignInProps
»» 
.
»» 
StoreTokens
»» (
(
»»( )
new
»») ,
[
»», -
]
»»- .
{
»»/ 0
new
»»1 4!
AuthenticationToken
»»5 H
{
»»I J
Name
»»K O
=
»»P Q
$str
»»R \
,
»»\ ]
Value
»»^ c
=
»»d e
idToken
»»f m
}
»»n o
}
»»p q
)
»»q r
;
»»r s
}
…… 	
}
   
}ÀÀ 
dC:\netMentoring\04_layered_architectures\CartServiceConsoleApp\IdentityServerApi\Pages\Extensions.cs
	namespace		 	
IdentityServerApi		
 
.		 
Pages		 !
;		! "
public 
static 
class 

Extensions 
{ 
internal 
static 
async 
Task 
< 
bool #
># $)
GetSchemeSupportsSignOutAsync% B
(B C
thisC G
HttpContextH S
contextT [
,[ \
string] c
schemed j
)j k
{ 
var 
provider 
= 
context 
. 
RequestServices .
.. /
GetRequiredService/ A
<A B*
IAuthenticationHandlerProviderB `
>` a
(a b
)b c
;c d
var 
handler 
= 
await 
provider $
.$ %
GetHandlerAsync% 4
(4 5
context5 <
,< =
scheme> D
)D E
;E F
return 
( 
handler 
is )
IAuthenticationSignOutHandler 8
)8 9
;9 :
} 
internal 
static 
bool 
IsNativeClient '
(' (
this( , 
AuthorizationRequest- A
contextB I
)I J
{ 
return 
! 
context 
. 
RedirectUri #
.# $

StartsWith$ .
(. /
$str/ 6
,6 7
StringComparison8 H
.H I
OrdinalI P
)P Q
&& 
! 
context 
. 
RedirectUri &
.& '

StartsWith' 1
(1 2
$str2 8
,8 9
StringComparison: J
.J K
OrdinalK R
)R S
;S T
} 
internal## 
static## 
IActionResult## !
LoadingPage##" -
(##- .
this##. 2
	PageModel##3 <
page##= A
,##A B
string##C I
?##I J
redirectUri##K V
)##V W
{$$ 
page%% 
.%% 
HttpContext%% 
.%% 
Response%% !
.%%! "

StatusCode%%" ,
=%%- .
$num%%/ 2
;%%2 3
page&& 
.&& 
HttpContext&& 
.&& 
Response&& !
.&&! "
Headers&&" )
[&&) *
$str&&* 4
]&&4 5
=&&6 7
$str&&8 :
;&&: ;
return(( 
page(( 
.(( 
RedirectToPage(( "
(((" #
$str((# 4
,((4 5
new((6 9
{((: ;
RedirectUri((< G
=((H I
redirectUri((J U
}((V W
)((W X
;((X Y
})) 
}** Ä
oC:\netMentoring\04_layered_architectures\CartServiceConsoleApp\IdentityServerApi\Pages\Diagnostics\ViewModel.cs
	namespace		 	
IdentityServerApi		
 
.		 
Pages		 !
.		! "
Diagnostics		" -
;		- .
public 
class 
	ViewModel 
{ 
public 

	ViewModel 
( 
AuthenticateResult '
result( .
). /
{ 
AuthenticateResult 
= 
result #
;# $
if 

( 
result 
? 
. 

Properties 
? 
.  
Items  %
.% &
TryGetValue& 1
(1 2
$str2 ?
,? @
outA D
varE H
encodedI P
)P Q
==R T
trueU Y
)Y Z
{ 	
if 
( 
encoded 
!= 
null 
)  
{ 
var 
bytes 
= 
	Base64Url %
.% &
Decode& ,
(, -
encoded- 4
)4 5
;5 6
var 
value 
= 
Encoding $
.$ %
UTF8% )
.) *
	GetString* 3
(3 4
bytes4 9
)9 :
;: ;
Clients 
= 
JsonSerializer (
.( )
Deserialize) 4
<4 5
string5 ;
[; <
]< =
>= >
(> ?
value? D
)D E
??F H

EnumerableI S
.S T
EmptyT Y
<Y Z
stringZ `
>` a
(a b
)b c
;c d
return 
; 
} 
} 	
Clients 
= 

Enumerable 
. 
Empty "
<" #
string# )
>) *
(* +
)+ ,
;, -
} 
public 

AuthenticateResult 
AuthenticateResult 0
{1 2
get3 6
;6 7
}8 9
public 

IEnumerable 
< 
string 
> 
Clients &
{' (
get) ,
;, -
}. /
}   É
rC:\netMentoring\04_layered_architectures\CartServiceConsoleApp\IdentityServerApi\Pages\Diagnostics\Index.cshtml.cs
	namespace		 	
IdentityServerApi		
 
.		 
Pages		 !
.		! "
Diagnostics		" -
;		- .
[ 
SecurityHeaders 
] 
[ 
	Authorize 

]
 
public 
class 
Index 
: 
	PageModel 
{ 
public 

	ViewModel 
View 
{ 
get 
;  
set! $
;$ %
}& '
=( )
default* 1
!1 2
;2 3
public 

async 
Task 
< 
IActionResult #
># $
OnGet% *
(* +
)+ ,
{ 
var 
localAddresses 
= 
new  
List! %
<% &
string& ,
?, -
>- .
{/ 0
$str1 <
,< =
$str> C
}D E
;E F
if 

(
 
HttpContext 
. 

Connection !
.! "
LocalIpAddress" 0
!=1 3
null4 8
)8 9
{ 	
localAddresses 
. 
Add 
( 
HttpContext *
.* +

Connection+ 5
.5 6
LocalIpAddress6 D
.D E
ToStringE M
(M N
)N O
)O P
;P Q
} 	
if 

( 
! 
localAddresses 
. 
Contains $
($ %
HttpContext% 0
.0 1

Connection1 ;
.; <
RemoteIpAddress< K
?K L
.L M
ToStringM U
(U V
)V W
)W X
)X Y
{ 	
return 
NotFound 
( 
) 
; 
} 	
View 
= 
new 
	ViewModel 
( 
await "
HttpContext# .
.. /
AuthenticateAsync/ @
(@ A
)A B
)B C
;C D
return   
Page   
(   
)   
;   
}!! 
}"" √
jC:\netMentoring\04_layered_architectures\CartServiceConsoleApp\IdentityServerApi\Pages\Device\ViewModel.cs
	namespace 	
IdentityServerApi
 
. 
Pages !
.! "
Device" (
;( )
public 
class 
	ViewModel 
{ 
public 

string 
? 

ClientName 
{ 
get  #
;# $
set% (
;( )
}* +
public		 

string		 
?		 
	ClientUrl		 
{		 
get		 "
;		" #
set		$ '
;		' (
}		) *
public

 

string

 
?

 
ClientLogoUrl

  
{

! "
get

# &
;

& '
set

( +
;

+ ,
}

- .
public 

bool  
AllowRememberConsent $
{% &
get' *
;* +
set, /
;/ 0
}1 2
public 

IEnumerable 
< 
ScopeViewModel %
>% &
IdentityScopes' 5
{6 7
get8 ;
;; <
set= @
;@ A
}B C
=D E

EnumerableF P
.P Q
EmptyQ V
<V W
ScopeViewModelW e
>e f
(f g
)g h
;h i
public 

IEnumerable 
< 
ScopeViewModel %
>% &
	ApiScopes' 0
{1 2
get3 6
;6 7
set8 ;
;; <
}= >
=? @

EnumerableA K
.K L
EmptyL Q
<Q R
ScopeViewModelR `
>` a
(a b
)b c
;c d
} 
public 
class 
ScopeViewModel 
{ 
public 

string 
? 
Value 
{ 
get 
; 
set  #
;# $
}% &
public 

string 
? 
DisplayName 
{  
get! $
;$ %
set& )
;) *
}+ ,
public 

string 
? 
Description 
{  
get! $
;$ %
set& )
;) *
}+ ,
public 

bool 
	Emphasize 
{ 
get 
;  
set! $
;$ %
}& '
public 

bool 
Required 
{ 
get 
; 
set  #
;# $
}% &
public 

bool 
Checked 
{ 
get 
; 
set "
;" #
}$ %
} Ÿ
oC:\netMentoring\04_layered_architectures\CartServiceConsoleApp\IdentityServerApi\Pages\Device\Success.cshtml.cs
	namespace 	
IdentityServerApi
 
. 
Pages !
.! "
Device" (
;( )
[		 
SecurityHeaders		 
]		 
[

 
	Authorize

 

]


 
public 
class 
SuccessModel 
: 
	PageModel %
{ 
public 

void 
OnGet 
( 
) 
{ 
} 
} ∂
kC:\netMentoring\04_layered_architectures\CartServiceConsoleApp\IdentityServerApi\Pages\Device\InputModel.cs
	namespace 	
IdentityServerApi
 
. 
Pages !
.! "
Device" (
;( )
public 
class 

InputModel 
{ 
public 

string 
? 
Button 
{ 
get 
;  
set! $
;$ %
}& '
public		 

IEnumerable		 
<		 
string		 
>		 
ScopesConsented		 .
{		/ 0
get		1 4
;		4 5
set		6 9
;		9 :
}		; <
=		= >
new		? B
List		C G
<		G H
string		H N
>		N O
(		O P
)		P Q
;		Q R
public

 

bool

 
RememberConsent

 
{

  !
get

" %
;

% &
set

' *
;

* +
}

, -
=

. /
true

0 4
;

4 5
public 

string 
? 
	ReturnUrl 
{ 
get "
;" #
set$ '
;' (
}) *
public 

string 
? 
Description 
{  
get! $
;$ %
set& )
;) *
}+ ,
public 

string 
? 
UserCode 
{ 
get !
;! "
set# &
;& '
}( )
} ±
kC:\netMentoring\04_layered_architectures\CartServiceConsoleApp\IdentityServerApi\Pages\Consent\ViewModel.cs
	namespace 	
IdentityServerApi
 
. 
Pages !
.! "
Consent" )
;) *
public 
class 
	ViewModel 
{ 
public 

string 
? 

ClientName 
{ 
get  #
;# $
set% (
;( )
}* +
public		 

string		 
?		 
	ClientUrl		 
{		 
get		 "
;		" #
set		$ '
;		' (
}		) *
public

 

string

 
?

 
ClientLogoUrl

  
{

! "
get

# &
;

& '
set

( +
;

+ ,
}

- .
public 

bool  
AllowRememberConsent $
{% &
get' *
;* +
set, /
;/ 0
}1 2
public 

IEnumerable 
< 
ScopeViewModel %
>% &
IdentityScopes' 5
{6 7
get8 ;
;; <
set= @
;@ A
}B C
=D E

EnumerableF P
.P Q
EmptyQ V
<V W
ScopeViewModelW e
>e f
(f g
)g h
;h i
public 

IEnumerable 
< 
ScopeViewModel %
>% &
	ApiScopes' 0
{1 2
get3 6
;6 7
set8 ;
;; <
}= >
=? @

EnumerableA K
.K L
EmptyL Q
<Q R
ScopeViewModelR `
>` a
(a b
)b c
;c d
} 
public 
class 
ScopeViewModel 
{ 
public 

string 
? 
Name 
{ 
get 
; 
set "
;" #
}$ %
public 

string 
? 
Value 
{ 
get 
; 
set  #
;# $
}% &
public 

string 
? 
DisplayName 
{  
get! $
;$ %
set& )
;) *
}+ ,
public 

string 
? 
Description 
{  
get! $
;$ %
set& )
;) *
}+ ,
public 

bool 
	Emphasize 
{ 
get 
;  
set! $
;$ %
}& '
public 

bool 
Required 
{ 
get 
; 
set  #
;# $
}% &
public 

bool 
Checked 
{ 
get 
; 
set "
;" #
}$ %
public 

IEnumerable 
< 
ResourceViewModel (
>( )
	Resources* 3
{4 5
get6 9
;9 :
set; >
;> ?
}@ A
=B C

EnumerableD N
.N O
EmptyO T
<T U
ResourceViewModelU f
>f g
(g h
)h i
;i j
} 
public 
class 
ResourceViewModel 
{ 
public 

string 
? 
Name 
{ 
get 
; 
set "
;" #
}$ %
public   

string   
?   
DisplayName   
{    
get  ! $
;  $ %
set  & )
;  ) *
}  + ,
}!! –ù
mC:\netMentoring\04_layered_architectures\CartServiceConsoleApp\IdentityServerApi\Pages\Device\Index.cshtml.cs
	namespace 	
IdentityServerApi
 
. 
Pages !
.! "
Device" (
;( )
[ 
SecurityHeaders 
] 
[ 
	Authorize 

]
 
public 
class 
Index 
: 
	PageModel 
{ 
private 
readonly )
IDeviceFlowInteractionService 2
_interaction3 ?
;? @
private 
readonly 
IEventService "
_events# *
;* +
public 

Index 
( )
IDeviceFlowInteractionService %
interaction& 1
,1 2
IEventService 
eventService "
," #
IOptions 
< !
IdentityServerOptions &
>& '
options( /
,/ 0
ILogger 
< 
Index 
> 
logger 
) 
{ 
_interaction 
= 
interaction "
;" #
_events   
=   
eventService   
;   
}!! 
public## 

	ViewModel## 
View## 
{## 
get## 
;##  
set##! $
;##$ %
}##& '
=##( )
default##* 1
!##1 2
;##2 3
[%% 
BindProperty%% 
]%% 
public&& 


InputModel&& 
Input&& 
{&& 
get&& !
;&&! "
set&&# &
;&&& '
}&&( )
=&&* +
default&&, 3
!&&3 4
;&&4 5
public(( 

async(( 
Task(( 
<(( 
IActionResult(( #
>((# $
OnGet((% *
(((* +
string((+ 1
?((1 2
userCode((3 ;
)((; <
{)) 
if** 

(** 
String** 
.** 
IsNullOrWhiteSpace** %
(**% &
userCode**& .
)**. /
)**/ 0
{++ 	
return,, 
Page,, 
(,, 
),, 
;,, 
}-- 	
if// 

(// 
!// 
await// 
SetViewModelAsync// $
(//$ %
userCode//% -
)//- .
)//. /
{00 	

ModelState11 
.11 
AddModelError11 $
(11$ %
$str11% '
,11' (
DeviceOptions11) 6
.116 7
InvalidUserCode117 F
)11F G
;11G H
return22 
Page22 
(22 
)22 
;22 
}33 	
Input55 
=55 
new55 

InputModel55 
{55  
UserCode66 
=66 
userCode66 
,66  
}77 	
;77	 

return99 
Page99 
(99 
)99 
;99 
}:: 
public<< 

async<< 
Task<< 
<<< 
IActionResult<< #
><<# $
OnPost<<% +
(<<+ ,
)<<, -
{== 
var>> 
request>> 
=>> 
await>> 
_interaction>> (
.>>( )(
GetAuthorizationContextAsync>>) E
(>>E F
Input>>F K
.>>K L
UserCode>>L T
??>>U W
throw>>X ]
new>>^ a!
ArgumentNullException>>b w
(>>w x
nameof>>x ~
(>>~ 
Input	>> Ñ
.
>>Ñ Ö
UserCode
>>Ö ç
)
>>ç é
)
>>é è
)
>>è ê
;
>>ê ë
if?? 

(?? 
request?? 
==?? 
null?? 
)?? 
return?? #
RedirectToPage??$ 2
(??2 3
$str??3 F
)??F G
;??G H
ConsentResponseAA 
?AA 
grantedConsentAA '
=AA( )
nullAA* .
;AA. /
ifDD 

(DD 
InputDD 
.DD 
ButtonDD 
==DD 
$strDD  
)DD  !
{EE 	
grantedConsentFF 
=FF 
newFF  
ConsentResponseFF! 0
{GG 
ErrorHH 
=HH 
AuthorizationErrorHH *
.HH* +
AccessDeniedHH+ 7
}II 
;II 
awaitLL 
_eventsLL 
.LL 

RaiseAsyncLL $
(LL$ %
newLL% (
ConsentDeniedEventLL) ;
(LL; <
UserLL< @
.LL@ A
GetSubjectIdLLA M
(LLM N
)LLN O
,LLO P
requestLLQ X
.LLX Y
ClientLLY _
.LL_ `
ClientIdLL` h
,LLh i
requestLLj q
.LLq r
ValidatedResources	LLr Ñ
.
LLÑ Ö
RawScopeValues
LLÖ ì
)
LLì î
)
LLî ï
;
LLï ñ
	TelemetryMM 
.MM 
MetricsMM 
.MM 
ConsentDeniedMM +
(MM+ ,
requestMM, 3
.MM3 4
ClientMM4 :
.MM: ;
ClientIdMM; C
,MMC D
requestMME L
.MML M
ValidatedResourcesMMM _
.MM_ `
ParsedScopesMM` l
.MMl m
SelectMMm s
(MMs t
sMMt u
=>MMv x
sMMy z
.MMz {

ParsedName	MM{ Ö
)
MMÖ Ü
)
MMÜ á
;
MMá à
}NN 	
elsePP 
ifPP 
(PP 
InputPP 
.PP 
ButtonPP 
==PP  
$strPP! &
)PP& '
{QQ 	
ifSS 
(SS 
InputSS 
.SS 
ScopesConsentedSS %
.SS% &
AnySS& )
(SS) *
)SS* +
)SS+ ,
{TT 
varUU 
scopesUU 
=UU 
InputUU "
.UU" #
ScopesConsentedUU# 2
;UU2 3
ifVV 
(VV 
ConsentOptionsVV "
.VV" #
EnableOfflineAccessVV# 6
==VV7 9
falseVV: ?
)VV? @
{WW 
scopesXX 
=XX 
scopesXX #
.XX# $
WhereXX$ )
(XX) *
xXX* +
=>XX, .
xXX/ 0
!=XX1 3
DuendeXX4 :
.XX: ;
IdentityServerXX; I
.XXI J#
IdentityServerConstantsXXJ a
.XXa b
StandardScopesXXb p
.XXp q
OfflineAccessXXq ~
)XX~ 
;	XX Ä
}YY 
grantedConsent[[ 
=[[  
new[[! $
ConsentResponse[[% 4
{\\ 
RememberConsent]] #
=]]$ %
Input]]& +
.]]+ ,
RememberConsent]], ;
,]]; <!
ScopesValuesConsented^^ )
=^^* +
scopes^^, 2
.^^2 3
ToArray^^3 :
(^^: ;
)^^; <
,^^< =
Description__ 
=__  !
Input__" '
.__' (
Description__( 3
}`` 
;`` 
awaitcc 
_eventscc 
.cc 

RaiseAsynccc (
(cc( )
newcc) ,
ConsentGrantedEventcc- @
(cc@ A
UserccA E
.ccE F
GetSubjectIdccF R
(ccR S
)ccS T
,ccT U
requestccV ]
.cc] ^
Clientcc^ d
.ccd e
ClientIdcce m
,ccm n
requestcco v
.ccv w
ValidatedResources	ccw â
.
ccâ ä
RawScopeValues
ccä ò
,
ccò ô
grantedConsent
ccö ®
.
cc® ©#
ScopesValuesConsented
cc© æ
,
ccæ ø
grantedConsent
cc¿ Œ
.
ccŒ œ
RememberConsent
ccœ ﬁ
)
ccﬁ ﬂ
)
ccﬂ ‡
;
cc‡ ·
	Telemetrydd 
.dd 
Metricsdd !
.dd! "
ConsentGranteddd" 0
(dd0 1
requestdd1 8
.dd8 9
Clientdd9 ?
.dd? @
ClientIddd@ H
,ddH I
grantedConsentddJ X
.ddX Y!
ScopesValuesConsentedddY n
,ddn o
grantedConsentddp ~
.dd~ 
RememberConsent	dd é
)
ddé è
;
ddè ê
varee 
deniedee 
=ee 
requestee $
.ee$ %
ValidatedResourcesee% 7
.ee7 8
ParsedScopesee8 D
.eeD E
SelecteeE K
(eeK L
seeL M
=>eeN P
seeQ R
.eeR S

ParsedNameeeS ]
)ee] ^
.ee^ _
Exceptee_ e
(eee f
grantedConsenteef t
.eet u"
ScopesValuesConsented	eeu ä
)
eeä ã
;
eeã å
	Telemetryff 
.ff 
Metricsff !
.ff! "
ConsentDeniedff" /
(ff/ 0
requestff0 7
.ff7 8
Clientff8 >
.ff> ?
ClientIdff? G
,ffG H
deniedffI O
)ffO P
;ffP Q
}gg 
elsehh 
{ii 

ModelStatejj 
.jj 
AddModelErrorjj (
(jj( )
$strjj) +
,jj+ ,
ConsentOptionsjj- ;
.jj; <%
MustChooseOneErrorMessagejj< U
)jjU V
;jjV W
}kk 
}ll 	
elsemm 
{nn 	

ModelStateoo 
.oo 
AddModelErroroo $
(oo$ %
$stroo% '
,oo' (
ConsentOptionsoo) 7
.oo7 8(
InvalidSelectionErrorMessageoo8 T
)ooT U
;ooU V
}pp 	
ifrr 

(rr 
grantedConsentrr 
!=rr 
nullrr "
)rr" #
{ss 	
awaituu 
_interactionuu 
.uu 
HandleRequestAsyncuu 1
(uu1 2
Inputuu2 7
.uu7 8
UserCodeuu8 @
,uu@ A
grantedConsentuuB P
)uuP Q
;uuQ R
returnxx 
RedirectToPagexx !
(xx! "
$strxx" 3
)xx3 4
;xx4 5
}yy 	
if|| 

(|| 
!|| 
await|| 
SetViewModelAsync|| $
(||$ %
Input||% *
.||* +
UserCode||+ 3
)||3 4
)||4 5
{}} 	
return~~ 
RedirectToPage~~ !
(~~! "
$str~~" 5
)~~5 6
;~~6 7
} 	
return
ÄÄ 
Page
ÄÄ 
(
ÄÄ 
)
ÄÄ 
;
ÄÄ 
}
ÅÅ 
private
ÑÑ 
async
ÑÑ 
Task
ÑÑ 
<
ÑÑ 
bool
ÑÑ 
>
ÑÑ 
SetViewModelAsync
ÑÑ .
(
ÑÑ. /
string
ÑÑ/ 5
userCode
ÑÑ6 >
)
ÑÑ> ?
{
ÖÖ 
var
ÜÜ 
request
ÜÜ 
=
ÜÜ 
await
ÜÜ 
_interaction
ÜÜ (
.
ÜÜ( )*
GetAuthorizationContextAsync
ÜÜ) E
(
ÜÜE F
userCode
ÜÜF N
)
ÜÜN O
;
ÜÜO P
if
áá 

(
áá 
request
áá 
!=
áá 
null
áá 
)
áá 
{
àà 	
View
ââ 
=
ââ $
CreateConsentViewModel
ââ )
(
ââ) *
request
ââ* 1
)
ââ1 2
;
ââ2 3
return
ää 
true
ää 
;
ää 
}
ãã 	
else
åå 
{
çç 	
View
éé 
=
éé 
new
éé 
	ViewModel
éé  
(
éé  !
)
éé! "
;
éé" #
return
èè 
false
èè 
;
èè 
}
êê 	
}
ëë 
private
ìì 
	ViewModel
ìì $
CreateConsentViewModel
ìì ,
(
ìì, -,
DeviceFlowAuthorizationRequest
ìì- K
request
ììL S
)
ììS T
{
îî 
var
ïï 
vm
ïï 
=
ïï 
new
ïï 
	ViewModel
ïï 
{
ññ 	

ClientName
óó 
=
óó 
request
óó  
.
óó  !
Client
óó! '
.
óó' (

ClientName
óó( 2
??
óó3 5
request
óó6 =
.
óó= >
Client
óó> D
.
óóD E
ClientId
óóE M
,
óóM N
	ClientUrl
òò 
=
òò 
request
òò 
.
òò  
Client
òò  &
.
òò& '
	ClientUri
òò' 0
,
òò0 1
ClientLogoUrl
ôô 
=
ôô 
request
ôô #
.
ôô# $
Client
ôô$ *
.
ôô* +
LogoUri
ôô+ 2
,
ôô2 3"
AllowRememberConsent
öö  
=
öö! "
request
öö# *
.
öö* +
Client
öö+ 1
.
öö1 2"
AllowRememberConsent
öö2 F
}
õõ 	
;
õõ	 

vm
ùù 

.
ùù
 
IdentityScopes
ùù 
=
ùù 
request
ùù #
.
ùù# $ 
ValidatedResources
ùù$ 6
.
ùù6 7
	Resources
ùù7 @
.
ùù@ A
IdentityResources
ùùA R
.
ùùR S
Select
ùùS Y
(
ùùY Z
x
ùùZ [
=>
ùù\ ^"
CreateScopeViewModel
ùù_ s
(
ùùs t
x
ùùt u
,
ùùu v
Input
ùùw |
==
ùù} 
nullùùÄ Ñ
||ùùÖ á
Inputùùà ç
.ùùç é
ScopesConsentedùùé ù
.ùùù û
Containsùùû ¶
(ùù¶ ß
xùùß ®
.ùù® ©
Nameùù© ≠
)ùù≠ Æ
)ùùÆ Ø
)ùùØ ∞
.ùù∞ ±
ToArrayùù± ∏
(ùù∏ π
)ùùπ ∫
;ùù∫ ª
var
üü 
	apiScopes
üü 
=
üü 
new
üü 
List
üü  
<
üü  !
ScopeViewModel
üü! /
>
üü/ 0
(
üü0 1
)
üü1 2
;
üü2 3
foreach
†† 
(
†† 
var
†† 
parsedScope
††  
in
††! #
request
††$ +
.
††+ , 
ValidatedResources
††, >
.
††> ?
ParsedScopes
††? K
)
††K L
{
°° 	
var
¢¢ 
apiScope
¢¢ 
=
¢¢ 
request
¢¢ "
.
¢¢" # 
ValidatedResources
¢¢# 5
.
¢¢5 6
	Resources
¢¢6 ?
.
¢¢? @
FindApiScope
¢¢@ L
(
¢¢L M
parsedScope
¢¢M X
.
¢¢X Y

ParsedName
¢¢Y c
)
¢¢c d
;
¢¢d e
if
££ 
(
££ 
apiScope
££ 
!=
££ 
null
££  
)
££  !
{
§§ 
var
•• 
scopeVm
•• 
=
•• "
CreateScopeViewModel
•• 2
(
••2 3
parsedScope
••3 >
,
••> ?
apiScope
••@ H
,
••H I
Input
••J O
==
••P R
null
••S W
||
••X Z
Input
••[ `
.
••` a
ScopesConsented
••a p
.
••p q
Contains
••q y
(
••y z
parsedScope••z Ö
.••Ö Ü
RawValue••Ü é
)••é è
)••è ê
;••ê ë
	apiScopes
¶¶ 
.
¶¶ 
Add
¶¶ 
(
¶¶ 
scopeVm
¶¶ %
)
¶¶% &
;
¶¶& '
}
ßß 
}
®® 	
if
©© 

(
©© 
DeviceOptions
©© 
.
©© !
EnableOfflineAccess
©© -
&&
©©. 0
request
©©1 8
.
©©8 9 
ValidatedResources
©©9 K
.
©©K L
	Resources
©©L U
.
©©U V
OfflineAccess
©©V c
)
©©c d
{
™™ 	
	apiScopes
´´ 
.
´´ 
Add
´´ 
(
´´ #
GetOfflineAccessScope
´´ /
(
´´/ 0
Input
´´0 5
==
´´6 8
null
´´9 =
||
´´> @
Input
´´A F
.
´´F G
ScopesConsented
´´G V
.
´´V W
Contains
´´W _
(
´´_ `
Duende
´´` f
.
´´f g
IdentityServer
´´g u
.
´´u v&
IdentityServerConstants´´v ç
.´´ç é
StandardScopes´´é ú
.´´ú ù
OfflineAccess´´ù ™
)´´™ ´
)´´´ ¨
)´´¨ ≠
;´´≠ Æ
}
¨¨ 	
vm
≠≠ 

.
≠≠
 
	ApiScopes
≠≠ 
=
≠≠ 
	apiScopes
≠≠  
;
≠≠  !
return
ØØ 
vm
ØØ 
;
ØØ 
}
∞∞ 
private
≤≤ 
static
≤≤ 
ScopeViewModel
≤≤ !"
CreateScopeViewModel
≤≤" 6
(
≤≤6 7
IdentityResource
≤≤7 G
identity
≤≤H P
,
≤≤P Q
bool
≤≤R V
check
≤≤W \
)
≤≤\ ]
{
≥≥ 
return
¥¥ 
new
¥¥ 
ScopeViewModel
¥¥ !
{
µµ 	
Value
∂∂ 
=
∂∂ 
identity
∂∂ 
.
∂∂ 
Name
∂∂ !
,
∂∂! "
DisplayName
∑∑ 
=
∑∑ 
identity
∑∑ "
.
∑∑" #
DisplayName
∑∑# .
??
∑∑/ 1
identity
∑∑2 :
.
∑∑: ;
Name
∑∑; ?
,
∑∑? @
Description
∏∏ 
=
∏∏ 
identity
∏∏ "
.
∏∏" #
Description
∏∏# .
,
∏∏. /
	Emphasize
ππ 
=
ππ 
identity
ππ  
.
ππ  !
	Emphasize
ππ! *
,
ππ* +
Required
∫∫ 
=
∫∫ 
identity
∫∫ 
.
∫∫  
Required
∫∫  (
,
∫∫( )
Checked
ªª 
=
ªª 
check
ªª 
||
ªª 
identity
ªª '
.
ªª' (
Required
ªª( 0
}
ºº 	
;
ºº	 

}
ΩΩ 
private
øø 
static
øø 
ScopeViewModel
øø !"
CreateScopeViewModel
øø" 6
(
øø6 7
ParsedScopeValue
øø7 G
parsedScopeValue
øøH X
,
øøX Y
ApiScope
øøZ b
apiScope
øøc k
,
øøk l
bool
øøm q
check
øør w
)
øøw x
{
¿¿ 
return
¡¡ 
new
¡¡ 
ScopeViewModel
¡¡ !
{
¬¬ 	
Value
√√ 
=
√√ 
parsedScopeValue
√√ $
.
√√$ %
RawValue
√√% -
,
√√- .
DisplayName
≈≈ 
=
≈≈ 
apiScope
≈≈ "
.
≈≈" #
DisplayName
≈≈# .
??
≈≈/ 1
apiScope
≈≈2 :
.
≈≈: ;
Name
≈≈; ?
,
≈≈? @
Description
∆∆ 
=
∆∆ 
apiScope
∆∆ "
.
∆∆" #
Description
∆∆# .
,
∆∆. /
	Emphasize
«« 
=
«« 
apiScope
««  
.
««  !
	Emphasize
««! *
,
««* +
Required
»» 
=
»» 
apiScope
»» 
.
»»  
Required
»»  (
,
»»( )
Checked
…… 
=
…… 
check
…… 
||
…… 
apiScope
…… '
.
……' (
Required
……( 0
}
   	
;
  	 

}
ÀÀ 
private
ÕÕ 
static
ÕÕ 
ScopeViewModel
ÕÕ !#
GetOfflineAccessScope
ÕÕ" 7
(
ÕÕ7 8
bool
ÕÕ8 <
check
ÕÕ= B
)
ÕÕB C
{
ŒŒ 
return
œœ 
new
œœ 
ScopeViewModel
œœ !
{
–– 	
Value
—— 
=
—— 
Duende
—— 
.
—— 
IdentityServer
—— )
.
——) *%
IdentityServerConstants
——* A
.
——A B
StandardScopes
——B P
.
——P Q
OfflineAccess
——Q ^
,
——^ _
DisplayName
““ 
=
““ 
DeviceOptions
““ '
.
““' (&
OfflineAccessDisplayName
““( @
,
““@ A
Description
”” 
=
”” 
DeviceOptions
”” '
.
””' (&
OfflineAccessDescription
””( @
,
””@ A
	Emphasize
‘‘ 
=
‘‘ 
true
‘‘ 
,
‘‘ 
Checked
’’ 
=
’’ 
check
’’ 
}
÷÷ 	
;
÷÷	 

}
◊◊ 
}ÿÿ Œ

nC:\netMentoring\04_layered_architectures\CartServiceConsoleApp\IdentityServerApi\Pages\Device\DeviceOptions.cs
	namespace 	
IdentityServerApi
 
. 
Pages !
.! "
Device" (
;( )
public 
static 
class 
DeviceOptions !
{ 
public 

static 
readonly 
bool 
EnableOfflineAccess  3
=4 5
true6 :
;: ;
public		 

static		 
readonly		 
string		 !$
OfflineAccessDisplayName		" :
=		; <
$str		= M
;		M N
public

 

static

 
readonly

 
string

 !$
OfflineAccessDescription

" :
=

; <
$str	

= É
;


É Ñ
public 

static 
readonly 
string !
InvalidUserCode" 1
=2 3
$str4 G
;G H
public 

static 
readonly 
string !%
MustChooseOneErrorMessage" ;
=< =
$str> e
;e f
public 

static 
readonly 
string !(
InvalidSelectionErrorMessage" >
=? @
$strA T
;T U
} ç
lC:\netMentoring\04_layered_architectures\CartServiceConsoleApp\IdentityServerApi\Pages\Consent\InputModel.cs
	namespace 	
IdentityServerApi
 
. 
Pages !
.! "
Consent" )
;) *
public 
class 

InputModel 
{ 
public 

string 
? 
Button 
{ 
get 
;  
set! $
;$ %
}& '
public		 

IEnumerable		 
<		 
string		 
>		 
ScopesConsented		 .
{		/ 0
get		1 4
;		4 5
set		6 9
;		9 :
}		; <
=		= >
new		? B
List		C G
<		G H
string		H N
>		N O
(		O P
)		P Q
;		Q R
public

 

bool

 
RememberConsent

 
{

  !
get

" %
;

% &
set

' *
;

* +
}

, -
=

. /
true

0 4
;

4 5
public 

string 
? 
	ReturnUrl 
{ 
get "
;" #
set$ '
;' (
}) *
public 

string 
? 
Description 
{  
get! $
;$ %
set& )
;) *
}+ ,
} ıµ
nC:\netMentoring\04_layered_architectures\CartServiceConsoleApp\IdentityServerApi\Pages\Consent\Index.cshtml.cs
	namespace 	
IdentityServerApi
 
. 
Pages !
.! "
Consent" )
;) *
[ 
	Authorize 

]
 
[ 
SecurityHeaders 
] 
public 
class 
Index 
: 
	PageModel 
{ 
private 
readonly -
!IIdentityServerInteractionService 6
_interaction7 C
;C D
private 
readonly 
IEventService "
_events# *
;* +
private 
readonly 
ILogger 
< 
Index "
>" #
_logger$ +
;+ ,
public 

Index 
( -
!IIdentityServerInteractionService )
interaction* 5
,5 6
IEventService 
events 
, 
ILogger 
< 
Index 
> 
logger 
) 
{ 
_interaction 
= 
interaction "
;" #
_events 
= 
events 
; 
_logger 
= 
logger 
; 
}   
public"" 

	ViewModel"" 
View"" 
{"" 
get"" 
;""  
set""! $
;""$ %
}""& '
=""( )
default""* 1
!""1 2
;""2 3
[$$ 
BindProperty$$ 
]$$ 
public%% 


InputModel%% 
Input%% 
{%% 
get%% !
;%%! "
set%%# &
;%%& '
}%%( )
=%%* +
default%%, 3
!%%3 4
;%%4 5
public'' 

async'' 
Task'' 
<'' 
IActionResult'' #
>''# $
OnGet''% *
(''* +
string''+ 1
?''1 2
	returnUrl''3 <
)''< =
{(( 
if)) 

()) 
!)) 
await)) 
SetViewModelAsync)) $
())$ %
	returnUrl))% .
))). /
)))/ 0
{** 	
return++ 
RedirectToPage++ !
(++! "
$str++" 5
)++5 6
;++6 7
},, 	
Input.. 
=.. 
new.. 

InputModel.. 
{// 	
	ReturnUrl00 
=00 
	returnUrl00 !
,00! "
}11 	
;11	 

return33 
Page33 
(33 
)33 
;33 
}44 
public66 

async66 
Task66 
<66 
IActionResult66 #
>66# $
OnPost66% +
(66+ ,
)66, -
{77 
var99 
request99 
=99 
await99 
_interaction99 (
.99( )(
GetAuthorizationContextAsync99) E
(99E F
Input99F K
.99K L
	ReturnUrl99L U
)99U V
;99V W
if:: 

(:: 
request:: 
==:: 
null:: 
):: 
return:: #
RedirectToPage::$ 2
(::2 3
$str::3 F
)::F G
;::G H
ConsentResponse<< 
?<< 
grantedConsent<< '
=<<( )
null<<* .
;<<. /
if?? 

(?? 
Input?? 
.?? 
Button?? 
==?? 
$str??  
)??  !
{@@ 	
grantedConsentAA 
=AA 
newAA  
ConsentResponseAA! 0
{AA1 2
ErrorAA3 8
=AA9 :
AuthorizationErrorAA; M
.AAM N
AccessDeniedAAN Z
}AA[ \
;AA\ ]
awaitDD 
_eventsDD 
.DD 

RaiseAsyncDD $
(DD$ %
newDD% (
ConsentDeniedEventDD) ;
(DD; <
UserDD< @
.DD@ A
GetSubjectIdDDA M
(DDM N
)DDN O
,DDO P
requestDDQ X
.DDX Y
ClientDDY _
.DD_ `
ClientIdDD` h
,DDh i
requestDDj q
.DDq r
ValidatedResources	DDr Ñ
.
DDÑ Ö
RawScopeValues
DDÖ ì
)
DDì î
)
DDî ï
;
DDï ñ
	TelemetryEE 
.EE 
MetricsEE 
.EE 
ConsentDeniedEE +
(EE+ ,
requestEE, 3
.EE3 4
ClientEE4 :
.EE: ;
ClientIdEE; C
,EEC D
requestEEE L
.EEL M
ValidatedResourcesEEM _
.EE_ `
ParsedScopesEE` l
.EEl m
SelectEEm s
(EEs t
sEEt u
=>EEv x
sEEy z
.EEz {

ParsedName	EE{ Ö
)
EEÖ Ü
)
EEÜ á
;
EEá à
}FF 	
elseHH 
ifHH 
(HH 
InputHH 
.HH 
ButtonHH 
==HH  
$strHH! &
)HH& '
{II 	
ifKK 
(KK 
InputKK 
.KK 
ScopesConsentedKK %
.KK% &
AnyKK& )
(KK) *
)KK* +
)KK+ ,
{LL 
varMM 
scopesMM 
=MM 
InputMM "
.MM" #
ScopesConsentedMM# 2
;MM2 3
ifNN 
(NN 
ConsentOptionsNN "
.NN" #
EnableOfflineAccessNN# 6
==NN7 9
falseNN: ?
)NN? @
{OO 
scopesPP 
=PP 
scopesPP #
.PP# $
WherePP$ )
(PP) *
xPP* +
=>PP, .
xPP/ 0
!=PP1 3
DuendePP4 :
.PP: ;
IdentityServerPP; I
.PPI J#
IdentityServerConstantsPPJ a
.PPa b
StandardScopesPPb p
.PPp q
OfflineAccessPPq ~
)PP~ 
;	PP Ä
}QQ 
grantedConsentSS 
=SS  
newSS! $
ConsentResponseSS% 4
{TT 
RememberConsentUU #
=UU$ %
InputUU& +
.UU+ ,
RememberConsentUU, ;
,UU; <!
ScopesValuesConsentedVV )
=VV* +
scopesVV, 2
.VV2 3
ToArrayVV3 :
(VV: ;
)VV; <
,VV< =
DescriptionWW 
=WW  !
InputWW" '
.WW' (
DescriptionWW( 3
}XX 
;XX 
await[[ 
_events[[ 
.[[ 

RaiseAsync[[ (
([[( )
new[[) ,
ConsentGrantedEvent[[- @
([[@ A
User[[A E
.[[E F
GetSubjectId[[F R
([[R S
)[[S T
,[[T U
request[[V ]
.[[] ^
Client[[^ d
.[[d e
ClientId[[e m
,[[m n
request[[o v
.[[v w
ValidatedResources	[[w â
.
[[â ä
RawScopeValues
[[ä ò
,
[[ò ô
grantedConsent
[[ö ®
.
[[® ©#
ScopesValuesConsented
[[© æ
,
[[æ ø
grantedConsent
[[¿ Œ
.
[[Œ œ
RememberConsent
[[œ ﬁ
)
[[ﬁ ﬂ
)
[[ﬂ ‡
;
[[‡ ·
	Telemetry\\ 
.\\ 
Metrics\\ !
.\\! "
ConsentGranted\\" 0
(\\0 1
request\\1 8
.\\8 9
Client\\9 ?
.\\? @
ClientId\\@ H
,\\H I
grantedConsent\\J X
.\\X Y!
ScopesValuesConsented\\Y n
,\\n o
grantedConsent\\p ~
.\\~ 
RememberConsent	\\ é
)
\\é è
;
\\è ê
var]] 
denied]] 
=]] 
request]] $
.]]$ %
ValidatedResources]]% 7
.]]7 8
ParsedScopes]]8 D
.]]D E
Select]]E K
(]]K L
s]]L M
=>]]N P
s]]Q R
.]]R S

ParsedName]]S ]
)]]] ^
.]]^ _
Except]]_ e
(]]e f
grantedConsent]]f t
.]]t u"
ScopesValuesConsented	]]u ä
)
]]ä ã
;
]]ã å
	Telemetry^^ 
.^^ 
Metrics^^ !
.^^! "
ConsentDenied^^" /
(^^/ 0
request^^0 7
.^^7 8
Client^^8 >
.^^> ?
ClientId^^? G
,^^G H
denied^^I O
)^^O P
;^^P Q
}__ 
else`` 
{aa 

ModelStatebb 
.bb 
AddModelErrorbb (
(bb( )
$strbb) +
,bb+ ,
ConsentOptionsbb- ;
.bb; <%
MustChooseOneErrorMessagebb< U
)bbU V
;bbV W
}cc 
}dd 	
elseee 
{ff 	

ModelStategg 
.gg 
AddModelErrorgg $
(gg$ %
$strgg% '
,gg' (
ConsentOptionsgg) 7
.gg7 8(
InvalidSelectionErrorMessagegg8 T
)ggT U
;ggU V
}hh 	
ifjj 

(jj 
grantedConsentjj 
!=jj 
nulljj "
)jj" #
{kk 	!
ArgumentNullExceptionll !
.ll! "
ThrowIfNullll" -
(ll- .
Inputll. 3
.ll3 4
	ReturnUrlll4 =
,ll= >
nameofll? E
(llE F
InputllF K
.llK L
	ReturnUrlllL U
)llU V
)llV W
;llW X
awaitoo 
_interactionoo 
.oo 
GrantConsentAsyncoo 0
(oo0 1
requestoo1 8
,oo8 9
grantedConsentoo: H
)ooH I
;ooI J
ifrr 
(rr 
requestrr 
.rr 
IsNativeClientrr &
(rr& '
)rr' (
==rr) +
truerr, 0
)rr0 1
{ss 
returnvv 
thisvv 
.vv 
LoadingPagevv '
(vv' (
Inputvv( -
.vv- .
	ReturnUrlvv. 7
)vv7 8
;vv8 9
}ww 
returnyy 
Redirectyy 
(yy 
Inputyy !
.yy! "
	ReturnUrlyy" +
)yy+ ,
;yy, -
}zz 	
if}} 

(}} 
!}} 
await}} 
SetViewModelAsync}} $
(}}$ %
Input}}% *
.}}* +
	ReturnUrl}}+ 4
)}}4 5
)}}5 6
{~~ 	
return 
RedirectToPage !
(! "
$str" 5
)5 6
;6 7
}
ÄÄ 	
return
ÅÅ 
Page
ÅÅ 
(
ÅÅ 
)
ÅÅ 
;
ÅÅ 
}
ÇÇ 
private
ÑÑ 
async
ÑÑ 
Task
ÑÑ 
<
ÑÑ 
bool
ÑÑ 
>
ÑÑ 
SetViewModelAsync
ÑÑ .
(
ÑÑ. /
string
ÑÑ/ 5
?
ÑÑ5 6
	returnUrl
ÑÑ7 @
)
ÑÑ@ A
{
ÖÖ #
ArgumentNullException
ÜÜ 
.
ÜÜ 
ThrowIfNull
ÜÜ )
(
ÜÜ) *
	returnUrl
ÜÜ* 3
)
ÜÜ3 4
;
ÜÜ4 5
var
àà 
request
àà 
=
àà 
await
àà 
_interaction
àà (
.
àà( )*
GetAuthorizationContextAsync
àà) E
(
ààE F
	returnUrl
ààF O
)
ààO P
;
ààP Q
if
ââ 

(
ââ 
request
ââ 
!=
ââ 
null
ââ 
)
ââ 
{
ää 	
View
ãã 
=
ãã $
CreateConsentViewModel
ãã )
(
ãã) *
request
ãã* 1
)
ãã1 2
;
ãã2 3
return
åå 
true
åå 
;
åå 
}
çç 	
else
éé 
{
èè 	
_logger
êê 
.
êê &
NoConsentMatchingRequest
êê ,
(
êê, -
	returnUrl
êê- 6
)
êê6 7
;
êê7 8
return
ëë 
false
ëë 
;
ëë 
}
íí 	
}
ìì 
private
ïï 
	ViewModel
ïï $
CreateConsentViewModel
ïï ,
(
ïï, -"
AuthorizationRequest
ïï- A
request
ïïB I
)
ïïI J
{
ññ 
var
óó 
vm
óó 
=
óó 
new
óó 
	ViewModel
óó 
{
òò 	

ClientName
ôô 
=
ôô 
request
ôô  
.
ôô  !
Client
ôô! '
.
ôô' (

ClientName
ôô( 2
??
ôô3 5
request
ôô6 =
.
ôô= >
Client
ôô> D
.
ôôD E
ClientId
ôôE M
,
ôôM N
	ClientUrl
öö 
=
öö 
request
öö 
.
öö  
Client
öö  &
.
öö& '
	ClientUri
öö' 0
,
öö0 1
ClientLogoUrl
õõ 
=
õõ 
request
õõ #
.
õõ# $
Client
õõ$ *
.
õõ* +
LogoUri
õõ+ 2
,
õõ2 3"
AllowRememberConsent
úú  
=
úú! "
request
úú# *
.
úú* +
Client
úú+ 1
.
úú1 2"
AllowRememberConsent
úú2 F
}
ùù 	
;
ùù	 

vm
üü 

.
üü
 
IdentityScopes
üü 
=
üü 
request
üü #
.
üü# $ 
ValidatedResources
üü$ 6
.
üü6 7
	Resources
üü7 @
.
üü@ A
IdentityResources
üüA R
.
†† 
Select
†† 
(
†† 
x
†† 
=>
†† "
CreateScopeViewModel
†† -
(
††- .
x
††. /
,
††/ 0
Input
††1 6
==
††7 9
null
††: >
||
††? A
Input
††B G
.
††G H
ScopesConsented
††H W
.
††W X
Contains
††X `
(
††` a
x
††a b
.
††b c
Name
††c g
)
††g h
)
††h i
)
††i j
.
°° 
ToArray
°° 
(
°° 
)
°° 
;
°° 
var
££  
resourceIndicators
££ 
=
££  
request
££! (
.
££( )

Parameters
££) 3
.
££3 4
	GetValues
££4 =
(
££= >
OidcConstants
££> K
.
££K L
AuthorizeRequest
££L \
.
££\ ]
Resource
££] e
)
££e f
??
££g i

Enumerable
££j t
.
££t u
Empty
££u z
<
££z {
string££{ Å
>££Å Ç
(££Ç É
)££É Ñ
;££Ñ Ö
var
§§ 
apiResources
§§ 
=
§§ 
request
§§ "
.
§§" # 
ValidatedResources
§§# 5
.
§§5 6
	Resources
§§6 ?
.
§§? @
ApiResources
§§@ L
.
§§L M
Where
§§M R
(
§§R S
x
§§S T
=>
§§U W 
resourceIndicators
§§X j
.
§§j k
Contains
§§k s
(
§§s t
x
§§t u
.
§§u v
Name
§§v z
)
§§z {
)
§§{ |
;
§§| }
var
¶¶ 
	apiScopes
¶¶ 
=
¶¶ 
new
¶¶ 
List
¶¶  
<
¶¶  !
ScopeViewModel
¶¶! /
>
¶¶/ 0
(
¶¶0 1
)
¶¶1 2
;
¶¶2 3
foreach
ßß 
(
ßß 
var
ßß 
parsedScope
ßß  
in
ßß! #
request
ßß$ +
.
ßß+ , 
ValidatedResources
ßß, >
.
ßß> ?
ParsedScopes
ßß? K
)
ßßK L
{
®® 	
var
©© 
apiScope
©© 
=
©© 
request
©© "
.
©©" # 
ValidatedResources
©©# 5
.
©©5 6
	Resources
©©6 ?
.
©©? @
FindApiScope
©©@ L
(
©©L M
parsedScope
©©M X
.
©©X Y

ParsedName
©©Y c
)
©©c d
;
©©d e
if
™™ 
(
™™ 
apiScope
™™ 
!=
™™ 
null
™™  
)
™™  !
{
´´ 
var
¨¨ 
scopeVm
¨¨ 
=
¨¨ "
CreateScopeViewModel
¨¨ 2
(
¨¨2 3
parsedScope
¨¨3 >
,
¨¨> ?
apiScope
¨¨@ H
,
¨¨H I
Input
¨¨J O
==
¨¨P R
null
¨¨S W
||
¨¨X Z
Input
¨¨[ `
.
¨¨` a
ScopesConsented
¨¨a p
.
¨¨p q
Contains
¨¨q y
(
¨¨y z
parsedScope¨¨z Ö
.¨¨Ö Ü
RawValue¨¨Ü é
)¨¨é è
)¨¨è ê
;¨¨ê ë
scopeVm
≠≠ 
.
≠≠ 
	Resources
≠≠ !
=
≠≠" #
apiResources
≠≠$ 0
.
≠≠0 1
Where
≠≠1 6
(
≠≠6 7
x
≠≠7 8
=>
≠≠9 ;
x
≠≠< =
.
≠≠= >
Scopes
≠≠> D
.
≠≠D E
Contains
≠≠E M
(
≠≠M N
parsedScope
≠≠N Y
.
≠≠Y Z

ParsedName
≠≠Z d
)
≠≠d e
)
≠≠e f
.
ÆÆ 
Select
ÆÆ 
(
ÆÆ 
x
ÆÆ 
=>
ÆÆ  
new
ÆÆ! $
ResourceViewModel
ÆÆ% 6
{
ØØ 
Name
∞∞ 
=
∞∞ 
x
∞∞  
.
∞∞  !
Name
∞∞! %
,
∞∞% &
DisplayName
±± #
=
±±$ %
x
±±& '
.
±±' (
DisplayName
±±( 3
??
±±4 6
x
±±7 8
.
±±8 9
Name
±±9 =
,
±±= >
}
≤≤ 
)
≤≤ 
.
≤≤ 
ToArray
≤≤ 
(
≤≤ 
)
≤≤  
;
≤≤  !
	apiScopes
≥≥ 
.
≥≥ 
Add
≥≥ 
(
≥≥ 
scopeVm
≥≥ %
)
≥≥% &
;
≥≥& '
}
¥¥ 
}
µµ 	
if
∂∂ 

(
∂∂ 
ConsentOptions
∂∂ 
.
∂∂ !
EnableOfflineAccess
∂∂ .
&&
∂∂/ 1
request
∂∂2 9
.
∂∂9 : 
ValidatedResources
∂∂: L
.
∂∂L M
	Resources
∂∂M V
.
∂∂V W
OfflineAccess
∂∂W d
)
∂∂d e
{
∑∑ 	
	apiScopes
∏∏ 
.
∏∏ 
Add
∏∏ 
(
∏∏ &
CreateOfflineAccessScope
∏∏ 2
(
∏∏2 3
Input
∏∏3 8
==
∏∏9 ;
null
∏∏< @
||
∏∏A C
Input
∏∏D I
.
∏∏I J
ScopesConsented
∏∏J Y
.
∏∏Y Z
Contains
∏∏Z b
(
∏∏b c
Duende
∏∏c i
.
∏∏i j
IdentityServer
∏∏j x
.
∏∏x y&
IdentityServerConstants∏∏y ê
.∏∏ê ë
StandardScopes∏∏ë ü
.∏∏ü †
OfflineAccess∏∏† ≠
)∏∏≠ Æ
)∏∏Æ Ø
)∏∏Ø ∞
;∏∏∞ ±
}
ππ 	
vm
∫∫ 

.
∫∫
 
	ApiScopes
∫∫ 
=
∫∫ 
	apiScopes
∫∫  
;
∫∫  !
return
ºº 
vm
ºº 
;
ºº 
}
ΩΩ 
private
øø 
static
øø 
ScopeViewModel
øø !"
CreateScopeViewModel
øø" 6
(
øø6 7
IdentityResource
øø7 G
identity
øøH P
,
øøP Q
bool
øøR V
check
øøW \
)
øø\ ]
{
¿¿ 
return
¡¡ 
new
¡¡ 
ScopeViewModel
¡¡ !
{
¬¬ 	
Name
√√ 
=
√√ 
identity
√√ 
.
√√ 
Name
√√  
,
√√  !
Value
ƒƒ 
=
ƒƒ 
identity
ƒƒ 
.
ƒƒ 
Name
ƒƒ !
,
ƒƒ! "
DisplayName
≈≈ 
=
≈≈ 
identity
≈≈ "
.
≈≈" #
DisplayName
≈≈# .
??
≈≈/ 1
identity
≈≈2 :
.
≈≈: ;
Name
≈≈; ?
,
≈≈? @
Description
∆∆ 
=
∆∆ 
identity
∆∆ "
.
∆∆" #
Description
∆∆# .
,
∆∆. /
	Emphasize
«« 
=
«« 
identity
««  
.
««  !
	Emphasize
««! *
,
««* +
Required
»» 
=
»» 
identity
»» 
.
»»  
Required
»»  (
,
»»( )
Checked
…… 
=
…… 
check
…… 
||
…… 
identity
…… '
.
……' (
Required
……( 0
}
   	
;
  	 

}
ÀÀ 
private
ÕÕ 
static
ÕÕ 
ScopeViewModel
ÕÕ !"
CreateScopeViewModel
ÕÕ" 6
(
ÕÕ6 7
ParsedScopeValue
ÕÕ7 G
parsedScopeValue
ÕÕH X
,
ÕÕX Y
ApiScope
ÕÕZ b
apiScope
ÕÕc k
,
ÕÕk l
bool
ÕÕm q
check
ÕÕr w
)
ÕÕw x
{
ŒŒ 
var
œœ 
displayName
œœ 
=
œœ 
apiScope
œœ 
.
œœ 
DisplayName
œœ (
??
œœ) +
apiScope
œœ, 4
.
œœ4 5
Name
œœ5 9
;
œœ9 :
if
–– 

(
–– 
!
–– 
String
–– 
.
––  
IsNullOrWhiteSpace
–– &
(
––& '
parsedScopeValue
––' 7
.
––7 8
ParsedParameter
––8 G
)
––G H
)
––H I
{
—— 	
displayName
““ 
+=
““ 
$str
““ 
+
““  
parsedScopeValue
““! 1
.
““1 2
ParsedParameter
““2 A
;
““A B
}
”” 	
return
’’ 
new
’’ 
ScopeViewModel
’’ !
{
÷÷ 	
Name
◊◊ 
=
◊◊ 
parsedScopeValue
◊◊ #
.
◊◊# $

ParsedName
◊◊$ .
,
◊◊. /
Value
ÿÿ 
=
ÿÿ 
parsedScopeValue
ÿÿ $
.
ÿÿ$ %
RawValue
ÿÿ% -
,
ÿÿ- .
DisplayName
ŸŸ 
=
ŸŸ 
displayName
ŸŸ %
,
ŸŸ% &
Description
⁄⁄ 
=
⁄⁄ 
apiScope
⁄⁄ "
.
⁄⁄" #
Description
⁄⁄# .
,
⁄⁄. /
	Emphasize
€€ 
=
€€ 
apiScope
€€  
.
€€  !
	Emphasize
€€! *
,
€€* +
Required
‹‹ 
=
‹‹ 
apiScope
‹‹ 
.
‹‹  
Required
‹‹  (
,
‹‹( )
Checked
›› 
=
›› 
check
›› 
||
›› 
apiScope
›› '
.
››' (
Required
››( 0
}
ﬁﬁ 	
;
ﬁﬁ	 

}
ﬂﬂ 
private
·· 
static
·· 
ScopeViewModel
·· !&
CreateOfflineAccessScope
··" :
(
··: ;
bool
··; ?
check
··@ E
)
··E F
{
‚‚ 
return
„„ 
new
„„ 
ScopeViewModel
„„ !
{
‰‰ 	
Value
ÂÂ 
=
ÂÂ 
Duende
ÂÂ 
.
ÂÂ 
IdentityServer
ÂÂ )
.
ÂÂ) *%
IdentityServerConstants
ÂÂ* A
.
ÂÂA B
StandardScopes
ÂÂB P
.
ÂÂP Q
OfflineAccess
ÂÂQ ^
,
ÂÂ^ _
DisplayName
ÊÊ 
=
ÊÊ 
ConsentOptions
ÊÊ (
.
ÊÊ( )&
OfflineAccessDisplayName
ÊÊ) A
,
ÊÊA B
Description
ÁÁ 
=
ÁÁ 
ConsentOptions
ÁÁ (
.
ÁÁ( )&
OfflineAccessDescription
ÁÁ) A
,
ÁÁA B
	Emphasize
ËË 
=
ËË 
true
ËË 
,
ËË 
Checked
ÈÈ 
=
ÈÈ 
check
ÈÈ 
}
ÍÍ 	
;
ÍÍ	 

}
ÎÎ 
}ÏÏ ≥	
pC:\netMentoring\04_layered_architectures\CartServiceConsoleApp\IdentityServerApi\Pages\Consent\ConsentOptions.cs
	namespace 	
IdentityServerApi
 
. 
Pages !
.! "
Consent" )
;) *
public 
static 
class 
ConsentOptions "
{ 
public 

static 
readonly 
bool 
EnableOfflineAccess  3
=4 5
true6 :
;: ;
public		 

static		 
readonly		 
string		 !$
OfflineAccessDisplayName		" :
=		; <
$str		= M
;		M N
public

 

static

 
readonly

 
string

 !$
OfflineAccessDescription

" :
=

; <
$str	

= É
;


É Ñ
public 

static 
readonly 
string !%
MustChooseOneErrorMessage" ;
=< =
$str> e
;e f
public 

static 
readonly 
string !(
InvalidSelectionErrorMessage" >
=? @
$strA T
;T U
} ∂
hC:\netMentoring\04_layered_architectures\CartServiceConsoleApp\IdentityServerApi\Pages\Ciba\ViewModel.cs
	namespace 	
IdentityServerApi
 
. 
Pages !
.! "
Ciba" &
;& '
public 
class 
	ViewModel 
{ 
public 

string 
? 

ClientName 
{ 
get  #
;# $
set% (
;( )
}* +
public		 

string		 
?		 
	ClientUrl		 
{		 
get		 "
;		" #
set		$ '
;		' (
}		) *
public

 

string

 
?

 
ClientLogoUrl

  
{

! "
get

# &
;

& '
set

( +
;

+ ,
}

- .
public 

string 
? 
BindingMessage !
{" #
get$ '
;' (
set) ,
;, -
}. /
public 

IEnumerable 
< 
ScopeViewModel %
>% &
IdentityScopes' 5
{6 7
get8 ;
;; <
set= @
;@ A
}B C
=D E

EnumerableF P
.P Q
EmptyQ V
<V W
ScopeViewModelW e
>e f
(f g
)g h
;h i
public 

IEnumerable 
< 
ScopeViewModel %
>% &
	ApiScopes' 0
{1 2
get3 6
;6 7
set8 ;
;; <
}= >
=? @

EnumerableA K
.K L
EmptyL Q
<Q R
ScopeViewModelR `
>` a
(a b
)b c
;c d
} 
public 
class 
ScopeViewModel 
{ 
public 

string 
? 
Name 
{ 
get 
; 
set "
;" #
}$ %
public 

string 
? 
Value 
{ 
get 
; 
set  #
;# $
}% &
public 

string 
? 
DisplayName 
{  
get! $
;$ %
set& )
;) *
}+ ,
public 

string 
? 
Description 
{  
get! $
;$ %
set& )
;) *
}+ ,
public 

bool 
	Emphasize 
{ 
get 
;  
set! $
;$ %
}& '
public 

bool 
Required 
{ 
get 
; 
set  #
;# $
}% &
public 

bool 
Checked 
{ 
get 
; 
set "
;" #
}$ %
public 

IEnumerable 
< 
ResourceViewModel (
>( )
	Resources* 3
{4 5
get6 9
;9 :
set; >
;> ?
}@ A
=B C

EnumerableD N
.N O
EmptyO T
<T U
ResourceViewModelU f
>f g
(g h
)h i
;i j
} 
public 
class 
ResourceViewModel 
{ 
public   

string   
?   
Name   
{   
get   
;   
set   "
;  " #
}  $ %
public!! 

string!! 
?!! 
DisplayName!! 
{!!  
get!!! $
;!!$ %
set!!& )
;!!) *
}!!+ ,
}"" Ø	
iC:\netMentoring\04_layered_architectures\CartServiceConsoleApp\IdentityServerApi\Pages\Ciba\InputModel.cs
	namespace 	
IdentityServerApi
 
. 
Pages !
.! "
Ciba" &
;& '
public 
class 

InputModel 
{ 
public 

string 
? 
Button 
{ 
get 
;  
set! $
;$ %
}& '
public		 

IEnumerable		 
<		 
string		 
>		 
ScopesConsented		 .
{		/ 0
get		1 4
;		4 5
set		6 9
;		9 :
}		; <
=		= >
new		? B
List		C G
<		G H
string		H N
>		N O
(		O P
)		P Q
;		Q R
public

 

string

 
?

 
Id

 
{

 
get

 
;

 
set

  
;

  !
}

" #
public 

string 
? 
Description 
{  
get! $
;$ %
set& )
;) *
}+ ,
} €
kC:\netMentoring\04_layered_architectures\CartServiceConsoleApp\IdentityServerApi\Pages\Ciba\Index.cshtml.cs
	namespace

 	
IdentityServerApi


 
.

 
Pages

 !
.

! "
Ciba

" &
;

& '
[ 
AllowAnonymous 
] 
[ 
SecurityHeaders 
] 
public 
class 

IndexModel 
: 
	PageModel #
{ 
public 
'
BackchannelUserLoginRequest &
LoginRequest' 3
{4 5
get6 9
;9 :
set; >
;> ?
}@ A
=B C
defaultD K
!K L
;L M
private 
readonly 8
,IBackchannelAuthenticationInteractionService A1
%_backchannelAuthenticationInteractionB g
;g h
private 
readonly 
ILogger 
< 

IndexModel '
>' (
_logger) 0
;0 1
public 


IndexModel 
( 8
,IBackchannelAuthenticationInteractionService B7
+backchannelAuthenticationInteractionServiceC n
,n o
ILoggerp w
<w x

IndexModel	x Ç
>
Ç É
logger
Ñ ä
)
ä ã
{ 1
%_backchannelAuthenticationInteraction -
=. /7
+backchannelAuthenticationInteractionService0 [
;[ \
_logger 
= 
logger 
; 
} 
public 

async 
Task 
< 
IActionResult #
># $
OnGet% *
(* +
string+ 1
id2 4
)4 5
{ 
var 
result 
= 
await 1
%_backchannelAuthenticationInteraction @
.@ A,
 GetLoginRequestByInternalIdAsyncA a
(a b
idb d
)d e
;e f
if 

( 
result 
== 
null 
) 
{ 	
_logger   
.   %
InvalidBackchannelLoginId   -
(  - .
id  . 0
)  0 1
;  1 2
return!! 
RedirectToPage!! !
(!!! "
$str!!" 5
)!!5 6
;!!6 7
}"" 	
else## 
{$$ 	
LoginRequest%% 
=%% 
result%% !
;%%! "
}&& 	
return(( 
Page(( 
((( 
)(( 
;(( 
})) 
}** Ü≥
mC:\netMentoring\04_layered_architectures\CartServiceConsoleApp\IdentityServerApi\Pages\Ciba\Consent.cshtml.cs
	namespace 	
IdentityServerApi
 
. 
Pages !
.! "
Ciba" &
;& '
[ 
	Authorize 

]
 
[ 
SecurityHeaders 
] 
public 
class 
Consent 
: 
	PageModel  
{ 
private 
readonly 8
,IBackchannelAuthenticationInteractionService A
_interactionB N
;N O
private 
readonly 
IEventService "
_events# *
;* +
private 
readonly 
ILogger 
< 
Consent $
>$ %
_logger& -
;- .
public 

Consent 
( 8
,IBackchannelAuthenticationInteractionService 4
interaction5 @
,@ A
IEventService 
events 
, 
ILogger 
< 
Consent 
> 
logger 
)  
{ 
_interaction 
= 
interaction "
;" #
_events 
= 
events 
; 
_logger 
= 
logger 
; 
} 
public!! 

	ViewModel!! 
View!! 
{!! 
get!! 
;!!  
set!!! $
;!!$ %
}!!& '
=!!( )
default!!* 1
!!!1 2
;!!2 3
[## 
BindProperty## 
]## 
public$$ 


InputModel$$ 
Input$$ 
{$$ 
get$$ !
;$$! "
set$$# &
;$$& '
}$$( )
=$$* +
default$$, 3
!$$3 4
;$$4 5
public&& 

async&& 
Task&& 
<&& 
IActionResult&& #
>&&# $
OnGet&&% *
(&&* +
string&&+ 1
?&&1 2
id&&3 5
)&&5 6
{'' 
if(( 

((( 
!(( 
await(( 
SetViewModelAsync(( $
((($ %
id((% '
)((' (
)((( )
{)) 	
return** 
RedirectToPage** !
(**! "
$str**" 5
)**5 6
;**6 7
}++ 	
Input-- 
=-- 
new-- 

InputModel-- 
{.. 	
Id// 
=// 
id// 
}00 	
;00	 

return22 
Page22 
(22 
)22 
;22 
}33 
public55 

async55 
Task55 
<55 
IActionResult55 #
>55# $
OnPost55% +
(55+ ,
)55, -
{66 
var88 
request88 
=88 
await88 
_interaction88 (
.88( ),
 GetLoginRequestByInternalIdAsync88) I
(88I J
Input88J O
.88O P
Id88P R
??88S U
throw88V [
new88\ _!
ArgumentNullException88` u
(88u v
nameof88v |
(88| }
Input	88} Ç
.
88Ç É
Id
88É Ö
)
88Ö Ü
)
88Ü á
)
88á à
;
88à â
if99 

(99 
request99 
==99 
null99 
||99 
request99 &
.99& '
Subject99' .
.99. /
GetSubjectId99/ ;
(99; <
)99< =
!=99> @
User99A E
.99E F
GetSubjectId99F R
(99R S
)99S T
)99T U
{:: 	
_logger;; 
.;; 
	InvalidId;; 
(;; 
Input;; #
.;;# $
Id;;$ &
);;& '
;;;' (
return<< 
RedirectToPage<< !
(<<! "
$str<<" 5
)<<5 6
;<<6 7
}== 	+
CompleteBackchannelLoginRequest?? '
???' (
result??) /
=??0 1
null??2 6
;??6 7
ifBB 

(BB 
InputBB 
.BB 
ButtonBB 
==BB 
$strBB  
)BB  !
{CC 	
resultDD 
=DD 
newDD +
CompleteBackchannelLoginRequestDD 8
(DD8 9
InputDD9 >
.DD> ?
IdDD? A
)DDA B
;DDB C
awaitGG 
_eventsGG 
.GG 

RaiseAsyncGG $
(GG$ %
newGG% (
ConsentDeniedEventGG) ;
(GG; <
UserGG< @
.GG@ A
GetSubjectIdGGA M
(GGM N
)GGN O
,GGO P
requestGGQ X
.GGX Y
ClientGGY _
.GG_ `
ClientIdGG` h
,GGh i
requestGGj q
.GGq r
ValidatedResources	GGr Ñ
.
GGÑ Ö
RawScopeValues
GGÖ ì
)
GGì î
)
GGî ï
;
GGï ñ
	TelemetryHH 
.HH 
MetricsHH 
.HH 
ConsentDeniedHH +
(HH+ ,
requestHH, 3
.HH3 4
ClientHH4 :
.HH: ;
ClientIdHH; C
,HHC D
requestHHE L
.HHL M
ValidatedResourcesHHM _
.HH_ `
ParsedScopesHH` l
.HHl m
SelectHHm s
(HHs t
sHHt u
=>HHv x
sHHy z
.HHz {

ParsedName	HH{ Ö
)
HHÖ Ü
)
HHÜ á
;
HHá à
}II 	
elseKK 
ifKK 
(KK 
InputKK 
.KK 
ButtonKK 
==KK  
$strKK! &
)KK& '
{LL 	
ifNN 
(NN 
InputNN 
.NN 
ScopesConsentedNN %
.NN% &
AnyNN& )
(NN) *
)NN* +
)NN+ ,
{OO 
varPP 
scopesPP 
=PP 
InputPP "
.PP" #
ScopesConsentedPP# 2
;PP2 3
ifQQ 
(QQ 
ConsentOptionsQQ "
.QQ" #
EnableOfflineAccessQQ# 6
==QQ7 9
falseQQ: ?
)QQ? @
{RR 
scopesSS 
=SS 
scopesSS #
.SS# $
WhereSS$ )
(SS) *
xSS* +
=>SS, .
xSS/ 0
!=SS1 3
DuendeSS4 :
.SS: ;
IdentityServerSS; I
.SSI J#
IdentityServerConstantsSSJ a
.SSa b
StandardScopesSSb p
.SSp q
OfflineAccessSSq ~
)SS~ 
;	SS Ä
}TT 
resultVV 
=VV 
newVV +
CompleteBackchannelLoginRequestVV <
(VV< =
InputVV= B
.VVB C
IdVVC E
)VVE F
{WW !
ScopesValuesConsentedXX )
=XX* +
scopesXX, 2
.XX2 3
ToArrayXX3 :
(XX: ;
)XX; <
,XX< =
DescriptionYY 
=YY  !
InputYY" '
.YY' (
DescriptionYY( 3
}ZZ 
;ZZ 
await]] 
_events]] 
.]] 

RaiseAsync]] (
(]]( )
new]]) ,
ConsentGrantedEvent]]- @
(]]@ A
User]]A E
.]]E F
GetSubjectId]]F R
(]]R S
)]]S T
,]]T U
request]]V ]
.]]] ^
Client]]^ d
.]]d e
ClientId]]e m
,]]m n
request]]o v
.]]v w
ValidatedResources	]]w â
.
]]â ä
RawScopeValues
]]ä ò
,
]]ò ô
result
]]ö †
.
]]† °#
ScopesValuesConsented
]]° ∂
,
]]∂ ∑
false
]]∏ Ω
)
]]Ω æ
)
]]æ ø
;
]]ø ¿
	Telemetry^^ 
.^^ 
Metrics^^ !
.^^! "
ConsentGranted^^" 0
(^^0 1
request^^1 8
.^^8 9
Client^^9 ?
.^^? @
ClientId^^@ H
,^^H I
result^^J P
.^^P Q!
ScopesValuesConsented^^Q f
,^^f g
false^^h m
)^^m n
;^^n o
var__ 
denied__ 
=__ 
request__ $
.__$ %
ValidatedResources__% 7
.__7 8
ParsedScopes__8 D
.__D E
Select__E K
(__K L
s__L M
=>__N P
s__Q R
.__R S

ParsedName__S ]
)__] ^
.__^ _
Except___ e
(__e f
result__f l
.__l m"
ScopesValuesConsented	__m Ç
)
__Ç É
;
__É Ñ
	Telemetry`` 
.`` 
Metrics`` !
.``! "
ConsentDenied``" /
(``/ 0
request``0 7
.``7 8
Client``8 >
.``> ?
ClientId``? G
,``G H
denied``I O
)``O P
;``P Q
}aa 
elsebb 
{cc 

ModelStatedd 
.dd 
AddModelErrordd (
(dd( )
$strdd) +
,dd+ ,
ConsentOptionsdd- ;
.dd; <%
MustChooseOneErrorMessagedd< U
)ddU V
;ddV W
}ee 
}ff 	
elsegg 
{hh 	

ModelStateii 
.ii 
AddModelErrorii $
(ii$ %
$strii% '
,ii' (
ConsentOptionsii) 7
.ii7 8(
InvalidSelectionErrorMessageii8 T
)iiT U
;iiU V
}jj 	
ifll 

(ll 
resultll 
!=ll 
nullll 
)ll 
{mm 	
awaitoo 
_interactionoo 
.oo %
CompleteLoginRequestAsyncoo 8
(oo8 9
resultoo9 ?
)oo? @
;oo@ A
returnqq 
RedirectToPageqq !
(qq! "
$strqq" -
)qq- .
;qq. /
}rr 	
ifuu 

(uu 
!uu 
awaituu 
SetViewModelAsyncuu $
(uu$ %
Inputuu% *
.uu* +
Iduu+ -
)uu- .
)uu. /
{vv 	
returnww 
RedirectToPageww !
(ww! "
$strww" 5
)ww5 6
;ww6 7
}xx 	
returnyy 
Pageyy 
(yy 
)yy 
;yy 
}zz 
private|| 
async|| 
Task|| 
<|| 
bool|| 
>|| 
SetViewModelAsync|| .
(||. /
string||/ 5
?||5 6
id||7 9
)||9 :
{}} !
ArgumentNullException~~ 
.~~ 
ThrowIfNull~~ )
(~~) *
id~~* ,
)~~, -
;~~- .
var
ÄÄ 
request
ÄÄ 
=
ÄÄ 
await
ÄÄ 
_interaction
ÄÄ (
.
ÄÄ( ).
 GetLoginRequestByInternalIdAsync
ÄÄ) I
(
ÄÄI J
id
ÄÄJ L
)
ÄÄL M
;
ÄÄM N
if
ÅÅ 

(
ÅÅ 
request
ÅÅ 
!=
ÅÅ 
null
ÅÅ 
&&
ÅÅ 
request
ÅÅ &
.
ÅÅ& '
Subject
ÅÅ' .
.
ÅÅ. /
GetSubjectId
ÅÅ/ ;
(
ÅÅ; <
)
ÅÅ< =
==
ÅÅ> @
User
ÅÅA E
.
ÅÅE F
GetSubjectId
ÅÅF R
(
ÅÅR S
)
ÅÅS T
)
ÅÅT U
{
ÇÇ 	
View
ÉÉ 
=
ÉÉ $
CreateConsentViewModel
ÉÉ )
(
ÉÉ) *
request
ÉÉ* 1
)
ÉÉ1 2
;
ÉÉ2 3
return
ÑÑ 
true
ÑÑ 
;
ÑÑ 
}
ÖÖ 	
else
ÜÜ 
{
áá 	
_logger
àà 
.
àà /
!NoMatchingBackchannelLoginRequest
àà 5
(
àà5 6
id
àà6 8
)
àà8 9
;
àà9 :
return
ââ 
false
ââ 
;
ââ 
}
ää 	
}
ãã 
private
çç 
	ViewModel
çç $
CreateConsentViewModel
çç ,
(
çç, -)
BackchannelUserLoginRequest
çç- H
request
ççI P
)
ççP Q
{
éé 
var
èè 
vm
èè 
=
èè 
new
èè 
	ViewModel
èè 
{
êê 	

ClientName
ëë 
=
ëë 
request
ëë  
.
ëë  !
Client
ëë! '
.
ëë' (

ClientName
ëë( 2
??
ëë3 5
request
ëë6 =
.
ëë= >
Client
ëë> D
.
ëëD E
ClientId
ëëE M
,
ëëM N
	ClientUrl
íí 
=
íí 
request
íí 
.
íí  
Client
íí  &
.
íí& '
	ClientUri
íí' 0
,
íí0 1
ClientLogoUrl
ìì 
=
ìì 
request
ìì #
.
ìì# $
Client
ìì$ *
.
ìì* +
LogoUri
ìì+ 2
,
ìì2 3
BindingMessage
îî 
=
îî 
request
îî $
.
îî$ %
BindingMessage
îî% 3
}
ïï 	
;
ïï	 

vm
óó 

.
óó
 
IdentityScopes
óó 
=
óó 
request
óó #
.
óó# $ 
ValidatedResources
óó$ 6
.
óó6 7
	Resources
óó7 @
.
óó@ A
IdentityResources
óóA R
.
òò 
Select
òò 
(
òò 
x
òò 
=>
òò "
CreateScopeViewModel
òò -
(
òò- .
x
òò. /
,
òò/ 0
Input
òò1 6
==
òò7 9
null
òò: >
||
òò? A
Input
òòB G
.
òòG H
ScopesConsented
òòH W
.
òòW X
Contains
òòX `
(
òò` a
x
òòa b
.
òòb c
Name
òòc g
)
òòg h
)
òòh i
)
òòi j
.
ôô 
ToArray
ôô 
(
ôô 
)
ôô 
;
ôô 
var
õõ  
resourceIndicators
õõ 
=
õõ  
request
õõ! (
.
õõ( ))
RequestedResourceIndicators
õõ) D
??
õõE G

Enumerable
õõH R
.
õõR S
Empty
õõS X
<
õõX Y
string
õõY _
>
õõ_ `
(
õõ` a
)
õõa b
;
õõb c
var
úú 
apiResources
úú 
=
úú 
request
úú "
.
úú" # 
ValidatedResources
úú# 5
.
úú5 6
	Resources
úú6 ?
.
úú? @
ApiResources
úú@ L
.
úúL M
Where
úúM R
(
úúR S
x
úúS T
=>
úúU W 
resourceIndicators
úúX j
.
úúj k
Contains
úúk s
(
úús t
x
úút u
.
úúu v
Name
úúv z
)
úúz {
)
úú{ |
;
úú| }
var
ûû 
	apiScopes
ûû 
=
ûû 
new
ûû 
List
ûû  
<
ûû  !
ScopeViewModel
ûû! /
>
ûû/ 0
(
ûû0 1
)
ûû1 2
;
ûû2 3
foreach
üü 
(
üü 
var
üü 
parsedScope
üü  
in
üü! #
request
üü$ +
.
üü+ , 
ValidatedResources
üü, >
.
üü> ?
ParsedScopes
üü? K
)
üüK L
{
†† 	
var
°° 
apiScope
°° 
=
°° 
request
°° "
.
°°" # 
ValidatedResources
°°# 5
.
°°5 6
	Resources
°°6 ?
.
°°? @
FindApiScope
°°@ L
(
°°L M
parsedScope
°°M X
.
°°X Y

ParsedName
°°Y c
)
°°c d
;
°°d e
if
¢¢ 
(
¢¢ 
apiScope
¢¢ 
!=
¢¢ 
null
¢¢  
)
¢¢  !
{
££ 
var
§§ 
scopeVm
§§ 
=
§§ "
CreateScopeViewModel
§§ 2
(
§§2 3
parsedScope
§§3 >
,
§§> ?
apiScope
§§@ H
,
§§H I
Input
§§J O
==
§§P R
null
§§S W
||
§§X Z
Input
§§[ `
.
§§` a
ScopesConsented
§§a p
.
§§p q
Contains
§§q y
(
§§y z
parsedScope§§z Ö
.§§Ö Ü
RawValue§§Ü é
)§§é è
)§§è ê
;§§ê ë
scopeVm
•• 
.
•• 
	Resources
•• !
=
••" #
apiResources
••$ 0
.
••0 1
Where
••1 6
(
••6 7
x
••7 8
=>
••9 ;
x
••< =
.
••= >
Scopes
••> D
.
••D E
Contains
••E M
(
••M N
parsedScope
••N Y
.
••Y Z

ParsedName
••Z d
)
••d e
)
••e f
.
¶¶ 
Select
¶¶ 
(
¶¶ 
x
¶¶ 
=>
¶¶  
new
¶¶! $
ResourceViewModel
¶¶% 6
{
ßß 
Name
®® 
=
®® 
x
®®  
.
®®  !
Name
®®! %
,
®®% &
DisplayName
©© #
=
©©$ %
x
©©& '
.
©©' (
DisplayName
©©( 3
??
©©4 6
x
©©7 8
.
©©8 9
Name
©©9 =
,
©©= >
}
™™ 
)
™™ 
.
™™ 
ToArray
™™ 
(
™™ 
)
™™  
;
™™  !
	apiScopes
´´ 
.
´´ 
Add
´´ 
(
´´ 
scopeVm
´´ %
)
´´% &
;
´´& '
}
¨¨ 
}
≠≠ 	
if
ÆÆ 

(
ÆÆ 
ConsentOptions
ÆÆ 
.
ÆÆ !
EnableOfflineAccess
ÆÆ .
&&
ÆÆ/ 1
request
ÆÆ2 9
.
ÆÆ9 : 
ValidatedResources
ÆÆ: L
.
ÆÆL M
	Resources
ÆÆM V
.
ÆÆV W
OfflineAccess
ÆÆW d
)
ÆÆd e
{
ØØ 	
	apiScopes
∞∞ 
.
∞∞ 
Add
∞∞ 
(
∞∞ #
GetOfflineAccessScope
∞∞ /
(
∞∞/ 0
Input
∞∞0 5
==
∞∞6 8
null
∞∞9 =
||
∞∞> @
Input
∞∞A F
.
∞∞F G
ScopesConsented
∞∞G V
.
∞∞V W
Contains
∞∞W _
(
∞∞_ `
Duende
∞∞` f
.
∞∞f g
IdentityServer
∞∞g u
.
∞∞u v&
IdentityServerConstants∞∞v ç
.∞∞ç é
StandardScopes∞∞é ú
.∞∞ú ù
OfflineAccess∞∞ù ™
)∞∞™ ´
)∞∞´ ¨
)∞∞¨ ≠
;∞∞≠ Æ
}
±± 	
vm
≤≤ 

.
≤≤
 
	ApiScopes
≤≤ 
=
≤≤ 
	apiScopes
≤≤  
;
≤≤  !
return
¥¥ 
vm
¥¥ 
;
¥¥ 
}
µµ 
private
∑∑ 
static
∑∑ 
ScopeViewModel
∑∑ !"
CreateScopeViewModel
∑∑" 6
(
∑∑6 7
IdentityResource
∑∑7 G
identity
∑∑H P
,
∑∑P Q
bool
∑∑R V
check
∑∑W \
)
∑∑\ ]
{
∏∏ 
return
ππ 
new
ππ 
ScopeViewModel
ππ !
{
∫∫ 	
Name
ªª 
=
ªª 
identity
ªª 
.
ªª 
Name
ªª  
,
ªª  !
Value
ºº 
=
ºº 
identity
ºº 
.
ºº 
Name
ºº !
,
ºº! "
DisplayName
ΩΩ 
=
ΩΩ 
identity
ΩΩ "
.
ΩΩ" #
DisplayName
ΩΩ# .
??
ΩΩ/ 1
identity
ΩΩ2 :
.
ΩΩ: ;
Name
ΩΩ; ?
,
ΩΩ? @
Description
ææ 
=
ææ 
identity
ææ "
.
ææ" #
Description
ææ# .
,
ææ. /
	Emphasize
øø 
=
øø 
identity
øø  
.
øø  !
	Emphasize
øø! *
,
øø* +
Required
¿¿ 
=
¿¿ 
identity
¿¿ 
.
¿¿  
Required
¿¿  (
,
¿¿( )
Checked
¡¡ 
=
¡¡ 
check
¡¡ 
||
¡¡ 
identity
¡¡ '
.
¡¡' (
Required
¡¡( 0
}
¬¬ 	
;
¬¬	 

}
√√ 
private
≈≈ 
static
≈≈ 
ScopeViewModel
≈≈ !"
CreateScopeViewModel
≈≈" 6
(
≈≈6 7
ParsedScopeValue
≈≈7 G
parsedScopeValue
≈≈H X
,
≈≈X Y
ApiScope
≈≈Z b
apiScope
≈≈c k
,
≈≈k l
bool
≈≈m q
check
≈≈r w
)
≈≈w x
{
∆∆ 
var
«« 
displayName
«« 
=
«« 
apiScope
«« "
.
««" #
DisplayName
««# .
??
««/ 1
apiScope
««2 :
.
««: ;
Name
««; ?
;
««? @
if
»» 

(
»» 
!
»» 
String
»» 
.
»»  
IsNullOrWhiteSpace
»» &
(
»»& '
parsedScopeValue
»»' 7
.
»»7 8
ParsedParameter
»»8 G
)
»»G H
)
»»H I
{
…… 	
displayName
   
+=
   
$str
   
+
    
parsedScopeValue
  ! 1
.
  1 2
ParsedParameter
  2 A
;
  A B
}
ÀÀ 	
return
ÕÕ 
new
ÕÕ 
ScopeViewModel
ÕÕ !
{
ŒŒ 	
Name
œœ 
=
œœ 
parsedScopeValue
œœ #
.
œœ# $

ParsedName
œœ$ .
,
œœ. /
Value
–– 
=
–– 
parsedScopeValue
–– $
.
––$ %
RawValue
––% -
,
––- .
DisplayName
—— 
=
—— 
displayName
—— %
,
——% &
Description
““ 
=
““ 
apiScope
““ "
.
““" #
Description
““# .
,
““. /
	Emphasize
”” 
=
”” 
apiScope
””  
.
””  !
	Emphasize
””! *
,
””* +
Required
‘‘ 
=
‘‘ 
apiScope
‘‘ 
.
‘‘  
Required
‘‘  (
,
‘‘( )
Checked
’’ 
=
’’ 
check
’’ 
||
’’ 
apiScope
’’ '
.
’’' (
Required
’’( 0
}
÷÷ 	
;
÷÷	 

}
◊◊ 
private
ŸŸ 
static
ŸŸ 
ScopeViewModel
ŸŸ !#
GetOfflineAccessScope
ŸŸ" 7
(
ŸŸ7 8
bool
ŸŸ8 <
check
ŸŸ= B
)
ŸŸB C
{
⁄⁄ 
return
€€ 
new
€€ 
ScopeViewModel
€€ !
{
‹‹ 	
Value
›› 
=
›› 
Duende
›› 
.
›› 
IdentityServer
›› )
.
››) *%
IdentityServerConstants
››* A
.
››A B
StandardScopes
››B P
.
››P Q
OfflineAccess
››Q ^
,
››^ _
DisplayName
ﬁﬁ 
=
ﬁﬁ 
ConsentOptions
ﬁﬁ (
.
ﬁﬁ( )&
OfflineAccessDisplayName
ﬁﬁ) A
,
ﬁﬁA B
Description
ﬂﬂ 
=
ﬂﬂ 
ConsentOptions
ﬂﬂ (
.
ﬂﬂ( )&
OfflineAccessDescription
ﬂﬂ) A
,
ﬂﬂA B
	Emphasize
‡‡ 
=
‡‡ 
true
‡‡ 
,
‡‡ 
Checked
·· 
=
·· 
check
·· 
}
‚‚ 	
;
‚‚	 

}
„„ 
}‰‰ ≠	
mC:\netMentoring\04_layered_architectures\CartServiceConsoleApp\IdentityServerApi\Pages\Ciba\ConsentOptions.cs
	namespace 	
IdentityServerApi
 
. 
Pages !
.! "
Ciba" &
;& '
public 
static 
class 
ConsentOptions "
{ 
public 

static 
readonly 
bool 
EnableOfflineAccess  3
=4 5
true6 :
;: ;
public		 

static		 
readonly		 
string		 !$
OfflineAccessDisplayName		" :
=		; <
$str		= M
;		M N
public

 

static

 
readonly

 
string

 !$
OfflineAccessDescription

" :
=

; <
$str	

= É
;


É Ñ
public 

static 
readonly 
string !%
MustChooseOneErrorMessage" ;
=< =
$str> e
;e f
public 

static 
readonly 
string !(
InvalidSelectionErrorMessage" >
=? @
$strA T
;T U
} Ô
iC:\netMentoring\04_layered_architectures\CartServiceConsoleApp\IdentityServerApi\Pages\Ciba\All.cshtml.cs
	namespace		 	
IdentityServerApi		
 
.		 
Pages		 !
.		! "
Ciba		" &
;		& '
[ 
SecurityHeaders 
] 
[ 
	Authorize 

]
 
public 
class 
AllModel 
: 
	PageModel !
{ 
public 

IEnumerable 
< '
BackchannelUserLoginRequest 2
>2 3
Logins4 :
{; <
get= @
;@ A
setB E
;E F
}G H
=I J
defaultK R
!R S
;S T
private 
readonly 8
,IBackchannelAuthenticationInteractionService A1
%_backchannelAuthenticationInteractionB g
;g h
public 

AllModel 
( 8
,IBackchannelAuthenticationInteractionService @7
+backchannelAuthenticationInteractionServiceA l
)l m
{ 1
%_backchannelAuthenticationInteraction -
=. /7
+backchannelAuthenticationInteractionService0 [
;[ \
} 
public 

async 
Task 
OnGet 
( 
) 
{ 
Logins 
= 
await 1
%_backchannelAuthenticationInteraction <
.< =6
*GetPendingLoginRequestsForCurrentUserAsync= g
(g h
)h i
;i j
} 
} ∏
vC:\netMentoring\04_layered_architectures\CartServiceConsoleApp\IdentityServerApi\Pages\Account\Logout\LogoutOptions.cs
	namespace 	
IdentityServerApi
 
. 
Pages !
.! "
Logout" (
;( )
public 
static 
class 
LogoutOptions !
{ 
public		 

static		 
readonly		 
bool		 
ShowLogoutPrompt		  0
=		1 2
true		3 7
;		7 8
public

 

static

 
readonly

 
bool

 )
AutomaticRedirectAfterSignOut

  =
=

> ?
false

@ E
;

E F
} ´
{C:\netMentoring\04_layered_architectures\CartServiceConsoleApp\IdentityServerApi\Pages\Account\Logout\LoggedOutViewModel.cs
	namespace 	
IdentityServerApi
 
. 
Pages !
.! "
Logout" (
;( )
public		 
class		 
LoggedOutViewModel		 
{

 
public 

string 
? !
PostLogoutRedirectUri (
{) *
get+ .
;. /
set0 3
;3 4
}5 6
public 

string 
? 

ClientName 
{ 
get  #
;# $
set% (
;( )
}* +
public 

string 
? 
SignOutIframeUrl #
{$ %
get& )
;) *
set+ .
;. /
}0 1
public 

bool )
AutomaticRedirectAfterSignOut -
{. /
get0 3
;3 4
set5 8
;8 9
}: ;
} œ
yC:\netMentoring\04_layered_architectures\CartServiceConsoleApp\IdentityServerApi\Pages\Account\Logout\LoggedOut.cshtml.cs
	namespace 	
IdentityServerApi
 
. 
Pages !
.! "
Logout" (
;( )
[

 
SecurityHeaders

 
]

 
[ 
AllowAnonymous 
] 
public 
class 
	LoggedOut 
: 
	PageModel "
{ 
private 
readonly -
!IIdentityServerInteractionService 6
_interactionService7 J
;J K
public 

LoggedOutViewModel 
View "
{# $
get% (
;( )
set* -
;- .
}/ 0
=1 2
default3 :
!: ;
;; <
public 

	LoggedOut 
( -
!IIdentityServerInteractionService 6
interactionService7 I
)I J
{ 
_interactionService 
= 
interactionService 0
;0 1
} 
public 

async 
Task 
OnGet 
( 
string "
?" #
logoutId$ ,
), -
{ 
var 
logout 
= 
await 
_interactionService .
.. /!
GetLogoutContextAsync/ D
(D E
logoutIdE M
)M N
;N O
View 
= 
new 
LoggedOutViewModel %
{ 	)
AutomaticRedirectAfterSignOut )
=* +
LogoutOptions, 9
.9 :)
AutomaticRedirectAfterSignOut: W
,W X!
PostLogoutRedirectUri !
=" #
logout$ *
?* +
.+ ,!
PostLogoutRedirectUri, A
,A B

ClientName   
=   
String   
.    
IsNullOrEmpty    -
(  - .
logout  . 4
?  4 5
.  5 6

ClientName  6 @
)  @ A
?  B C
logout  D J
?  J K
.  K L
ClientId  L T
:  U V
logout  W ]
?  ] ^
.  ^ _

ClientName  _ i
,  i j
SignOutIframeUrl!! 
=!! 
logout!! %
?!!% &
.!!& '
SignOutIFrameUrl!!' 7
}"" 	
;""	 

}## 
}$$ ˇ0
uC:\netMentoring\04_layered_architectures\CartServiceConsoleApp\IdentityServerApi\Pages\Account\Logout\Index.cshtml.cs
	namespace 	
IdentityServerApi
 
. 
Pages !
.! "
Logout" (
;( )
[ 
SecurityHeaders 
] 
[ 
AllowAnonymous 
] 
public 
class 
Index 
: 
	PageModel 
{ 
private 
readonly 
SignInManager "
<" #
ApplicationUser# 2
>2 3
_signInManager4 B
;B C
private 
readonly -
!IIdentityServerInteractionService 6
_interaction7 C
;C D
private 
readonly 
IEventService "
_events# *
;* +
[ 
BindProperty 
] 
public 

string 
? 
LogoutId 
{ 
get !
;! "
set# &
;& '
}( )
public 

Index 
( 
SignInManager 
< 
ApplicationUser .
>. /
signInManager0 =
,= >-
!IIdentityServerInteractionService? `
interactiona l
,l m
IEventServicen {
events	| Ç
)
Ç É
{ 
_signInManager 
= 
signInManager &
;& '
_interaction 
= 
interaction "
;" #
_events   
=   
events   
;   
}!! 
public## 

async## 
Task## 
<## 
IActionResult## #
>### $
OnGet##% *
(##* +
string##+ 1
?##1 2
logoutId##3 ;
)##; <
{$$ 
LogoutId%% 
=%% 
logoutId%% 
;%% 
var'' 
showLogoutPrompt'' 
='' 
LogoutOptions'' ,
.'', -
ShowLogoutPrompt''- =
;''= >
if)) 

()) 
User)) 
.)) 
Identity)) 
?)) 
.)) 
IsAuthenticated)) *
!=))+ -
true)). 2
)))2 3
{** 	
showLogoutPrompt,, 
=,, 
false,, $
;,,$ %
}-- 	
else.. 
{// 	
var00 
context00 
=00 
await00 
_interaction00  ,
.00, -!
GetLogoutContextAsync00- B
(00B C
LogoutId00C K
)00K L
;00L M
if11 
(11 
context11 
?11 
.11 
ShowSignoutPrompt11 *
==11+ -
false11. 3
)113 4
{22 
showLogoutPrompt44  
=44! "
false44# (
;44( )
}55 
}66 	
if88 

(88 
showLogoutPrompt88 
==88 
false88  %
)88% &
{99 	
return<< 
await<< 
OnPost<< 
(<<  
)<<  !
;<<! "
}== 	
return?? 
Page?? 
(?? 
)?? 
;?? 
}@@ 
publicBB 

asyncBB 
TaskBB 
<BB 
IActionResultBB #
>BB# $
OnPostBB% +
(BB+ ,
)BB, -
{CC 
ifDD 

(DD 
UserDD 
.DD 
IdentityDD 
?DD 
.DD 
IsAuthenticatedDD *
==DD+ -
trueDD. 2
)DD2 3
{EE 	
LogoutIdII 
??=II 
awaitII 
_interactionII +
.II+ ,$
CreateLogoutContextAsyncII, D
(IID E
)IIE F
;IIF G
awaitLL 
_signInManagerLL  
.LL  !
SignOutAsyncLL! -
(LL- .
)LL. /
;LL/ 0
varOO 
idpOO 
=OO 
UserOO 
.OO 
	FindFirstOO $
(OO$ %
JwtClaimTypesOO% 2
.OO2 3
IdentityProviderOO3 C
)OOC D
?OOD E
.OOE F
ValueOOF K
;OOK L
awaitRR 
_eventsRR 
.RR 

RaiseAsyncRR $
(RR$ %
newRR% ("
UserLogoutSuccessEventRR) ?
(RR? @
UserRR@ D
.RRD E
GetSubjectIdRRE Q
(RRQ R
)RRR S
,RRS T
UserRRU Y
.RRY Z
GetDisplayNameRRZ h
(RRh i
)RRi j
)RRj k
)RRk l
;RRl m
	TelemetrySS 
.SS 
MetricsSS 
.SS 

UserLogoutSS (
(SS( )
idpSS) ,
)SS, -
;SS- .
ifVV 
(VV 
idpVV 
!=VV 
nullVV 
&&VV 
idpVV "
!=VV# %
DuendeVV& ,
.VV, -
IdentityServerVV- ;
.VV; <#
IdentityServerConstantsVV< S
.VVS T!
LocalIdentityProviderVVT i
)VVi j
{WW 
ifYY 
(YY 
awaitYY 
HttpContextYY %
.YY% &)
GetSchemeSupportsSignOutAsyncYY& C
(YYC D
idpYYD G
)YYG H
)YYH I
{ZZ 
var^^ 
url^^ 
=^^ 
Url^^ !
.^^! "
Page^^" &
(^^& '
$str^^' B
,^^B C
new^^D G
{^^H I
logoutId^^J R
=^^S T
LogoutId^^U ]
}^^^ _
)^^_ `
;^^` a
returnaa 
SignOutaa "
(aa" #
newaa# &$
AuthenticationPropertiesaa' ?
{aa@ A
RedirectUriaaB M
=aaN O
urlaaP S
}aaT U
,aaU V
idpaaW Z
)aaZ [
;aa[ \
}bb 
}cc 
}dd 	
returnff 
RedirectToPageff 
(ff 
$strff 9
,ff9 :
newff; >
{ff? @
logoutIdffA I
=ffJ K
LogoutIdffL T
}ffU V
)ffV W
;ffW X
}gg 
}hh Å
qC:\netMentoring\04_layered_architectures\CartServiceConsoleApp\IdentityServerApi\Pages\Account\Login\ViewModel.cs
	namespace 	
IdentityServerApi
 
. 
Pages !
.! "
Login" '
;' (
public 
class 
	ViewModel 
{ 
public 

bool 
AllowRememberLogin "
{# $
get% (
;( )
set* -
;- .
}/ 0
=1 2
true3 7
;7 8
public		 

bool		 
EnableLocalLogin		  
{		! "
get		# &
;		& '
set		( +
;		+ ,
}		- .
=		/ 0
true		1 5
;		5 6
public 

IEnumerable 
< 
	ViewModel  
.  !
ExternalProvider! 1
>1 2
ExternalProviders3 D
{E F
getG J
;J K
setL O
;O P
}Q R
=S T

EnumerableU _
._ `
Empty` e
<e f
ExternalProviderf v
>v w
(w x
)x y
;y z
public 

IEnumerable 
< 
	ViewModel  
.  !
ExternalProvider! 1
>1 2$
VisibleExternalProviders3 K
=>L N
ExternalProvidersO `
.` a
Wherea f
(f g
xg h
=>i k
!l m
Stringm s
.s t
IsNullOrWhiteSpace	t Ü
(
Ü á
x
á à
.
à â
DisplayName
â î
)
î ï
)
ï ñ
;
ñ ó
public 

bool 
IsExternalLoginOnly #
=>$ &
EnableLocalLogin' 7
==8 :
false; @
&&A C
ExternalProvidersD U
?U V
.V W
CountW \
(\ ]
)] ^
==_ a
$numb c
;c d
public 

string 
? 
ExternalLoginScheme &
=>' )
IsExternalLoginOnly* =
?> ?
ExternalProviders@ Q
?Q R
.R S
SingleOrDefaultS b
(b c
)c d
?d e
.e f 
AuthenticationSchemef z
:{ |
null	} Å
;
Å Ç
public 

class 
ExternalProvider !
{ 
public 
ExternalProvider 
(  
string  & 
authenticationScheme' ;
,; <
string= C
?C D
displayNameE P
=Q R
nullS W
)W X
{ 	 
AuthenticationScheme  
=! " 
authenticationScheme# 7
;7 8
DisplayName 
= 
displayName %
;% &
} 	
public 
string 
? 
DisplayName "
{# $
get% (
;( )
set* -
;- .
}/ 0
public 
string  
AuthenticationScheme *
{+ ,
get- 0
;0 1
set2 5
;5 6
}7 8
} 
} ◊
tC:\netMentoring\04_layered_architectures\CartServiceConsoleApp\IdentityServerApi\Pages\Account\Login\LoginOptions.cs
	namespace 	
IdentityServerApi
 
. 
Pages !
.! "
Login" '
;' (
public 
static 
class 
LoginOptions  
{ 
public 

static 
readonly 
bool 
AllowLocalLogin  /
=0 1
true2 6
;6 7
public		 

static		 
readonly		 
bool		 
AllowRememberLogin		  2
=		3 4
true		5 9
;		9 :
public

 

static

 
readonly

 
TimeSpan

 ##
RememberMeLoginDuration

$ ;
=

< =
TimeSpan

> F
.

F G
FromDays

G O
(

O P
$num

P R
)

R S
;

S T
public 

static 
readonly 
string !*
InvalidCredentialsErrorMessage" @
=A B
$strC a
;a b
} Ñ

rC:\netMentoring\04_layered_architectures\CartServiceConsoleApp\IdentityServerApi\Pages\Account\Login\InputModel.cs
	namespace 	
IdentityServerApi
 
. 
Pages !
.! "
Login" '
;' (
public 
class 

InputModel 
{		 
[

 
Required

 
]

 
public 

string 
? 
Username 
{ 
get !
;! "
set# &
;& '
}( )
[ 
Required 
] 
public 

string 
? 
Password 
{ 
get !
;! "
set# &
;& '
}( )
public 

bool 
RememberLogin 
{ 
get  #
;# $
set% (
;( )
}* +
public 

string 
? 
	ReturnUrl 
{ 
get "
;" #
set$ '
;' (
}) *
public 

string 
? 
Button 
{ 
get 
;  
set! $
;$ %
}& '
} €ù
tC:\netMentoring\04_layered_architectures\CartServiceConsoleApp\IdentityServerApi\Pages\Account\Login\Index.cshtml.cs
	namespace 	
IdentityServerApi
 
. 
Pages !
.! "
Login" '
;' (
[ 
SecurityHeaders 
] 
[ 
AllowAnonymous 
] 
public 
class 
Index 
: 
	PageModel 
{ 
private 
readonly 
UserManager  
<  !
ApplicationUser! 0
>0 1
_userManager2 >
;> ?
private 
readonly 
SignInManager "
<" #
ApplicationUser# 2
>2 3
_signInManager4 B
;B C
private 
readonly -
!IIdentityServerInteractionService 6
_interaction7 C
;C D
private 
readonly 
IEventService "
_events# *
;* +
private 
readonly )
IAuthenticationSchemeProvider 2
_schemeProvider3 B
;B C
private 
readonly "
IIdentityProviderStore +"
_identityProviderStore, B
;B C
public 

	ViewModel 
View 
{ 
get 
;  
set! $
;$ %
}& '
=( )
default* 1
!1 2
;2 3
[ 
BindProperty 
] 
public   


InputModel   
Input   
{   
get   !
;  ! "
set  # &
;  & '
}  ( )
=  * +
default  , 3
!  3 4
;  4 5
public"" 

Index"" 
("" -
!IIdentityServerInteractionService## )
interaction##* 5
,##5 6)
IAuthenticationSchemeProvider$$ %
schemeProvider$$& 4
,$$4 5"
IIdentityProviderStore%% !
identityProviderStore%% 4
,%%4 5
IEventService&& 
events&& 
,&& 
UserManager'' 
<'' 
ApplicationUser'' #
>''# $
userManager''% 0
,''0 1
SignInManager(( 
<(( 
ApplicationUser(( %
>((% &
signInManager((' 4
)((4 5
{)) 
_userManager** 
=** 
userManager** "
;**" #
_signInManager++ 
=++ 
signInManager++ &
;++& '
_interaction,, 
=,, 
interaction,, "
;,," #
_schemeProvider-- 
=-- 
schemeProvider-- (
;--( )"
_identityProviderStore.. 
=..  !
identityProviderStore..! 6
;..6 7
_events// 
=// 
events// 
;// 
}00 
public22 

async22 
Task22 
<22 
IActionResult22 #
>22# $
OnGet22% *
(22* +
string22+ 1
?221 2
	returnUrl223 <
)22< =
{33 
await44 
BuildModelAsync44 
(44 
	returnUrl44 '
)44' (
;44( )
if66 

(66 
View66 
.66 
IsExternalLoginOnly66 $
)66$ %
{77 	
return99 
RedirectToPage99 !
(99! "
$str99" <
,99< =
new99> A
{99B C
scheme99D J
=99K L
View99M Q
.99Q R
ExternalLoginScheme99R e
,99e f
	returnUrl99g p
}99q r
)99r s
;99s t
}:: 	
return<< 
Page<< 
(<< 
)<< 
;<< 
}== 
public?? 

async?? 
Task?? 
<?? 
IActionResult?? #
>??# $
OnPost??% +
(??+ ,
)??, -
{@@ 
varAA 
contextAA 
=AA 
awaitAA 
_interactionAA (
.AA( )(
GetAuthorizationContextAsyncAA) E
(AAE F
InputAAF K
.AAK L
	ReturnUrlAAL U
)AAU V
;AAV W
ifCC 

(CC 
InputCC 
.CC 
ButtonCC 
!=CC 
$strCC #
)CC# $
{DD 	
returnEE 
awaitEE 
HandleCancelEE %
(EE% &
contextEE& -
)EE- .
;EE. /
}FF 	
ifHH 

(HH 
!HH 

ModelStateHH 
.HH 
IsValidHH 
)HH  
{II 	
awaitJJ 
BuildModelAsyncJJ !
(JJ! "
InputJJ" '
.JJ' (
	ReturnUrlJJ( 1
)JJ1 2
;JJ2 3
returnKK 
PageKK 
(KK 
)KK 
;KK 
}LL 	
returnNN 
awaitNN 
HandleLoginNN  
(NN  !
contextNN! (
)NN( )
;NN) *
}OO 
privateQQ 
asyncQQ 
TaskQQ 
<QQ 
IActionResultQQ $
>QQ$ %
HandleCancelQQ& 2
(QQ2 3 
AuthorizationRequestQQ3 G
?QQG H
contextQQI P
)QQP Q
{RR 
ifSS 

(SS 
contextSS 
==SS 
nullSS 
)SS 
{TT 	
returnUU 
RedirectUU 
(UU 
$strUU  
)UU  !
;UU! "
}VV 	!
ArgumentNullExceptionXX 
.XX 
ThrowIfNullXX )
(XX) *
InputXX* /
.XX/ 0
	ReturnUrlXX0 9
,XX9 :
nameofXX; A
(XXA B
InputXXB G
.XXG H
	ReturnUrlXXH Q
)XXQ R
)XXR S
;XXS T
awaitYY 
_interactionYY 
.YY "
DenyAuthorizationAsyncYY 1
(YY1 2
contextYY2 9
,YY9 :
AuthorizationErrorYY; M
.YYM N
AccessDeniedYYN Z
)YYZ [
;YY[ \
return[[ 
RedirectToReturnUrl[[ "
([[" #
context[[# *
,[[* +
Input[[, 1
.[[1 2
	ReturnUrl[[2 ;
)[[; <
;[[< =
}\\ 
private^^ 
async^^ 
Task^^ 
<^^ 
IActionResult^^ $
>^^$ %
HandleLogin^^& 1
(^^1 2 
AuthorizationRequest^^2 F
?^^F G
context^^H O
)^^O P
{__ 
var`` 
result`` 
=`` 
await`` 
_signInManager`` )
.``) *
PasswordSignInAsync``* =
(``= >
Input``> C
.``C D
Username``D L
!``L M
,``M N
Input``O T
.``T U
Password``U ]
!``] ^
,``^ _
Input``` e
.``e f
RememberLogin``f s
,``s t
lockoutOnFailure	``u Ö
:
``Ö Ü
true
``á ã
)
``ã å
;
``å ç
ifaa 

(aa 
!aa 
resultaa 
.aa 
	Succeededaa 
)aa 
{bb 	
awaitcc 
LogLoginFailurecc !
(cc! "
contextcc" )
)cc) *
;cc* +
awaitdd 
BuildModelAsyncdd !
(dd! "
Inputdd" '
.dd' (
	ReturnUrldd( 1
)dd1 2
;dd2 3
returnee 
Pageee 
(ee 
)ee 
;ee 
}ff 	
varhh 
userhh 
=hh 
awaithh 
_userManagerhh %
.hh% &
FindByNameAsynchh& 5
(hh5 6
Inputhh6 ;
.hh; <
Usernamehh< D
!hhD E
)hhE F
;hhF G
awaitii 
LogLoginSuccessii 
(ii 
contextii %
,ii% &
userii' +
!ii+ ,
)ii, -
;ii- .
returnjj 
awaitjj 
RedirectAfterLoginjj '
(jj' (
contextjj( /
)jj/ 0
;jj0 1
}kk 
privatemm 
asyncmm 
Taskmm 
LogLoginFailuremm &
(mm& ' 
AuthorizationRequestmm' ;
?mm; <
contextmm= D
)mmD E
{nn 
constoo 
stringoo 
erroroo 
=oo 
$stroo 2
;oo2 3
awaitpp 
_eventspp 
.pp 

RaiseAsyncpp  
(pp  !
newpp! $!
UserLoginFailureEventpp% :
(pp: ;
Inputpp; @
.pp@ A
UsernameppA I
,ppI J
errorppK P
,ppP Q
clientIdppR Z
:ppZ [
contextpp\ c
?ppc d
.ppd e
Clientppe k
.ppk l
ClientIdppl t
)ppt u
)ppu v
;ppv w
	Telemetryqq 
.qq 
Metricsqq 
.qq 
UserLoginFailureqq *
(qq* +
contextqq+ 2
?qq2 3
.qq3 4
Clientqq4 :
.qq: ;
ClientIdqq; C
,qqC D#
IdentityServerConstantsqqE \
.qq\ ]!
LocalIdentityProviderqq] r
,qqr s
errorqqt y
)qqy z
;qqz {

ModelStaterr 
.rr 
AddModelErrorrr  
(rr  !
stringrr! '
.rr' (
Emptyrr( -
,rr- .
LoginOptionsrr/ ;
.rr; <*
InvalidCredentialsErrorMessagerr< Z
)rrZ [
;rr[ \
}ss 
privateuu 
asyncuu 
Taskuu 
LogLoginSuccessuu &
(uu& ' 
AuthorizationRequestuu' ;
?uu; <
contextuu= D
,uuD E
ApplicationUseruuF U
useruuV Z
)uuZ [
{vv 
awaitww 
_eventsww 
.ww 

RaiseAsyncww  
(ww  !
newww! $!
UserLoginSuccessEventww% :
(ww: ;
userww; ?
.ww? @
UserNameww@ H
,wwH I
userwwJ N
.wwN O
IdwwO Q
,wwQ R
userwwS W
.wwW X
UserNamewwX `
,ww` a
clientIdwwb j
:wwj k
contextwwl s
?wws t
.wwt u
Clientwwu {
.ww{ |
ClientId	ww| Ñ
)
wwÑ Ö
)
wwÖ Ü
;
wwÜ á
	Telemetryxx 
.xx 
Metricsxx 
.xx 
	UserLoginxx #
(xx# $
contextxx$ +
?xx+ ,
.xx, -
Clientxx- 3
.xx3 4
ClientIdxx4 <
,xx< =#
IdentityServerConstantsxx> U
.xxU V!
LocalIdentityProviderxxV k
)xxk l
;xxl m
}yy 
private{{ 
async{{ 
Task{{ 
<{{ 
IActionResult{{ $
>{{$ %
RedirectAfterLogin{{& 8
({{8 9 
AuthorizationRequest{{9 M
?{{M N
context{{O V
){{V W
{|| 
if}} 

(}} 
context}} 
!=}} 
null}} 
)}} 
{~~ 	!
ArgumentNullException !
.! "
ThrowIfNull" -
(- .
Input. 3
.3 4
	ReturnUrl4 =
,= >
nameof? E
(E F
InputF K
.K L
	ReturnUrlL U
)U V
)V W
;W X
return
ÄÄ !
RedirectToReturnUrl
ÄÄ &
(
ÄÄ& '
context
ÄÄ' .
,
ÄÄ. /
Input
ÄÄ0 5
.
ÄÄ5 6
	ReturnUrl
ÄÄ6 ?
)
ÄÄ? @
;
ÄÄ@ A
}
ÅÅ 	
if
ÉÉ 

(
ÉÉ 
Url
ÉÉ 
.
ÉÉ 

IsLocalUrl
ÉÉ 
(
ÉÉ 
Input
ÉÉ  
.
ÉÉ  !
	ReturnUrl
ÉÉ! *
)
ÉÉ* +
)
ÉÉ+ ,
{
ÑÑ 	
return
ÖÖ 
Redirect
ÖÖ 
(
ÖÖ 
Input
ÖÖ !
.
ÖÖ! "
	ReturnUrl
ÖÖ" +
!
ÖÖ+ ,
)
ÖÖ, -
;
ÖÖ- .
}
ÜÜ 	
if
àà 

(
àà 
string
àà 
.
àà 
IsNullOrEmpty
àà  
(
àà  !
Input
àà! &
.
àà& '
	ReturnUrl
àà' 0
)
àà0 1
)
àà1 2
{
ââ 	
return
ää 
Redirect
ää 
(
ää 
$str
ää  
)
ää  !
;
ää! "
}
ãã 	
throw
çç 
new
çç 
ArgumentException
çç #
(
çç# $
$str
çç$ 8
)
çç8 9
;
çç9 :
}
éé 
private
êê 
IActionResult
êê !
RedirectToReturnUrl
êê -
(
êê- ."
AuthorizationRequest
êê. B
context
êêC J
,
êêJ K
string
êêL R
	returnUrl
êêS \
)
êê\ ]
{
ëë 
if
íí 

(
íí 
context
íí 
.
íí 
IsNativeClient
íí "
(
íí" #
)
íí# $
)
íí$ %
{
ìì 	
return
îî 
this
îî 
.
îî 
LoadingPage
îî #
(
îî# $
	returnUrl
îî$ -
)
îî- .
;
îî. /
}
ïï 	
return
óó 
Redirect
óó 
(
óó 
	returnUrl
óó !
)
óó! "
;
óó" #
}
òò 
private
öö 
async
öö 
Task
öö 
BuildModelAsync
öö &
(
öö& '
string
öö' -
?
öö- .
	returnUrl
öö/ 8
)
öö8 9
{
õõ 
Input
úú 
=
úú 
new
úú 

InputModel
úú 
{
ùù 	
	ReturnUrl
ûû 
=
ûû 
	returnUrl
ûû !
}
üü 	
;
üü	 

var
°° 
context
°° 
=
°° 
await
°° 
_interaction
°° (
.
°°( )*
GetAuthorizationContextAsync
°°) E
(
°°E F
	returnUrl
°°F O
)
°°O P
;
°°P Q
if
¢¢ 

(
¢¢ 
context
¢¢ 
?
¢¢ 
.
¢¢ 
IdP
¢¢ 
!=
¢¢ 
null
¢¢  
&&
¢¢! #
await
¢¢$ )
_schemeProvider
¢¢* 9
.
¢¢9 :
GetSchemeAsync
¢¢: H
(
¢¢H I
context
¢¢I P
.
¢¢P Q
IdP
¢¢Q T
)
¢¢T U
!=
¢¢V X
null
¢¢Y ]
)
¢¢] ^
{
££ 	
var
§§ 
local
§§ 
=
§§ 
context
§§ 
.
§§  
IdP
§§  #
==
§§$ &
Duende
§§' -
.
§§- .
IdentityServer
§§. <
.
§§< =%
IdentityServerConstants
§§= T
.
§§T U#
LocalIdentityProvider
§§U j
;
§§j k
View
ßß 
=
ßß 
new
ßß 
	ViewModel
ßß  
{
®® 
EnableLocalLogin
©©  
=
©©! "
local
©©# (
,
©©( )
}
™™ 
;
™™ 
Input
¨¨ 
.
¨¨ 
Username
¨¨ 
=
¨¨ 
context
¨¨ $
.
¨¨$ %
	LoginHint
¨¨% .
;
¨¨. /
if
ÆÆ 
(
ÆÆ 
!
ÆÆ 
local
ÆÆ 
)
ÆÆ 
{
ØØ 
View
∞∞ 
.
∞∞ 
ExternalProviders
∞∞ &
=
∞∞' (
new
∞∞) ,
[
∞∞, -
]
∞∞- .
{
∞∞/ 0
new
∞∞1 4
	ViewModel
∞∞5 >
.
∞∞> ?
ExternalProvider
∞∞? O
(
∞∞O P"
authenticationScheme
∞∞P d
:
∞∞d e
context
∞∞f m
.
∞∞m n
IdP
∞∞n q
)
∞∞q r
}
∞∞s t
;
∞∞t u
}
±± 
return
≥≥ 
;
≥≥ 
}
¥¥ 	
var
∂∂ 
schemes
∂∂ 
=
∂∂ 
await
∂∂ 
_schemeProvider
∂∂ +
.
∂∂+ , 
GetAllSchemesAsync
∂∂, >
(
∂∂> ?
)
∂∂? @
;
∂∂@ A
var
∏∏ 
	providers
∏∏ 
=
∏∏ 
schemes
∏∏ 
.
ππ 
Where
ππ 
(
ππ 
x
ππ 
=>
ππ 
x
ππ 
.
ππ 
DisplayName
ππ %
!=
ππ& (
null
ππ) -
)
ππ- .
.
∫∫ 
Select
∫∫ 
(
∫∫ 
x
∫∫ 
=>
∫∫ 
new
∫∫ 
	ViewModel
∫∫ &
.
∫∫& '
ExternalProvider
∫∫' 7
(
ªª "
authenticationScheme
ºº $
:
ºº$ %
x
ºº& '
.
ºº' (
Name
ºº( ,
,
ºº, -
displayName
ΩΩ 
:
ΩΩ 
x
ΩΩ 
.
ΩΩ 
DisplayName
ΩΩ *
??
ΩΩ+ -
x
ΩΩ. /
.
ΩΩ/ 0
Name
ΩΩ0 4
)
ææ 
)
ææ 
.
ææ 
ToList
ææ 
(
ææ 
)
ææ 
;
ææ 
var
¿¿ 
dynamicSchemes
¿¿ 
=
¿¿ 
(
¿¿ 
await
¿¿ #$
_identityProviderStore
¿¿$ :
.
¿¿: ;$
GetAllSchemeNamesAsync
¿¿; Q
(
¿¿Q R
)
¿¿R S
)
¿¿S T
.
¡¡ 
Where
¡¡ 
(
¡¡ 
x
¡¡ 
=>
¡¡ 
x
¡¡ 
.
¡¡ 
Enabled
¡¡ !
)
¡¡! "
.
¬¬ 
Select
¬¬ 
(
¬¬ 
x
¬¬ 
=>
¬¬ 
new
¬¬ 
	ViewModel
¬¬ &
.
¬¬& '
ExternalProvider
¬¬' 7
(
√√ "
authenticationScheme
ƒƒ $
:
ƒƒ$ %
x
ƒƒ& '
.
ƒƒ' (
Scheme
ƒƒ( .
,
ƒƒ. /
displayName
≈≈ 
:
≈≈ 
x
≈≈ 
.
≈≈ 
DisplayName
≈≈ *
??
≈≈+ -
x
≈≈. /
.
≈≈/ 0
Scheme
≈≈0 6
)
∆∆ 
)
∆∆ 
;
∆∆ 
	providers
«« 
.
«« 
AddRange
«« 
(
«« 
dynamicSchemes
«« )
)
««) *
;
««* +
var
…… 

allowLocal
…… 
=
…… 
true
…… 
;
…… 
var
   
client
   
=
   
context
   
?
   
.
   
Client
   $
;
  $ %
if
ÀÀ 

(
ÀÀ 
client
ÀÀ 
!=
ÀÀ 
null
ÀÀ 
)
ÀÀ 
{
ÃÃ 	

allowLocal
ÕÕ 
=
ÕÕ 
client
ÕÕ 
.
ÕÕ  
EnableLocalLogin
ÕÕ  0
;
ÕÕ0 1
if
ŒŒ 
(
ŒŒ 
client
ŒŒ 
.
ŒŒ *
IdentityProviderRestrictions
ŒŒ 3
!=
ŒŒ4 6
null
ŒŒ7 ;
&&
ŒŒ< >
client
ŒŒ? E
.
ŒŒE F*
IdentityProviderRestrictions
ŒŒF b
.
ŒŒb c
Count
ŒŒc h
!=
ŒŒi k
$num
ŒŒl m
)
ŒŒm n
{
œœ 
	providers
–– 
=
–– 
	providers
–– %
.
––% &
Where
––& +
(
––+ ,
provider
––, 4
=>
––5 7
client
––8 >
.
––> ?*
IdentityProviderRestrictions
––? [
.
––[ \
Contains
––\ d
(
––d e
provider
––e m
.
––m n#
AuthenticationScheme––n Ç
)––Ç É
)––É Ñ
.––Ñ Ö
ToList––Ö ã
(––ã å
)––å ç
;––ç é
}
—— 
}
““ 	
View
‘‘ 
=
‘‘ 
new
‘‘ 
	ViewModel
‘‘ 
{
’’ 	 
AllowRememberLogin
÷÷ 
=
÷÷  
LoginOptions
÷÷! -
.
÷÷- . 
AllowRememberLogin
÷÷. @
,
÷÷@ A
EnableLocalLogin
◊◊ 
=
◊◊ 

allowLocal
◊◊ )
&&
◊◊* ,
LoginOptions
◊◊- 9
.
◊◊9 :
AllowLocalLogin
◊◊: I
,
◊◊I J
ExternalProviders
ÿÿ 
=
ÿÿ 
	providers
ÿÿ  )
.
ÿÿ) *
ToArray
ÿÿ* 1
(
ÿÿ1 2
)
ÿÿ2 3
}
ŸŸ 	
;
ŸŸ	 

}
⁄⁄ 
}€€ ˘
uC:\netMentoring\04_layered_architectures\CartServiceConsoleApp\IdentityServerApi\Pages\Account\AccessDenied.cshtml.cs
	namespace 	
IdentityServerApi
 
. 
Pages !
.! "
Account" )
;) *
public 
class 
AccessDeniedModel 
:  
	PageModel! *
{		 
public

 

void

 
OnGet

 
(

 
)

 
{ 
} 
} ◊
jC:\netMentoring\04_layered_architectures\CartServiceConsoleApp\IdentityServerApi\Models\ApplicationUser.cs
	namespace 	
IdentityServerApi
 
. 
Models "
;" #
public

 
class

 
ApplicationUser

 
:

 
IdentityUser

 +
{ 
} ë∆
ÉC:\netMentoring\04_layered_architectures\CartServiceConsoleApp\IdentityServerApi\Migrations\20250602211315_InitialIdentityServer.cs
	namespace 	
IdentityServerApi
 
. 

Migrations &
{ 
public		 

partial		 
class		 !
InitialIdentityServer		 .
:		/ 0
	Migration		1 :
{

 
	protected 
override 
void 
Up  "
(" #
MigrationBuilder# 3
migrationBuilder4 D
)D E
{ 	
migrationBuilder 
. 
CreateTable (
(( )
name 
: 
$str #
,# $
columns 
: 
table 
=> !
new" %
{ 
Id 
= 
table 
. 
Column %
<% &
string& ,
>, -
(- .
type. 2
:2 3
$str4 C
,C D
nullableE M
:M N
falseO T
)T U
,U V
Name 
= 
table  
.  !
Column! '
<' (
string( .
>. /
(/ 0
type0 4
:4 5
$str6 E
,E F
	maxLengthG P
:P Q
$numR U
,U V
nullableW _
:_ `
truea e
)e f
,f g
NormalizedName "
=# $
table% *
.* +
Column+ 1
<1 2
string2 8
>8 9
(9 :
type: >
:> ?
$str@ O
,O P
	maxLengthQ Z
:Z [
$num\ _
,_ `
nullablea i
:i j
truek o
)o p
,p q
ConcurrencyStamp $
=% &
table' ,
., -
Column- 3
<3 4
string4 :
>: ;
(; <
type< @
:@ A
$strB Q
,Q R
nullableS [
:[ \
true] a
)a b
} 
, 
constraints 
: 
table "
=># %
{ 
table 
. 

PrimaryKey $
($ %
$str% 5
,5 6
x7 8
=>9 ;
x< =
.= >
Id> @
)@ A
;A B
} 
) 
; 
migrationBuilder 
. 
CreateTable (
(( )
name 
: 
$str #
,# $
columns 
: 
table 
=> !
new" %
{ 
Id   
=   
table   
.   
Column   %
<  % &
string  & ,
>  , -
(  - .
type  . 2
:  2 3
$str  4 C
,  C D
nullable  E M
:  M N
false  O T
)  T U
,  U V
UserName!! 
=!! 
table!! $
.!!$ %
Column!!% +
<!!+ ,
string!!, 2
>!!2 3
(!!3 4
type!!4 8
:!!8 9
$str!!: I
,!!I J
	maxLength!!K T
:!!T U
$num!!V Y
,!!Y Z
nullable!![ c
:!!c d
true!!e i
)!!i j
,!!j k
NormalizedUserName"" &
=""' (
table"") .
."". /
Column""/ 5
<""5 6
string""6 <
>""< =
(""= >
type""> B
:""B C
$str""D S
,""S T
	maxLength""U ^
:""^ _
$num""` c
,""c d
nullable""e m
:""m n
true""o s
)""s t
,""t u
Email## 
=## 
table## !
.##! "
Column##" (
<##( )
string##) /
>##/ 0
(##0 1
type##1 5
:##5 6
$str##7 F
,##F G
	maxLength##H Q
:##Q R
$num##S V
,##V W
nullable##X `
:##` a
true##b f
)##f g
,##g h
NormalizedEmail$$ #
=$$$ %
table$$& +
.$$+ ,
Column$$, 2
<$$2 3
string$$3 9
>$$9 :
($$: ;
type$$; ?
:$$? @
$str$$A P
,$$P Q
	maxLength$$R [
:$$[ \
$num$$] `
,$$` a
nullable$$b j
:$$j k
true$$l p
)$$p q
,$$q r
EmailConfirmed%% "
=%%# $
table%%% *
.%%* +
Column%%+ 1
<%%1 2
bool%%2 6
>%%6 7
(%%7 8
type%%8 <
:%%< =
$str%%> C
,%%C D
nullable%%E M
:%%M N
false%%O T
)%%T U
,%%U V
PasswordHash&&  
=&&! "
table&&# (
.&&( )
Column&&) /
<&&/ 0
string&&0 6
>&&6 7
(&&7 8
type&&8 <
:&&< =
$str&&> M
,&&M N
nullable&&O W
:&&W X
true&&Y ]
)&&] ^
,&&^ _
SecurityStamp'' !
=''" #
table''$ )
.'') *
Column''* 0
<''0 1
string''1 7
>''7 8
(''8 9
type''9 =
:''= >
$str''? N
,''N O
nullable''P X
:''X Y
true''Z ^
)''^ _
,''_ `
ConcurrencyStamp(( $
=((% &
table((' ,
.((, -
Column((- 3
<((3 4
string((4 :
>((: ;
(((; <
type((< @
:((@ A
$str((B Q
,((Q R
nullable((S [
:(([ \
true((] a
)((a b
,((b c
PhoneNumber)) 
=))  !
table))" '
.))' (
Column))( .
<)). /
string))/ 5
>))5 6
())6 7
type))7 ;
:)); <
$str))= L
,))L M
nullable))N V
:))V W
true))X \
)))\ ]
,))] ^ 
PhoneNumberConfirmed** (
=**) *
table**+ 0
.**0 1
Column**1 7
<**7 8
bool**8 <
>**< =
(**= >
type**> B
:**B C
$str**D I
,**I J
nullable**K S
:**S T
false**U Z
)**Z [
,**[ \
TwoFactorEnabled++ $
=++% &
table++' ,
.++, -
Column++- 3
<++3 4
bool++4 8
>++8 9
(++9 :
type++: >
:++> ?
$str++@ E
,++E F
nullable++G O
:++O P
false++Q V
)++V W
,++W X

LockoutEnd,, 
=,,  
table,,! &
.,,& '
Column,,' -
<,,- .
DateTimeOffset,,. <
>,,< =
(,,= >
type,,> B
:,,B C
$str,,D T
,,,T U
nullable,,V ^
:,,^ _
true,,` d
),,d e
,,,e f
LockoutEnabled-- "
=--# $
table--% *
.--* +
Column--+ 1
<--1 2
bool--2 6
>--6 7
(--7 8
type--8 <
:--< =
$str--> C
,--C D
nullable--E M
:--M N
false--O T
)--T U
,--U V
AccessFailedCount.. %
=..& '
table..( -
...- .
Column... 4
<..4 5
int..5 8
>..8 9
(..9 :
type..: >
:..> ?
$str..@ E
,..E F
nullable..G O
:..O P
false..Q V
)..V W
}// 
,// 
constraints00 
:00 
table00 "
=>00# %
{11 
table22 
.22 

PrimaryKey22 $
(22$ %
$str22% 5
,225 6
x227 8
=>229 ;
x22< =
.22= >
Id22> @
)22@ A
;22A B
}33 
)33 
;33 
migrationBuilder55 
.55 
CreateTable55 (
(55( )
name66 
:66 
$str66 (
,66( )
columns77 
:77 
table77 
=>77 !
new77" %
{88 
Id99 
=99 
table99 
.99 
Column99 %
<99% &
int99& )
>99) *
(99* +
type99+ /
:99/ 0
$str991 6
,996 7
nullable998 @
:99@ A
false99B G
)99G H
.:: 

Annotation:: #
(::# $
$str::$ 8
,::8 9
$str::: @
)::@ A
,::A B
RoleId;; 
=;; 
table;; "
.;;" #
Column;;# )
<;;) *
string;;* 0
>;;0 1
(;;1 2
type;;2 6
:;;6 7
$str;;8 G
,;;G H
nullable;;I Q
:;;Q R
false;;S X
);;X Y
,;;Y Z
	ClaimType<< 
=<< 
table<<  %
.<<% &
Column<<& ,
<<<, -
string<<- 3
><<3 4
(<<4 5
type<<5 9
:<<9 :
$str<<; J
,<<J K
nullable<<L T
:<<T U
true<<V Z
)<<Z [
,<<[ \

ClaimValue== 
===  
table==! &
.==& '
Column==' -
<==- .
string==. 4
>==4 5
(==5 6
type==6 :
:==: ;
$str==< K
,==K L
nullable==M U
:==U V
true==W [
)==[ \
}>> 
,>> 
constraints?? 
:?? 
table?? "
=>??# %
{@@ 
tableAA 
.AA 

PrimaryKeyAA $
(AA$ %
$strAA% :
,AA: ;
xAA< =
=>AA> @
xAAA B
.AAB C
IdAAC E
)AAE F
;AAF G
tableBB 
.BB 

ForeignKeyBB $
(BB$ %
nameCC 
:CC 
$strCC F
,CCF G
columnDD 
:DD 
xDD  !
=>DD" $
xDD% &
.DD& '
RoleIdDD' -
,DD- .
principalTableEE &
:EE& '
$strEE( 5
,EE5 6
principalColumnFF '
:FF' (
$strFF) -
,FF- .
onDeleteGG  
:GG  !
ReferentialActionGG" 3
.GG3 4
CascadeGG4 ;
)GG; <
;GG< =
}HH 
)HH 
;HH 
migrationBuilderJJ 
.JJ 
CreateTableJJ (
(JJ( )
nameKK 
:KK 
$strKK (
,KK( )
columnsLL 
:LL 
tableLL 
=>LL !
newLL" %
{MM 
IdNN 
=NN 
tableNN 
.NN 
ColumnNN %
<NN% &
intNN& )
>NN) *
(NN* +
typeNN+ /
:NN/ 0
$strNN1 6
,NN6 7
nullableNN8 @
:NN@ A
falseNNB G
)NNG H
.OO 

AnnotationOO #
(OO# $
$strOO$ 8
,OO8 9
$strOO: @
)OO@ A
,OOA B
UserIdPP 
=PP 
tablePP "
.PP" #
ColumnPP# )
<PP) *
stringPP* 0
>PP0 1
(PP1 2
typePP2 6
:PP6 7
$strPP8 G
,PPG H
nullablePPI Q
:PPQ R
falsePPS X
)PPX Y
,PPY Z
	ClaimTypeQQ 
=QQ 
tableQQ  %
.QQ% &
ColumnQQ& ,
<QQ, -
stringQQ- 3
>QQ3 4
(QQ4 5
typeQQ5 9
:QQ9 :
$strQQ; J
,QQJ K
nullableQQL T
:QQT U
trueQQV Z
)QQZ [
,QQ[ \

ClaimValueRR 
=RR  
tableRR! &
.RR& '
ColumnRR' -
<RR- .
stringRR. 4
>RR4 5
(RR5 6
typeRR6 :
:RR: ;
$strRR< K
,RRK L
nullableRRM U
:RRU V
trueRRW [
)RR[ \
}SS 
,SS 
constraintsTT 
:TT 
tableTT "
=>TT# %
{UU 
tableVV 
.VV 

PrimaryKeyVV $
(VV$ %
$strVV% :
,VV: ;
xVV< =
=>VV> @
xVVA B
.VVB C
IdVVC E
)VVE F
;VVF G
tableWW 
.WW 

ForeignKeyWW $
(WW$ %
nameXX 
:XX 
$strXX F
,XXF G
columnYY 
:YY 
xYY  !
=>YY" $
xYY% &
.YY& '
UserIdYY' -
,YY- .
principalTableZZ &
:ZZ& '
$strZZ( 5
,ZZ5 6
principalColumn[[ '
:[[' (
$str[[) -
,[[- .
onDelete\\  
:\\  !
ReferentialAction\\" 3
.\\3 4
Cascade\\4 ;
)\\; <
;\\< =
}]] 
)]] 
;]] 
migrationBuilder__ 
.__ 
CreateTable__ (
(__( )
name`` 
:`` 
$str`` (
,``( )
columnsaa 
:aa 
tableaa 
=>aa !
newaa" %
{bb 
LoginProvidercc !
=cc" #
tablecc$ )
.cc) *
Columncc* 0
<cc0 1
stringcc1 7
>cc7 8
(cc8 9
typecc9 =
:cc= >
$strcc? N
,ccN O
nullableccP X
:ccX Y
falseccZ _
)cc_ `
,cc` a
ProviderKeydd 
=dd  !
tabledd" '
.dd' (
Columndd( .
<dd. /
stringdd/ 5
>dd5 6
(dd6 7
typedd7 ;
:dd; <
$strdd= L
,ddL M
nullableddN V
:ddV W
falseddX ]
)dd] ^
,dd^ _
ProviderDisplayNameee '
=ee( )
tableee* /
.ee/ 0
Columnee0 6
<ee6 7
stringee7 =
>ee= >
(ee> ?
typeee? C
:eeC D
$streeE T
,eeT U
nullableeeV ^
:ee^ _
trueee` d
)eed e
,eee f
UserIdff 
=ff 
tableff "
.ff" #
Columnff# )
<ff) *
stringff* 0
>ff0 1
(ff1 2
typeff2 6
:ff6 7
$strff8 G
,ffG H
nullableffI Q
:ffQ R
falseffS X
)ffX Y
}gg 
,gg 
constraintshh 
:hh 
tablehh "
=>hh# %
{ii 
tablejj 
.jj 

PrimaryKeyjj $
(jj$ %
$strjj% :
,jj: ;
xjj< =
=>jj> @
newjjA D
{jjE F
xjjG H
.jjH I
LoginProviderjjI V
,jjV W
xjjX Y
.jjY Z
ProviderKeyjjZ e
}jjf g
)jjg h
;jjh i
tablekk 
.kk 

ForeignKeykk $
(kk$ %
namell 
:ll 
$strll F
,llF G
columnmm 
:mm 
xmm  !
=>mm" $
xmm% &
.mm& '
UserIdmm' -
,mm- .
principalTablenn &
:nn& '
$strnn( 5
,nn5 6
principalColumnoo '
:oo' (
$stroo) -
,oo- .
onDeletepp  
:pp  !
ReferentialActionpp" 3
.pp3 4
Cascadepp4 ;
)pp; <
;pp< =
}qq 
)qq 
;qq 
migrationBuilderss 
.ss 
CreateTabless (
(ss( )
namett 
:tt 
$strtt '
,tt' (
columnsuu 
:uu 
tableuu 
=>uu !
newuu" %
{vv 
UserIdww 
=ww 
tableww "
.ww" #
Columnww# )
<ww) *
stringww* 0
>ww0 1
(ww1 2
typeww2 6
:ww6 7
$strww8 G
,wwG H
nullablewwI Q
:wwQ R
falsewwS X
)wwX Y
,wwY Z
RoleIdxx 
=xx 
tablexx "
.xx" #
Columnxx# )
<xx) *
stringxx* 0
>xx0 1
(xx1 2
typexx2 6
:xx6 7
$strxx8 G
,xxG H
nullablexxI Q
:xxQ R
falsexxS X
)xxX Y
}yy 
,yy 
constraintszz 
:zz 
tablezz "
=>zz# %
{{{ 
table|| 
.|| 

PrimaryKey|| $
(||$ %
$str||% 9
,||9 :
x||; <
=>||= ?
new||@ C
{||D E
x||F G
.||G H
UserId||H N
,||N O
x||P Q
.||Q R
RoleId||R X
}||Y Z
)||Z [
;||[ \
table}} 
.}} 

ForeignKey}} $
(}}$ %
name~~ 
:~~ 
$str~~ E
,~~E F
column 
: 
x  !
=>" $
x% &
.& '
RoleId' -
,- .
principalTable
ÄÄ &
:
ÄÄ& '
$str
ÄÄ( 5
,
ÄÄ5 6
principalColumn
ÅÅ '
:
ÅÅ' (
$str
ÅÅ) -
,
ÅÅ- .
onDelete
ÇÇ  
:
ÇÇ  !
ReferentialAction
ÇÇ" 3
.
ÇÇ3 4
Cascade
ÇÇ4 ;
)
ÇÇ; <
;
ÇÇ< =
table
ÉÉ 
.
ÉÉ 

ForeignKey
ÉÉ $
(
ÉÉ$ %
name
ÑÑ 
:
ÑÑ 
$str
ÑÑ E
,
ÑÑE F
column
ÖÖ 
:
ÖÖ 
x
ÖÖ  !
=>
ÖÖ" $
x
ÖÖ% &
.
ÖÖ& '
UserId
ÖÖ' -
,
ÖÖ- .
principalTable
ÜÜ &
:
ÜÜ& '
$str
ÜÜ( 5
,
ÜÜ5 6
principalColumn
áá '
:
áá' (
$str
áá) -
,
áá- .
onDelete
àà  
:
àà  !
ReferentialAction
àà" 3
.
àà3 4
Cascade
àà4 ;
)
àà; <
;
àà< =
}
ââ 
)
ââ 
;
ââ 
migrationBuilder
ãã 
.
ãã 
CreateTable
ãã (
(
ãã( )
name
åå 
:
åå 
$str
åå (
,
åå( )
columns
çç 
:
çç 
table
çç 
=>
çç !
new
çç" %
{
éé 
UserId
èè 
=
èè 
table
èè "
.
èè" #
Column
èè# )
<
èè) *
string
èè* 0
>
èè0 1
(
èè1 2
type
èè2 6
:
èè6 7
$str
èè8 G
,
èèG H
nullable
èèI Q
:
èèQ R
false
èèS X
)
èèX Y
,
èèY Z
LoginProvider
êê !
=
êê" #
table
êê$ )
.
êê) *
Column
êê* 0
<
êê0 1
string
êê1 7
>
êê7 8
(
êê8 9
type
êê9 =
:
êê= >
$str
êê? N
,
êêN O
nullable
êêP X
:
êêX Y
false
êêZ _
)
êê_ `
,
êê` a
Name
ëë 
=
ëë 
table
ëë  
.
ëë  !
Column
ëë! '
<
ëë' (
string
ëë( .
>
ëë. /
(
ëë/ 0
type
ëë0 4
:
ëë4 5
$str
ëë6 E
,
ëëE F
nullable
ëëG O
:
ëëO P
false
ëëQ V
)
ëëV W
,
ëëW X
Value
íí 
=
íí 
table
íí !
.
íí! "
Column
íí" (
<
íí( )
string
íí) /
>
íí/ 0
(
íí0 1
type
íí1 5
:
íí5 6
$str
íí7 F
,
ííF G
nullable
ííH P
:
ííP Q
true
ííR V
)
ííV W
}
ìì 
,
ìì 
constraints
îî 
:
îî 
table
îî "
=>
îî# %
{
ïï 
table
ññ 
.
ññ 

PrimaryKey
ññ $
(
ññ$ %
$str
ññ% :
,
ññ: ;
x
ññ< =
=>
ññ> @
new
ññA D
{
ññE F
x
ññG H
.
ññH I
UserId
ññI O
,
ññO P
x
ññQ R
.
ññR S
LoginProvider
ññS `
,
ññ` a
x
ññb c
.
ññc d
Name
ññd h
}
ññi j
)
ññj k
;
ññk l
table
óó 
.
óó 

ForeignKey
óó $
(
óó$ %
name
òò 
:
òò 
$str
òò F
,
òòF G
column
ôô 
:
ôô 
x
ôô  !
=>
ôô" $
x
ôô% &
.
ôô& '
UserId
ôô' -
,
ôô- .
principalTable
öö &
:
öö& '
$str
öö( 5
,
öö5 6
principalColumn
õõ '
:
õõ' (
$str
õõ) -
,
õõ- .
onDelete
úú  
:
úú  !
ReferentialAction
úú" 3
.
úú3 4
Cascade
úú4 ;
)
úú; <
;
úú< =
}
ùù 
)
ùù 
;
ùù 
migrationBuilder
üü 
.
üü 
CreateIndex
üü (
(
üü( )
name
†† 
:
†† 
$str
†† 2
,
††2 3
table
°° 
:
°° 
$str
°° )
,
°°) *
column
¢¢ 
:
¢¢ 
$str
¢¢  
)
¢¢  !
;
¢¢! "
migrationBuilder
§§ 
.
§§ 
CreateIndex
§§ (
(
§§( )
name
•• 
:
•• 
$str
•• %
,
••% &
table
¶¶ 
:
¶¶ 
$str
¶¶ $
,
¶¶$ %
column
ßß 
:
ßß 
$str
ßß (
,
ßß( )
unique
®® 
:
®® 
true
®® 
,
®® 
filter
©© 
:
©© 
$str
©© 6
)
©©6 7
;
©©7 8
migrationBuilder
´´ 
.
´´ 
CreateIndex
´´ (
(
´´( )
name
¨¨ 
:
¨¨ 
$str
¨¨ 2
,
¨¨2 3
table
≠≠ 
:
≠≠ 
$str
≠≠ )
,
≠≠) *
column
ÆÆ 
:
ÆÆ 
$str
ÆÆ  
)
ÆÆ  !
;
ÆÆ! "
migrationBuilder
∞∞ 
.
∞∞ 
CreateIndex
∞∞ (
(
∞∞( )
name
±± 
:
±± 
$str
±± 2
,
±±2 3
table
≤≤ 
:
≤≤ 
$str
≤≤ )
,
≤≤) *
column
≥≥ 
:
≥≥ 
$str
≥≥  
)
≥≥  !
;
≥≥! "
migrationBuilder
µµ 
.
µµ 
CreateIndex
µµ (
(
µµ( )
name
∂∂ 
:
∂∂ 
$str
∂∂ 1
,
∂∂1 2
table
∑∑ 
:
∑∑ 
$str
∑∑ (
,
∑∑( )
column
∏∏ 
:
∏∏ 
$str
∏∏  
)
∏∏  !
;
∏∏! "
migrationBuilder
∫∫ 
.
∫∫ 
CreateIndex
∫∫ (
(
∫∫( )
name
ªª 
:
ªª 
$str
ªª "
,
ªª" #
table
ºº 
:
ºº 
$str
ºº $
,
ºº$ %
column
ΩΩ 
:
ΩΩ 
$str
ΩΩ )
)
ΩΩ) *
;
ΩΩ* +
migrationBuilder
øø 
.
øø 
CreateIndex
øø (
(
øø( )
name
¿¿ 
:
¿¿ 
$str
¿¿ %
,
¿¿% &
table
¡¡ 
:
¡¡ 
$str
¡¡ $
,
¡¡$ %
column
¬¬ 
:
¬¬ 
$str
¬¬ ,
,
¬¬, -
unique
√√ 
:
√√ 
true
√√ 
,
√√ 
filter
ƒƒ 
:
ƒƒ 
$str
ƒƒ :
)
ƒƒ: ;
;
ƒƒ; <
}
≈≈ 	
	protected
»» 
override
»» 
void
»» 
Down
»»  $
(
»»$ %
MigrationBuilder
»»% 5
migrationBuilder
»»6 F
)
»»F G
{
…… 	
migrationBuilder
   
.
   
	DropTable
   &
(
  & '
name
ÀÀ 
:
ÀÀ 
$str
ÀÀ (
)
ÀÀ( )
;
ÀÀ) *
migrationBuilder
ÕÕ 
.
ÕÕ 
	DropTable
ÕÕ &
(
ÕÕ& '
name
ŒŒ 
:
ŒŒ 
$str
ŒŒ (
)
ŒŒ( )
;
ŒŒ) *
migrationBuilder
–– 
.
–– 
	DropTable
–– &
(
––& '
name
—— 
:
—— 
$str
—— (
)
——( )
;
——) *
migrationBuilder
”” 
.
”” 
	DropTable
”” &
(
””& '
name
‘‘ 
:
‘‘ 
$str
‘‘ '
)
‘‘' (
;
‘‘( )
migrationBuilder
÷÷ 
.
÷÷ 
	DropTable
÷÷ &
(
÷÷& '
name
◊◊ 
:
◊◊ 
$str
◊◊ (
)
◊◊( )
;
◊◊) *
migrationBuilder
ŸŸ 
.
ŸŸ 
	DropTable
ŸŸ &
(
ŸŸ& '
name
⁄⁄ 
:
⁄⁄ 
$str
⁄⁄ #
)
⁄⁄# $
;
⁄⁄$ %
migrationBuilder
‹‹ 
.
‹‹ 
	DropTable
‹‹ &
(
‹‹& '
name
›› 
:
›› 
$str
›› #
)
››# $
;
››$ %
}
ﬁﬁ 	
}
ﬂﬂ 
}‡‡ ≠&
eC:\netMentoring\04_layered_architectures\CartServiceConsoleApp\IdentityServerApi\HostingExtensions.cs
	namespace 	
IdentityServerApi
 
; 
public		 
static		 
class		 
HostingExtensions		 %
{

 
public 

static !
WebApplicationBuilder '
ConfigureServices( 9
(9 :
this: >!
WebApplicationBuilder? T
builderU \
)\ ]
{ 
builder 
. 
Services 
. 
AddRazorPages &
(& '
)' (
;( )
builder 
. 
Services 
. 
AddDbContext %
<% & 
ApplicationDbContext& :
>: ;
(; <
options< C
=>D F
options 
. 
UseSqlServer  
(  !
builder! (
.( )
Configuration) 6
.6 7
GetConnectionString7 J
(J K
$strK ^
)^ _
)_ `
)` a
;a b
builder 
. 
Services 
. 
AddIdentity $
<$ %
IdentityUser% 1
,1 2
IdentityRole3 ?
>? @
(@ A
)A B
. $
AddEntityFrameworkStores %
<% & 
ApplicationDbContext& :
>: ;
(; <
)< =
. $
AddDefaultTokenProviders %
(% &
)& '
;' (
builder 
. 
Services 
. 
AddIdentityServer 
( 
options &
=>' )
{ 
options 
. 
Events 
. 
RaiseErrorEvents /
=0 1
true2 6
;6 7
options 
. 
Events 
. "
RaiseInformationEvents 5
=6 7
true8 <
;< =
options 
. 
Events 
. 
RaiseFailureEvents 1
=2 3
true4 8
;8 9
options 
. 
Events 
. 
RaiseSuccessEvents 1
=2 3
true4 8
;8 9
options 
. #
EmitStaticAudienceClaim /
=0 1
true2 6
;6 7
} 
) 
. (
AddInMemoryIdentityResources )
() *
Config* 0
.0 1
IdentityResources1 B
)B C
.    
AddInMemoryApiScopes   !
(  ! "
Config  " (
.  ( )
	ApiScopes  ) 2
)  2 3
.!! #
AddInMemoryApiResources!! $
(!!$ %
Config!!% +
.!!+ ,
ApiResources!!, 8
)!!8 9
."" 
AddInMemoryClients"" 
(""  
Config""  &
.""& '
Clients""' .
)"". /
.## 
AddAspNetIdentity## 
<## 
IdentityUser## +
>##+ ,
(##, -
)##- .
.$$ )
AddDeveloperSigningCredential$$ *
($$* +
)$$+ ,
;$$, -
builder&& 
.&& 
Services&& 
.&& 
AddAuthentication&& *
(&&* +
)&&+ ,
;&&, -
return(( 
builder(( 
;(( 
})) 
public++ 

static++ 
WebApplication++  
ConfigurePipeline++! 2
(++2 3
this++3 7
WebApplication++8 F
app++G J
)++J K
{,, 
app-- 
.-- $
UseSerilogRequestLogging-- $
(--$ %
)--% &
;--& '
if// 

(// 
app// 
.// 
Environment// 
.// 
IsDevelopment// )
(//) *
)//* +
)//+ ,
{00 	
app11 
.11 %
UseDeveloperExceptionPage11 )
(11) *
)11* +
;11+ ,
}22 	
app44 
.44 
UseStaticFiles44 
(44 
)44 
;44 
app55 
.55 

UseRouting55 
(55 
)55 
;55 
app66 
.66 
UseIdentityServer66 
(66 
)66 
;66  
app77 
.77 
UseAuthorization77 
(77 
)77 
;77 
app99 
.99 
MapRazorPages99 
(99 
)99 
;99 
app:: 
.:: 
MapControllers:: 
(:: 
):: 
;:: 
return<< 
app<< 
;<< 
}== 
}>> Ê
mC:\netMentoring\04_layered_architectures\CartServiceConsoleApp\IdentityServerApi\Data\ApplicationDbContext.cs
	namespace 	
IdentityServerApi
 
. 
Data  
;  !
public 
class  
ApplicationDbContext !
:" #
IdentityDbContext$ 5
<5 6
IdentityUser6 B
,B C
IdentityRoleD P
,P Q
stringR X
>X Y
{		 
public

 
 
ApplicationDbContext

 
(

  
DbContextOptions

  0
<

0 1 
ApplicationDbContext

1 E
>

E F
options

G N
)

N O
: 	
base
 
( 
options 
) 
{ 
} 
	protected 
override 
void 
OnModelCreating +
(+ ,
ModelBuilder, 8
builder9 @
)@ A
{ 
base 
. 
OnModelCreating 
( 
builder $
)$ %
;% &
} 
} ‹
ZC:\netMentoring\04_layered_architectures\CartServiceConsoleApp\IdentityServerApi\Config.cs
	namespace 	
IdentityServerApi
 
; 
public 
static 
class 
Config 
{ 
public 

static 
IEnumerable 
< 
IdentityResource .
>. /
IdentityResources0 A
=>B D
new		 
IdentityResource		 
[		 
]		 
{

 	
new 
IdentityResources !
.! "
OpenId" (
(( )
)) *
,* +
new 
IdentityResources !
.! "
Profile" )
() *
)* +
,+ ,
new 
IdentityResource  
(  !
$str! (
,( )
new* -
[- .
]. /
{0 1
$str2 8
}9 :
): ;
} 	
;	 

public 

static 
IEnumerable 
< 
ApiScope &
>& '
	ApiScopes( 1
=>2 4
new 
[ 
] 
{ 	
new 
ApiScope 
( 
$str %
,% &
$str' 4
)4 5
} 	
;	 

public 

static 
IEnumerable 
< 
ApiResource )
>) *
ApiResources+ 7
=>8 :
new 
[ 
] 
{ 	
new 
ApiResource 
( 
$str (
,( )
$str* 7
)7 8
{ 
Scopes 
= 
{ 
$str '
}( )
,) *

UserClaims 
= 
{ 
$str %
}& '
} 
} 	
;	 

public   

static   
IEnumerable   
<   
Client   $
>  $ %
Clients  & -
=>  . 0
new!! 
[!! 
]!! 
{"" 	
new## 
Client## 
{$$ 
ClientId%% 
=%% 
$str%% +
,%%+ ,
ClientSecrets&& 
=&& 
{&&  !
new&&" %
Secret&&& ,
(&&, -
$str&&- 5
.&&5 6
Sha256&&6 <
(&&< =
)&&= >
)&&> ?
}&&@ A
,&&A B
AllowedGrantTypes'' !
=''" #

GrantTypes''$ .
.''. /!
ResourceOwnerPassword''/ D
,''D E
AllowedScopes(( 
=(( 
{((  !
$str((" .
,((. /
$str((0 8
,((8 9
$str((: C
,((C D
$str((E L
}((M N
,((N O
AllowOfflineAccess)) "
=))# $
true))% )
,))) *
RefreshTokenUsage** !
=**" #

TokenUsage**$ .
.**. /
ReUse**/ 4
,**4 5"
RefreshTokenExpiration++ &
=++' (
TokenExpiration++) 8
.++8 9
Sliding++9 @
,++@ A'
SlidingRefreshTokenLifetime,, +
=,,, -
$num,,. 5
,,,5 6
AccessTokenLifetime-- #
=--$ %
$num--& *
}.. 
}// 	
;//	 

}00 