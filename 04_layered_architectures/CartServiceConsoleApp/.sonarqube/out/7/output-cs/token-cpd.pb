„B
\C:\netMentoring\04_layered_architectures\CartServiceConsoleApp\CatalogService.Api\Program.cs

AppContext 

.
 
	SetSwitch 
( 
$str <
,< =
false> C
)C D
;D E
ServicePointManager		 
.		 
SecurityProtocol		 $
=		% & 
SecurityProtocolType		' ;
.		; <
Tls12		< A
;		A B
var 
builder 
= 
WebApplication 
. 
CreateBuilder *
(* +
args+ /
)/ 0
;0 1
builder 
. 
Services 
. 
AddCors 
( 
options  
=>! #
{ 
options 
. 
	AddPolicy 
( 
$str  
,  !
policy" (
=>) +
{ 
policy 
. 
AllowAnyOrigin 
( 
) 
. 	
AllowAnyMethod	 
( 
) 
. 	
AllowAnyHeader	 
( 
) 
; 
} 
) 
; 
} 
) 
; 
var 
connectionString 
= 
builder 
. 
Configuration ,
., -
GetConnectionString- @
(@ A
$strA T
)T U
;U V
var 
connectionString2 
= 
builder 
.  
Configuration  -
.- .
GetConnectionString. A
(A B
$strB P
)P Q
;Q R
builder 
. 
Services 
. 
AddInfrastructure "
(" #
connectionString# 3
,3 4
connectionString25 F
)F G
;G H
builder 
. 
Services 
. 
	AddScoped 
< 
ICategoryService +
,+ ,
CategoryService- <
>< =
(= >
)> ?
;? @
builder 
. 
Services 
. 
	AddScoped 
< 
IProductService *
,* +
ProductService, :
>: ;
(; <
)< =
;= >
builder 
. 
Services 
. 
AddControllers 
(  
)  !
;! "
builder   
.   
Services   
.   #
AddEndpointsApiExplorer   (
(  ( )
)  ) *
;  * +
builder!! 
.!! 
Services!! 
.!! 
AddSwaggerGen!! 
(!! 
)!!  
;!!  !
builder## 
.## 
Services## 
.## 
AddHttpClient## 
(## 
)##  
;##  !
builder$$ 
.$$ 
Services$$ 
.$$ 

AddLogging$$ 
($$ 
logging$$ #
=>$$$ &
{%% 
logging&& 
.&& 

AddConsole&& 
(&& 
)&& 
;&& 
logging'' 
.'' 
AddDebug'' 
('' 
)'' 
;'' 
}(( 
)(( 
;(( 
builder** 
.** 
Services** 
.** 
AddAuthentication** "
(**" #
options**# *
=>**+ -
{++ 
options,, 
.,, %
DefaultAuthenticateScheme,, %
=,,& '
JwtBearerDefaults,,( 9
.,,9 : 
AuthenticationScheme,,: N
;,,N O
options-- 
.-- "
DefaultChallengeScheme-- "
=--# $
JwtBearerDefaults--% 6
.--6 7 
AuthenticationScheme--7 K
;--K L
}.. 
).. 
.// 
AddJwtBearer// 
(// 
options// 
=>// 
{00 
options11 
.11 
	Authority11 
=11 
$str11 0
;110 1
options22 
.22 
Audience22 
=22 
$str22 #
;22# $
options33 
.33  
RequireHttpsMetadata33  
=33! "
false33# (
;33( )
options44 
.44 %
TokenValidationParameters44 %
=44& '
new44( +
(44+ ,
)44, -
{55 
ValidateIssuer66 
=66 
true66 
,66 
ValidateAudience77 
=77 
true77 
,77  
ValidateLifetime88 
=88 
true88 
,88  $
ValidateIssuerSigningKey99  
=99! "
true99# '
,99' (
RoleClaimType:: 
=:: 
$str:: 
,:: 
NameClaimType;; 
=;; 
$str;; 
};; 
;;;  
}<< 
)<< 
;<< 
builder>> 
.>> 
Services>> 
.>> #
AddAuthorizationBuilder>> (
(>>( )
)>>) *
.?? 
	AddPolicy?? 
(?? 
$str?? 
,?? 
policy?? 
=>??  
policy@@ 
.@@ 
RequireAssertion@@ 
(@@  
context@@  '
=>@@( *
contextAA 
.AA 
UserAA 
.AA 
HasClaimAA !
(AA! "
cAA" #
=>AA$ &
(BB 
cBB 
.BB 
TypeBB 
==BB 
$strBB !
||BB" $
cBB% &
.BB& '
TypeBB' +
==BB, .
$strBB/ m
)BBm n
&&BBo q
(CC 
cCC 
.CC 
ValueCC 
.CC 
EqualsCC 
(CC  
$strCC  )
,CC) *
StringComparisonCC+ ;
.CC; <
OrdinalIgnoreCaseCC< M
)CCM N
||CCO Q
cDD 
.DD 
ValueDD 
.DD 
EqualsDD 
(DD  
$strDD  /
,DD/ 0
StringComparisonDD1 A
.DDA B
OrdinalIgnoreCaseDDB S
)DDS T
)DDT U
)DDU V
)DDV W
)DDW X
.EE 
	AddPolicyEE 
(EE 
$strEE 
,EE 
policyEE 
=>EE  "
policyFF 
.FF 
RequireAssertionFF 
(FF  
contextFF  '
=>FF( *
contextGG 
.GG 
UserGG 
.GG 
HasClaimGG !
(GG! "
cGG" #
=>GG$ &
(HH 
cHH 
.HH 
TypeHH 
==HH 
$strHH !
||HH" $
cHH% &
.HH& '
TypeHH' +
==HH, .
$strHH/ m
)HHm n
&&HHo q
cII 
.II 
ValueII 
.II 
EqualsII 
(II 
$strII (
,II( )
StringComparisonII* :
.II: ;
OrdinalIgnoreCaseII; L
)IIL M
)IIM N
)IIN O
)IIO P
;IIP Q
varKK 
appKK 
=KK 	
builderKK
 
.KK 
BuildKK 
(KK 
)KK 
;KK 
ifNN 
(NN 
appNN 
.NN 
EnvironmentNN 
.NN 
IsDevelopmentNN !
(NN! "
)NN" #
)NN# $
{OO 
appPP 
.PP 

UseSwaggerPP 
(PP 
)PP 
;PP 
appQQ 
.QQ 
UseSwaggerUIQQ 
(QQ 
)QQ 
;QQ 
}RR 
appTT 
.TT 
UseHttpsRedirectionTT 
(TT 
)TT 
;TT 
appVV 
.VV 
UseCorsVV 
(VV 
$strVV 
)VV 
;VV 
appXX 
.XX 
UseAuthenticationXX 
(XX 
)XX 
;XX 
appYY 
.YY 
UseAuthorizationYY 
(YY 
)YY 
;YY 
app[[ 
.[[ 
MapControllers[[ 
([[ 
)[[ 
;[[ 
app]] 
.]] 
Run]] 
(]] 
)]] 	
;]]	 
¨1
sC:\netMentoring\04_layered_architectures\CartServiceConsoleApp\CatalogService.Api\Controllers\CategoryController.cs
	namespace 	
CatalogService
 
. 
Api 
. 
Controllers (
{ 
[ 
ApiController 
] 
[		 
Route		 

(		
 
$str		 
)		 
]		 
[

 
	Authorize

 
]

 
public 

class 
CategoryController #
:$ %
ControllerBase& 4
{ 
private 
readonly 
ICategoryService )
_categoryService* :
;: ;
public 
CategoryController !
(! "
ICategoryService" 2
categoryService3 B
)B C
{ 	
_categoryService 
= 
categoryService .
;. /
} 	
[ 	
HttpGet	 
( 
$str 
) 
] 
[ 	
	Authorize	 
( 
Policy 
= 
$str "
)" #
]# $
public 
async 
Task 
< 
IActionResult '
>' (
GetAll) /
(/ 0
)0 1
{ 	
var 

categories 
= 
await "
_categoryService# 3
.3 4
	ListAsync4 =
(= >
)> ?
;? @
return 
Ok 
( 

categories  
)  !
;! "
} 	
[ 	
HttpGet	 
( 
$str 
) 
] 
[ 	
	Authorize	 
( 
Policy 
= 
$str "
)" #
]# $
public   
async   
Task   
<   
IActionResult   '
>  ' (
GetById  ) 0
(  0 1
int  1 4
id  5 7
)  7 8
{!! 	
var"" 
category"" 
="" 
await""  
_categoryService""! 1
.""1 2
GetByIdAsync""2 >
(""> ?
id""? A
)""A B
;""B C
if## 
(## 
category## 
==## 
null##  
)##  !
return$$ 
NotFound$$ 
($$  
$"$$  "
$str$$" 3
{$$3 4
id$$4 6
}$$6 7
$str$$7 B
"$$B C
)$$C D
;$$D E
return%% 
Ok%% 
(%% 
category%% 
)%% 
;%%  
}&& 	
[)) 	
HttpPost))	 
])) 
[** 	
	Authorize**	 
(** 
Policy** 
=** 
$str** $
)**$ %
]**% &
public++ 
async++ 
Task++ 
<++ 
IActionResult++ '
>++' (
Add++) ,
(++, -
[++- .
FromBody++. 6
]++6 7
CategoryDto++8 C
categoryDto++D O
)++O P
{,, 	
if-- 
(-- 
!-- 

ModelState-- 
.-- 
IsValid-- #
)--# $
return.. 

BadRequest.. !
(..! "

ModelState.." ,
).., -
;..- .
await00 
_categoryService00 "
.00" #
AddAsync00# +
(00+ ,
categoryDto00, 7
)007 8
;008 9
return11 
CreatedAtAction11 "
(11" #
nameof11# )
(11) *
GetById11* 1
)111 2
,112 3
new114 7
{118 9
id11: <
=11= >
categoryDto11? J
.11J K
Id11K M
}11N O
,11O P
categoryDto11Q \
)11\ ]
;11] ^
}22 	
[55 	
HttpPut55	 
(55 
$str55 
)55 
]55 
[66 	
	Authorize66	 
(66 
Policy66 
=66 
$str66 $
)66$ %
]66% &
public77 
async77 
Task77 
<77 
IActionResult77 '
>77' (
Update77) /
(77/ 0
int770 3
id774 6
,776 7
[778 9
FromBody779 A
]77A B
CategoryDto77C N
categoryDto77O Z
)77Z [
{88 	
if99 
(99 
!99 

ModelState99 
.99 
IsValid99 #
)99# $
return:: 

BadRequest:: !
(::! "

ModelState::" ,
)::, -
;::- .
if<< 
(<< 
id<< 
!=<< 
categoryDto<< !
.<<! "
Id<<" $
)<<$ %
return== 

BadRequest== !
(==! "
$str==" 9
)==9 :
;==: ;
if?? 
(?? 
categoryDto?? 
.?? 
ParentCategoryId?? ,
==??- /
categoryDto??0 ;
.??; <
Id??< >
)??> ?
return@@ 

BadRequest@@ !
(@@! "
$str@@" H
)@@H I
;@@I J
awaitBB 
_categoryServiceBB "
.BB" #
UpdateAsyncBB# .
(BB. /
categoryDtoBB/ :
)BB: ;
;BB; <
returnCC 
	NoContentCC 
(CC 
)CC 
;CC 
}DD 	
[GG 	

HttpDeleteGG	 
(GG 
$strGG 
)GG 
]GG 
[HH 	
	AuthorizeHH	 
(HH 
PolicyHH 
=HH 
$strHH $
)HH$ %
]HH% &
publicII 
asyncII 
TaskII 
<II 
IActionResultII '
>II' (
DeleteII) /
(II/ 0
intII0 3
idII4 6
)II6 7
{JJ 	
awaitKK 
_categoryServiceKK "
.KK" #
DeleteAsyncKK# .
(KK. /
idKK/ 1
)KK1 2
;KK2 3
returnLL 
	NoContentLL 
(LL 
)LL 
;LL 
}MM 	
}NN 
}OO î8
rC:\netMentoring\04_layered_architectures\CartServiceConsoleApp\CatalogService.Api\Controllers\ProductController.cs
	namespace 	
CatalogService
 
. 
Api 
. 
Controllers (
{ 
[		 
ApiController		 
]		 
[

 
Route

 

(


 
$str

 
)

 
]

 
[ 
	Authorize 
] 
public 

class 
ProductController "
:# $
ControllerBase% 3
{ 
private 
readonly 
ILogger  
_logger! (
;( )
private 
readonly 
IProductService (
_productService) 8
;8 9
public 
ProductController  
(  !
IProductService! 0
productService1 ?
,? @
ILoggerA H
<H I
ProductControllerI Z
>Z [
logger\ b
)b c
{ 	
_productService 
= 
productService ,
;, -
_logger 
= 
logger 
; 
} 	
[ 	
HttpGet	 
( 
$str 
) 
] 
[ 	
	Authorize	 
( 
Policy 
= 
$str "
)" #
]# $
public 
async 
Task 
< 
IActionResult '
>' (
GetAll) /
(/ 0
)0 1
{ 	
var 
user 
= 
User 
. 
Identity $
.$ %
Name% )
??* ,
$str- 8
;8 9
var 
roles 
= 
User 
. 
Claims #
.# $
Where$ )
() *
c* +
=>, .
c/ 0
.0 1
Type1 5
==6 8
$str9 ?
)? @
.@ A
SelectA G
(G H
cH I
=>J L
cM N
.N O
ValueO T
)T U
.U V
ToListV \
(\ ]
)] ^
;^ _
_logger 
. 
LogInformation "
(" #
$str# J
,J K
userL P
,P Q
stringR X
.X Y
JoinY ]
(] ^
$str^ b
,b c
rolesd i
)i j
)j k
;k l
var   
products   
=   
await    
_productService  ! 0
.  0 1
	ListAsync  1 :
(  : ;
)  ; <
;  < =
return"" 
Ok"" 
("" 
products"" 
)"" 
;""  
}## 	
[&& 	
HttpGet&&	 
(&& 
$str&& 
)&& 
]&& 
['' 	
	Authorize''	 
('' 
Policy'' 
='' 
$str'' "
)''" #
]''# $
public(( 
async(( 
Task(( 
<(( 
IActionResult(( '
>((' (
GetById(() 0
(((0 1
int((1 4
id((5 7
)((7 8
{)) 	
var** 
product** 
=** 
await** 
_productService**  /
.**/ 0
GetByIdAsync**0 <
(**< =
id**= ?
)**? @
;**@ A
if++ 
(++ 
product++ 
==++ 
null++ 
)++  
return,, 
NotFound,, 
(,,  
$",,  "
$str,," 2
{,,2 3
id,,3 5
},,5 6
$str,,6 A
",,A B
),,B C
;,,C D
return-- 
Ok-- 
(-- 
product-- 
)-- 
;-- 
}.. 	
[11 	
HttpPost11	 
]11 
[22 	
	Authorize22	 
(22 
Policy22 
=22 
$str22 $
)22$ %
]22% &
public33 
async33 
Task33 
<33 
IActionResult33 '
>33' (
Add33) ,
(33, -
[33- .
FromBody33. 6
]336 7

ProductDto338 B

productDto33C M
)33M N
{44 	
if55 
(55 
!55 

ModelState55 
.55 
IsValid55 #
)55# $
return66 

BadRequest66 !
(66! "

ModelState66" ,
)66, -
;66- .
await88 
_productService88 !
.88! "
AddAsync88" *
(88* +

productDto88+ 5
)885 6
;886 7
return99 
CreatedAtAction99 "
(99" #
nameof99# )
(99) *
GetById99* 1
)991 2
,992 3
new994 7
{998 9
id99: <
=99= >

productDto99? I
.99I J
Id99J L
}99M N
,99N O

productDto99P Z
)99Z [
;99[ \
}:: 	
[== 	
HttpPut==	 
(== 
$str== 
)== 
]== 
[>> 	
	Authorize>>	 
(>> 
Policy>> 
=>> 
$str>> $
)>>$ %
]>>% &
public?? 
async?? 
Task?? 
<?? 
IActionResult?? '
>??' (
Update??) /
(??/ 0
int??0 3
id??4 6
,??6 7
[??8 9
FromBody??9 A
]??A B

ProductDto??C M

productDto??N X
)??X Y
{@@ 	
ifAA 
(AA 
!AA 

ModelStateAA 
.AA 
IsValidAA #
)AA# $
returnBB 

BadRequestBB !
(BB! "

ModelStateBB" ,
)BB, -
;BB- .
ifDD 
(DD 
idDD 
!=DD 

productDtoDD  
.DD  !
IdDD! #
)DD# $
returnEE 

BadRequestEE !
(EE! "
$strEE" 8
)EE8 9
;EE9 :
awaitGG 
_productServiceGG !
.GG! "
UpdateAsyncGG" -
(GG- .

productDtoGG. 8
)GG8 9
;GG9 :
returnHH 
	NoContentHH 
(HH 
)HH 
;HH 
}II 	
[LL 	

HttpDeleteLL	 
(LL 
$strLL 
)LL 
]LL 
[MM 	
	AuthorizeMM	 
(MM 
PolicyMM 
=MM 
$strMM $
)MM$ %
]MM% &
publicNN 
asyncNN 
TaskNN 
<NN 
IActionResultNN '
>NN' (
DeleteNN) /
(NN/ 0
intNN0 3
idNN4 6
)NN6 7
{OO 	
awaitPP 
_productServicePP !
.PP! "
DeleteAsyncPP" -
(PP- .
idPP. 0
)PP0 1
;PP1 2
returnQQ 
	NoContentQQ 
(QQ 
)QQ 
;QQ 
}RR 	
}SS 
}TT 