≈"
pC:\netMentoring\04_layered_architectures\CartServiceConsoleApp\CatalogService.DataAccess\Services\CartService.cs
	namespace 	
CatalogService
 
. 

DataAccess #
.# $
Services$ ,
{ 
public 

class 
CartService 
: 
ICartService +
{		 
private

 
readonly

 
ICartRepository

 (
_cartRepository

) 8
;

8 9
public 
CartService 
( 
ICartRepository *
cartRepository+ 9
)9 :
{ 	
_cartRepository 
= 
cartRepository ,
;, -
} 	
public 
void 
AddItem 
( 
Guid  
cartId! '
,' (
CartItem) 1
cartItem2 :
): ;
{ 	
Cart 
? 
cart 
= 
null 
; 
try 
{ 
cart 
= 
_cartRepository &
.& '
GetCartById' 2
(2 3
cartId3 9
)9 :
;: ;
} 
catch 
( !
CartNotFoundException (
ex) +
)+ ,
{ 
cart 
= 
new 
Cart 
(  
cartId  &
)& '
;' (
} 
var 
existingCartItem  
=! "
cart# '
.' (
Items( -
.- .
FirstOrDefault. <
(< =
i= >
=>? A
iB C
.C D
IdD F
==G I
cartItemJ R
.R S
IdS U
)U V
;V W
if 
( 
existingCartItem  
==! #
null$ (
)( )
{   
cart!! 
.!! 
Items!! 
.!! 
Add!! 
(!! 
cartItem!! '
)!!' (
;!!( )
}"" 
else## 
{$$ 
existingCartItem%%  
.%%  !
Quantity%%! )
+=%%* ,
cartItem%%- 5
.%%5 6
Quantity%%6 >
;%%> ?
}&& 
_cartRepository(( 
.(( 
SaveCart(( $
((($ %
cart((% )
)(() *
;((* +
})) 	
public++ 
IEnumerable++ 
<++ 
Cart++ 
>++  
GetAllCarts++! ,
(++, -
)++- .
{,, 	
return-- 
_cartRepository-- "
.--" #
GetAllCarts--# .
(--. /
)--/ 0
;--0 1
}.. 	
public00 
List00 
<00 
CartItem00 
>00 
GetItems00 &
(00& '
Guid00' +
cartId00, 2
)002 3
{11 	
var22 
cart22 
=22 
_cartRepository22 &
.22& '
GetCartById22' 2
(222 3
cartId223 9
)229 :
;22: ;
return33 
cart33 
?33 
.33 
Items33 
??33 !
new33" %
List33& *
<33* +
CartItem33+ 3
>333 4
(334 5
)335 6
;336 7
}44 	
public66 
void66 

RemoveItem66 
(66 
Guid66 #
cartId66$ *
,66* +
int66, /
itemId660 6
)666 7
{77 	
var88 
cart88 
=88 
_cartRepository88 &
.88& '
GetCartById88' 2
(882 3
cartId883 9
)889 :
;88: ;
if99 
(99 
cart99 
?99 
.99 
Items99 
!=99 
null99 #
)99# $
{:: 
cart;; 
.;; 
Items;; 
.;; 
	RemoveAll;; $
(;;$ %
i;;% &
=>;;' )
i;;* +
.;;+ ,
Id;;, .
==;;/ 1
itemId;;2 8
);;8 9
;;;9 :
_cartRepository<< 
.<<  
SaveCart<<  (
(<<( )
cart<<) -
)<<- .
;<<. /
}== 
}>> 	
}?? 
}@@ â
zC:\netMentoring\04_layered_architectures\CartServiceConsoleApp\CatalogService.DataAccess\Repositories\ProductRepository.cs
	namespace 	
CatalogService
 
. 

DataAccess #
.# $
Repositories$ 0
{ 
public 

class 
ProductRepository "
:# $
GenericRepository% 6
<6 7
Product7 >
>> ?
,? @
IProductRepositoryA S
{		 
private

 
readonly

 
CatalogDbContext

 )
_context

* 2
;

2 3
public 
ProductRepository  
(  !
CatalogDbContext! 1
context2 9
)9 :
:; <
base= A
(A B
contextB I
)I J
{ 	
_context 
= 
context 
; 
} 	
public 
async 
Task 
< 
IEnumerable %
<% &
Product& -
>- .
>. /
	ListAsync0 9
(9 :
int: =
?= >

categoryId? I
,I J
intK N
pageO S
,S T
intU X
pageSizeY a
)a b
{ 	
var 
query 
= 
_context  
.  !
Set! $
<$ %
Product% ,
>, -
(- .
). /
./ 0
AsQueryable0 ;
(; <
)< =
;= >
if 
( 

categoryId 
. 
HasValue #
)# $
{ 
query 
= 
query 
. 
Where #
(# $
p$ %
=>& (
p) *
.* +

CategoryId+ 5
==6 8

categoryId9 C
)C D
;D E
} 
query 
= 
query 
. 
Skip 
( 
(  
page  $
-% &
$num' (
)( )
** +
pageSize, 4
)4 5
.5 6
Take6 :
(: ;
pageSize; C
)C D
;D E
return 
await 
query 
. 
ToListAsync *
(* +
)+ ,
;, -
} 	
public 
async 
Task (
UpdateProductWithOutboxAsync 6
(6 7
Product7 >
product? F
,F G
stringH N
	eventTypeO X
,X Y
objectZ `
payloada h
)h i
{   	
using!! 
var!! 
transaction!! !
=!!" #
await!!$ )
_context!!* 2
.!!2 3
Database!!3 ;
.!!; <!
BeginTransactionAsync!!< Q
(!!Q R
)!!R S
;!!S T
try## 
{$$ 
_context%% 
.%% 
Set%% 
<%% 
Product%% $
>%%$ %
(%%% &
)%%& '
.%%' (
Update%%( .
(%%. /
product%%/ 6
)%%6 7
;%%7 8
await'' 
AddOutboxEventAsync'' )
('') *
	eventType''* 3
,''3 4
payload''5 <
)''< =
;''= >
await)) 
_context)) 
.)) 
SaveChangesAsync)) /
())/ 0
)))0 1
;))1 2
await++ 
transaction++ !
.++! "
CommitAsync++" -
(++- .
)++. /
;++/ 0
},, 
catch-- 
{.. 
await// 
transaction// !
.//! "
RollbackAsync//" /
(/// 0
)//0 1
;//1 2
throw00 
;00 
}11 
}22 	
}33 
}44 Í3
{C:\netMentoring\04_layered_architectures\CartServiceConsoleApp\CatalogService.DataAccess\Repositories\CategoryRepository.cs
	namespace 	
CatalogService
 
. 

DataAccess #
.# $
Repositories$ 0
{ 
public 

class 
CategoryRepository #
:$ %
GenericRepository& 7
<7 8
Category8 @
>@ A
,A B
ICategoryRepositoryC V
{		 
private

 
readonly

 
CatalogDbContext

 )
_context

* 2
;

2 3
public 
CategoryRepository !
(! "
CatalogDbContext" 2
context3 :
): ;
:< =
base> B
(B C
contextC J
)J K
{ 	
_context 
= 
context 
; 
} 	
public 
async 
Task #
DeleteWithProductsAsync 1
(1 2
int2 5
id6 8
)8 9
{ 	
using 
var 
transaction !
=" #
await$ )
_context* 2
.2 3
Database3 ;
.; <!
BeginTransactionAsync< Q
(Q R
)R S
;S T
try 
{ 
var 
category 
= 
await $
_context% -
.- .

Categories. 8
.8 9
FirstOrDefaultAsync9 L
(L M
cM N
=>O Q
cR S
.S T
IdT V
==W Y
idZ \
)\ ]
;] ^
if 
( 
category 
== 
null  $
)$ %
{ 
throw 
new  
KeyNotFoundException 2
(2 3
$"3 5
$str5 F
{F G
idG I
}I J
$strJ Z
"Z [
)[ \
;\ ]
} 
var 
childCategories #
=$ %
new& )
List* .
<. /
Category/ 7
>7 8
(8 9
)9 :
;: ;
await ,
 GetChildCategoriesRecursiveAsync 6
(6 7
id7 9
,9 :
childCategories; J
)J K
;K L
var   
childCategoryIds   $
=  % &
childCategories  ' 6
.  6 7
Select  7 =
(  = >
c  > ?
=>  @ B
c  C D
.  D E
Id  E G
)  G H
.  H I
ToList  I O
(  O P
)  P Q
;  Q R
var!! %
productsInChildCategories!! -
=!!. /
await!!0 5
_context!!6 >
.!!> ?
Products!!? G
."" 
Where"" 
("" 
p"" 
=>"" 
childCategoryIds""  0
.""0 1
Contains""1 9
(""9 :
p"": ;
.""; <

CategoryId""< F
)""F G
)""G H
.## 
ToListAsync##  
(##  !
)##! "
;##" #
if%% 
(%% %
productsInChildCategories%% -
.%%- .
Any%%. 1
(%%1 2
)%%2 3
)%%3 4
{&& 
_context'' 
.'' 
Products'' %
.''% &
RemoveRange''& 1
(''1 2%
productsInChildCategories''2 K
)''K L
;''L M
}(( 
if** 
(** 
childCategories** #
.**# $
Any**$ '
(**' (
)**( )
)**) *
{++ 
_context,, 
.,, 

Categories,, '
.,,' (
RemoveRange,,( 3
(,,3 4
childCategories,,4 C
),,C D
;,,D E
}-- 
var// 
productsToDelete// $
=//% &
await//' ,
_context//- 5
.//5 6
Products//6 >
.//> ?
Where//? D
(//D E
p//E F
=>//G I
p//J K
.//K L

CategoryId//L V
==//W Y
id//Z \
)//\ ]
.//] ^
ToListAsync//^ i
(//i j
)//j k
;//k l
if11 
(11 
productsToDelete11 $
.11$ %
Any11% (
(11( )
)11) *
)11* +
{22 
_context33 
.33 
Products33 %
.33% &
RemoveRange33& 1
(331 2
productsToDelete332 B
)33B C
;33C D
}44 
_context66 
.66 

Categories66 #
.66# $
Remove66$ *
(66* +
category66+ 3
)663 4
;664 5
await88 
_context88 
.88 
SaveChangesAsync88 /
(88/ 0
)880 1
;881 2
await99 
transaction99 !
.99! "
CommitAsync99" -
(99- .
)99. /
;99/ 0
}:: 
catch;; 
{<< 
await== 
transaction== !
.==! "
RollbackAsync==" /
(==/ 0
)==0 1
;==1 2
throw>> 
;>> 
}?? 
}@@ 	
privateBB 
asyncBB 
TaskBB ,
 GetChildCategoriesRecursiveAsyncBB ;
(BB; <
intBB< ?
parentCategoryIdBB@ P
,BBP Q
ListBBR V
<BBV W
CategoryBBW _
>BB_ `
childCategoriesBBa p
)BBp q
{CC 	
varDD !
directChildCategoriesDD %
=DD& '
awaitDD( -
_contextDD. 6
.DD6 7

CategoriesDD7 A
.EE 
WhereEE 
(EE 
cEE 
=>EE 
cEE 
.EE 
ParentCategoryIdEE .
==EE/ 1
parentCategoryIdEE2 B
)EEB C
.FF 
ToListAsyncFF 
(FF 
)FF 
;FF 
foreachHH 
(HH 
varHH 
childHH 
inHH !!
directChildCategoriesHH" 7
)HH7 8
{II 
childCategoriesJJ 
.JJ  
AddJJ  #
(JJ# $
childJJ$ )
)JJ) *
;JJ* +
awaitLL ,
 GetChildCategoriesRecursiveAsyncLL 6
(LL6 7
childLL7 <
.LL< =
IdLL= ?
,LL? @
childCategoriesLLA P
)LLP Q
;LLQ R
}MM 
}NN 	
}OO 
}PP ±
wC:\netMentoring\04_layered_architectures\CartServiceConsoleApp\CatalogService.DataAccess\Repositories\CartRepository.cs
	namespace 	
CatalogService
 
. 
Domain 
.  
Repositories  ,
{ 
public 

class 
CartRepository 
:  !
ICartRepository" 1
{ 
private		 
readonly		 
ICartDatabase		 &
<		& '
Cart		' +
>		+ ,
	_database		- 6
;		6 7
public 
CartRepository 
( 
ICartDatabase +
<+ ,
Cart, 0
>0 1
database2 :
): ;
{ 	
	_database 
= 
database  
;  !
} 	
public 
Cart 
GetCartById 
(  
Guid  $
cartId% +
)+ ,
{ 	
try 
{ 
var 
cart 
= 
	_database $
.$ %
FindById% -
(- .
cartId. 4
)4 5
;5 6
if 
( 
cart 
== 
null  
)  !
{ 
throw 
new !
CartNotFoundException 3
(3 4
cartId4 :
): ;
;; <
} 
return 
cart 
; 
} 
catch 
( !
DatabaseReadException (
ex) +
)+ ,
{ 
throw 
new 
RepositoryException -
(- .
$str. R
,R S
exT V
)V W
;W X
}   
}!! 	
public## 
void## 
SaveCart## 
(## 
Cart## !
cart##" &
)##& '
{$$ 	
try%% 
{&& 
	_database'' 
.'' 
Upsert''  
(''  !
cart''! %
)''% &
;''& '
}(( 
catch)) 
()) "
DatabaseWriteException)) )
ex))* ,
))), -
{** 
throw++ 
new++ 
RepositoryException++ -
(++- .
$str++. N
,++N O
ex++P R
)++R S
;++S T
},, 
}-- 	
public// 
void// 

DeleteCart// 
(// 
Guid// #
cartId//$ *
)//* +
{00 	
try11 
{22 
	_database33 
.33 
Delete33  
(33  !
cartId33! '
)33' (
;33( )
}44 
catch55 
(55 !
CartNotFoundException55 (
ex55) +
)55+ ,
{66 
throw77 
;77 
}88 
catch99 
(99 "
DatabaseWriteException99 )
ex99* ,
)99, -
{:: 
throw;; 
new;; 
RepositoryException;; -
(;;- .
$str;;. P
,;;P Q
ex;;R T
);;T U
;;;U V
}<< 
}== 	
public?? 
IEnumerable?? 
<?? 
Cart?? 
>??  
GetAllCarts??! ,
(??, -
)??- .
{@@ 	
tryAA 
{BB 
returnCC 
	_databaseCC  
.CC  !
GetAllCC! '
(CC' (
)CC( )
;CC) *
}DD 
catchEE 
(EE !
DatabaseReadExceptionEE (
exEE) +
)EE+ ,
{FF 
throwGG 
newGG 
RepositoryExceptionGG -
(GG- .
$strGG. R
,GGR S
exGGT V
)GGV W
;GGW X
}HH 
}II 	
}JJ 
}KK ˜
uC:\netMentoring\04_layered_architectures\CartServiceConsoleApp\CatalogService.DataAccess\RabbitMQ\RabbitMqSettings.cs
	namespace 	
CatalogService
 
. 

DataAccess #
.# $
RabbitMQ$ ,
{ 
public 

class 
RabbitMqSettings !
{ 
public 
string 
HostName 
{  
get! $
;$ %
set& )
;) *
}+ ,
public 
int 
Port 
{ 
get 
; 
set "
;" #
}$ %
public 
string 
	QueueName 
{  !
get" %
;% &
set' *
;* +
}, -
public 
string 
UserName 
{  
get! $
;$ %
set& )
;) *
}+ ,
public		 
string		 
Password		 
{		  
get		! $
;		$ %
set		& )
;		) *
}		+ ,
}

 
} Á
ÑC:\netMentoring\04_layered_architectures\CartServiceConsoleApp\CatalogService.DataAccess\Migrations\20250512104332_AddOutboxTable.cs
	namespace 	
CatalogService
 
. 

DataAccess #
.# $

Migrations$ .
{ 
public		 

partial		 
class		 
AddOutboxTable		 '
:		( )
	Migration		* 3
{

 
	protected 
override 
void 
Up  "
(" #
MigrationBuilder# 3
migrationBuilder4 D
)D E
{ 	
migrationBuilder 
. 
CreateTable (
(( )
name 
: 
$str 
, 
columns 
: 
table 
=> !
new" %
{ 
Id 
= 
table 
. 
Column %
<% &
int& )
>) *
(* +
type+ /
:/ 0
$str1 6
,6 7
nullable8 @
:@ A
falseB G
)G H
. 

Annotation #
(# $
$str$ 8
,8 9
$str: @
)@ A
,A B
	EventType 
= 
table  %
.% &
Column& ,
<, -
string- 3
>3 4
(4 5
type5 9
:9 :
$str; J
,J K
	maxLengthL U
:U V
$numW Z
,Z [
nullable\ d
:d e
falsef k
)k l
,l m
Payload 
= 
table #
.# $
Column$ *
<* +
string+ 1
>1 2
(2 3
type3 7
:7 8
$str9 H
,H I
nullableJ R
:R S
falseT Y
)Y Z
,Z [
IsProcessed 
=  !
table" '
.' (
Column( .
<. /
bool/ 3
>3 4
(4 5
type5 9
:9 :
$str; @
,@ A
nullableB J
:J K
falseL Q
,Q R
defaultValueS _
:_ `
falsea f
)f g
,g h
	CreatedAt 
= 
table  %
.% &
Column& ,
<, -
DateTime- 5
>5 6
(6 7
type7 ;
:; <
$str= H
,H I
nullableJ R
:R S
falseT Y
,Y Z
defaultValueSql[ j
:j k
$strl z
)z {
,{ |
ProcessedAt 
=  !
table" '
.' (
Column( .
<. /
DateTime/ 7
>7 8
(8 9
type9 =
:= >
$str? J
,J K
nullableL T
:T U
trueV Z
)Z [
} 
, 
constraints 
: 
table "
=># %
{ 
table 
. 

PrimaryKey $
($ %
$str% 0
,0 1
x2 3
=>4 6
x7 8
.8 9
Id9 ;
); <
;< =
} 
) 
; 
} 	
	protected!! 
override!! 
void!! 
Down!!  $
(!!$ %
MigrationBuilder!!% 5
migrationBuilder!!6 F
)!!F G
{"" 	
migrationBuilder## 
.## 
	DropTable## &
(##& '
name$$ 
:$$ 
$str$$ 
)$$ 
;$$  
}%% 	
}&& 
}'' ÷
âC:\netMentoring\04_layered_architectures\CartServiceConsoleApp\CatalogService.DataAccess\Migrations\20250424222729_EnableCascadeDelete.cs
	namespace 	
CatalogService
 
. 

DataAccess #
.# $

Migrations$ .
{ 
public 

partial 
class 
EnableCascadeDelete ,
:- .
	Migration/ 8
{		 
	protected 
override 
void 
Up  "
(" #
MigrationBuilder# 3
migrationBuilder4 D
)D E
{ 	
} 	
	protected 
override 
void 
Down  $
($ %
MigrationBuilder% 5
migrationBuilder6 F
)F G
{ 	
} 	
} 
} ∏
ãC:\netMentoring\04_layered_architectures\CartServiceConsoleApp\CatalogService.DataAccess\Migrations\20250416220805_RenameImageToImageUrl.cs
	namespace 	
CatalogService
 
. 

DataAccess #
.# $

Migrations$ .
{ 
public 

partial 
class !
RenameImageToImageUrl .
:/ 0
	Migration1 :
{		 
	protected 
override 
void 
Up  "
(" #
MigrationBuilder# 3
migrationBuilder4 D
)D E
{ 	
migrationBuilder 
. 
RenameColumn )
() *
name 
: 
$str 
, 
table 
: 
$str #
,# $
newName 
: 
$str #
)# $
;$ %
} 	
	protected 
override 
void 
Down  $
($ %
MigrationBuilder% 5
migrationBuilder6 F
)F G
{ 	
migrationBuilder 
. 
RenameColumn )
() *
name 
: 
$str  
,  !
table 
: 
$str #
,# $
newName 
: 
$str  
)  !
;! "
} 	
} 
} ∆<
ÉC:\netMentoring\04_layered_architectures\CartServiceConsoleApp\CatalogService.DataAccess\Migrations\20250416213849_InitialCreate.cs
	namespace 	
CatalogService
 
. 

DataAccess #
.# $

Migrations$ .
{ 
public 

partial 
class 
InitialCreate &
:' (
	Migration) 2
{		 
	protected 
override 
void 
Up  "
(" #
MigrationBuilder# 3
migrationBuilder4 D
)D E
{ 	
migrationBuilder 
. 
CreateTable (
(( )
name 
: 
$str "
," #
columns 
: 
table 
=> !
new" %
{ 
Id 
= 
table 
. 
Column %
<% &
int& )
>) *
(* +
type+ /
:/ 0
$str1 6
,6 7
nullable8 @
:@ A
falseB G
)G H
. 

Annotation #
(# $
$str$ 8
,8 9
$str: @
)@ A
,A B
Name 
= 
table  
.  !
Column! '
<' (
string( .
>. /
(/ 0
type0 4
:4 5
$str6 D
,D E
	maxLengthF O
:O P
$numQ S
,S T
nullableU ]
:] ^
false_ d
)d e
,e f
Image 
= 
table !
.! "
Column" (
<( )
string) /
>/ 0
(0 1
type1 5
:5 6
$str7 F
,F G
nullableH P
:P Q
trueR V
)V W
,W X
ParentCategoryId $
=% &
table' ,
., -
Column- 3
<3 4
int4 7
>7 8
(8 9
type9 =
:= >
$str? D
,D E
nullableF N
:N O
trueP T
)T U
} 
, 
constraints 
: 
table "
=># %
{ 
table 
. 

PrimaryKey $
($ %
$str% 4
,4 5
x6 7
=>8 :
x; <
.< =
Id= ?
)? @
;@ A
table 
. 

ForeignKey $
($ %
name 
: 
$str I
,I J
column 
: 
x  !
=>" $
x% &
.& '
ParentCategoryId' 7
,7 8
principalTable &
:& '
$str( 4
,4 5
principalColumn '
:' (
$str) -
)- .
;. /
} 
) 
; 
migrationBuilder!! 
.!! 
CreateTable!! (
(!!( )
name"" 
:"" 
$str""  
,""  !
columns## 
:## 
table## 
=>## !
new##" %
{$$ 
Id%% 
=%% 
table%% 
.%% 
Column%% %
<%%% &
int%%& )
>%%) *
(%%* +
type%%+ /
:%%/ 0
$str%%1 6
,%%6 7
nullable%%8 @
:%%@ A
false%%B G
)%%G H
.&& 

Annotation&& #
(&&# $
$str&&$ 8
,&&8 9
$str&&: @
)&&@ A
,&&A B
Name'' 
='' 
table''  
.''  !
Column''! '
<''' (
string''( .
>''. /
(''/ 0
type''0 4
:''4 5
$str''6 D
,''D E
	maxLength''F O
:''O P
$num''Q S
,''S T
nullable''U ]
:''] ^
false''_ d
)''d e
,''e f
Description(( 
=((  !
table((" '
.((' (
Column((( .
<((. /
string((/ 5
>((5 6
(((6 7
type((7 ;
:((; <
$str((= L
,((L M
nullable((N V
:((V W
true((X \
)((\ ]
,((] ^
Image)) 
=)) 
table)) !
.))! "
Column))" (
<))( )
string))) /
>))/ 0
())0 1
type))1 5
:))5 6
$str))7 F
,))F G
nullable))H P
:))P Q
true))R V
)))V W
,))W X
Price** 
=** 
table** !
.**! "
Column**" (
<**( )
decimal**) 0
>**0 1
(**1 2
type**2 6
:**6 7
$str**8 G
,**G H
nullable**I Q
:**Q R
false**S X
)**X Y
,**Y Z
Amount++ 
=++ 
table++ "
.++" #
Column++# )
<++) *
long++* .
>++. /
(++/ 0
type++0 4
:++4 5
$str++6 >
,++> ?
nullable++@ H
:++H I
false++J O
)++O P
,++P Q

CategoryId,, 
=,,  
table,,! &
.,,& '
Column,,' -
<,,- .
int,,. 1
>,,1 2
(,,2 3
type,,3 7
:,,7 8
$str,,9 >
,,,> ?
nullable,,@ H
:,,H I
false,,J O
),,O P
}-- 
,-- 
constraints.. 
:.. 
table.. "
=>..# %
{// 
table00 
.00 

PrimaryKey00 $
(00$ %
$str00% 2
,002 3
x004 5
=>006 8
x009 :
.00: ;
Id00; =
)00= >
;00> ?
table11 
.11 

ForeignKey11 $
(11$ %
name22 
:22 
$str22 A
,22A B
column33 
:33 
x33  !
=>33" $
x33% &
.33& '

CategoryId33' 1
,331 2
principalTable44 &
:44& '
$str44( 4
,444 5
principalColumn55 '
:55' (
$str55) -
,55- .
onDelete66  
:66  !
ReferentialAction66" 3
.663 4
Cascade664 ;
)66; <
;66< =
}77 
)77 
;77 
migrationBuilder99 
.99 
CreateIndex99 (
(99( )
name:: 
::: 
$str:: 6
,::6 7
table;; 
:;; 
$str;; #
,;;# $
column<< 
:<< 
$str<< *
)<<* +
;<<+ ,
migrationBuilder>> 
.>> 
CreateIndex>> (
(>>( )
name?? 
:?? 
$str?? .
,??. /
table@@ 
:@@ 
$str@@ !
,@@! "
columnAA 
:AA 
$strAA $
)AA$ %
;AA% &
}BB 	
	protectedEE 
overrideEE 
voidEE 
DownEE  $
(EE$ %
MigrationBuilderEE% 5
migrationBuilderEE6 F
)EEF G
{FF 	
migrationBuilderGG 
.GG 
	DropTableGG &
(GG& '
nameHH 
:HH 
$strHH  
)HH  !
;HH! "
migrationBuilderJJ 
.JJ 
	DropTableJJ &
(JJ& '
nameKK 
:KK 
$strKK "
)KK" #
;KK# $
}LL 	
}MM 
}NN ë
sC:\netMentoring\04_layered_architectures\CartServiceConsoleApp\CatalogService.DataAccess\Interfaces\ICartService.cs
	namespace 	
CatalogService
 
. 

DataAccess #
.# $

Interfaces$ .
{ 
public 

	interface 
ICartService !
{ 
List 
< 
CartItem 
> 
GetItems 
(  
Guid  $
cartId% +
)+ ,
;, -
void 
AddItem 
( 
Guid 
cartId  
,  !
CartItem" *
item+ /
)/ 0
;0 1
void		 

RemoveItem		 
(		 
Guid		 
cartId		 #
,		# $
int		% (
itemId		) /
)		/ 0
;		0 1
IEnumerable

 
<

 
Cart

 
>

 
GetAllCarts

 %
(

% &
)

& '
;

' (
} 
} ù&
rC:\netMentoring\04_layered_architectures\CartServiceConsoleApp\CatalogService.DataAccess\Data\GenericRepository.cs
	namespace 	
CatalogService
 
. 

DataAccess #
.# $
Data$ (
{ 
public 

class 
GenericRepository "
<" #
T# $
>$ %
:& '
IRepository( 3
<3 4
T4 5
>5 6
where7 <
T= >
:? @
classA F
{		 
private

 
readonly

 
CatalogDbContext

 )
_context

* 2
;

2 3
private 
readonly 
DbSet 
< 
T  
>  !
_dbSet" (
;( )
public 
GenericRepository  
(  !
CatalogDbContext! 1
context2 9
)9 :
{ 	
_context 
= 
context 
; 
_dbSet 
= 
context 
. 
Set  
<  !
T! "
>" #
(# $
)$ %
;% &
} 	
public 
async 
Task 
< 
T 
> 
AddAsync %
(% &
T& '
entity( .
). /
{ 	
await 
_dbSet 
. 
AddAsync !
(! "
entity" (
)( )
;) *
await 
_context 
. 
SaveChangesAsync +
(+ ,
), -
;- .
return 
entity 
; 
} 	
public 
async 
Task 
DeleteAsync %
(% &
int& )
id* ,
), -
{ 	
var 
entity 
= 
await 
_dbSet %
.% &
	FindAsync& /
(/ 0
id0 2
)2 3
;3 4
if 
( 
entity 
!= 
null 
) 
{ 
_dbSet 
. 
Remove 
( 
entity $
)$ %
;% &
await   
_context   
.   
SaveChangesAsync   /
(  / 0
)  0 1
;  1 2
}!! 
}"" 	
public$$ 
async$$ 
Task$$ 
<$$ 
T$$ 
>$$ 
GetByIdAsync$$ )
($$) *
int$$* -
id$$. 0
)$$0 1
{%% 	
return&& 
await&& 
_dbSet&& 
.&&  
	FindAsync&&  )
(&&) *
id&&* ,
)&&, -
;&&- .
}'' 	
public)) 
async)) 
Task)) 
<)) 
IEnumerable)) %
<))% &
T))& '
>))' (
>))( )
	ListAsync))* 3
())3 4
)))4 5
{** 	
return++ 
await++ 
_dbSet++ 
.++  
ToListAsync++  +
(+++ ,
)++, -
;++- .
},, 	
public.. 
async.. 
Task.. 
UpdateAsync.. %
(..% &
T..& '
entity..( .
)... /
{// 	
_dbSet00 
.00 
Update00 
(00 
entity00  
)00  !
;00! "
await11 
_context11 
.11 
SaveChangesAsync11 +
(11+ ,
)11, -
;11- .
}22 	
public44 
virtual44 
async44 
Task44 !
AddOutboxEventAsync44" 5
(445 6
string446 <
	eventType44= F
,44F G
object44H N
payload44O V
)44V W
{55 	
string66 
payloadJson66 
=66  
JsonSerializer66! /
.66/ 0
	Serialize660 9
(669 :
payload66: A
)66A B
;66B C
var88 
outboxRecord88 
=88 
new88 "
Outbox88# )
{99 
	EventType:: 
=:: 
	eventType:: %
,::% &
Payload;; 
=;; 
payloadJson;; %
,;;% &
IsProcessed<< 
=<< 
false<< #
,<<# $
	CreatedAt== 
=== 
DateTime== $
.==$ %
UtcNow==% +
}>> 
;>> 
await@@ 
_context@@ 
.@@ 
Set@@ 
<@@ 
Outbox@@ %
>@@% &
(@@& '
)@@' (
.@@( )
AddAsync@@) 1
(@@1 2
outboxRecord@@2 >
)@@> ?
;@@? @
}AA 	
}BB 
}CC œ	
{C:\netMentoring\04_layered_architectures\CartServiceConsoleApp\CatalogService.DataAccess\Data\DesignTimeDbContextFactory.cs
	namespace 	
CatalogService
 
. 

DataAccess #
.# $
Data$ (
{ 
public 

class &
DesignTimeDbContextFactory +
:, -'
IDesignTimeDbContextFactory. I
<I J
CatalogDbContextJ Z
>Z [
{ 
public 
CatalogDbContext 
CreateDbContext  /
(/ 0
string0 6
[6 7
]7 8
args9 =
)= >
{		 	
var

 
optionsBuilder

 
=

  
new

! $#
DbContextOptionsBuilder

% <
<

< =
CatalogDbContext

= M
>

M N
(

N O
)

O P
;

P Q
optionsBuilder 
. 
UseSqlServer '
(' (
$str( {
){ |
;| }
return 
new 
CatalogDbContext '
(' (
optionsBuilder( 6
.6 7
Options7 >
)> ?
;? @
} 	
} 
} ñ8
qC:\netMentoring\04_layered_architectures\CartServiceConsoleApp\CatalogService.DataAccess\Data\CatalogDbContext.cs
	namespace 	
CatalogService
 
. 

DataAccess #
.# $
Data$ (
{ 
public 

class 
CatalogDbContext !
:" #
	DbContext$ -
{ 
public 
CatalogDbContext 
(  
DbContextOptions  0
<0 1
CatalogDbContext1 A
>A B
optionsC J
)J K
:L M
baseN R
(R S
optionsS Z
)Z [
{		 	
} 	
public 
DbSet 
< 
Category 
> 

Categories )
{* +
get, /
;/ 0
set1 4
;4 5
}6 7
public 
DbSet 
< 
Product 
> 
Products &
{' (
get) ,
;, -
set. 1
;1 2
}3 4
public 
DbSet 
< 
Outbox 
> 
Outbox #
{$ %
get& )
;) *
set+ .
;. /
}0 1
	protected 
override 
void 
OnModelCreating  /
(/ 0
ModelBuilder0 <
modelBuilder= I
)I J
{ 	
base 
. 
OnModelCreating  
(  !
modelBuilder! -
)- .
;. /
modelBuilder 
. 
Entity 
<  
Category  (
>( )
() *
entity* 0
=>1 3
{ 
entity 
. 
HasKey 
( 
c 
=>  "
c# $
.$ %
Id% '
)' (
;( )
entity 
. 
Property 
(  
e  !
=>" $
e% &
.& '
Name' +
)+ ,
. 

IsRequired !
(! "
)" #
. 
HasMaxLength #
(# $
$num$ &
)& '
;' (
entity 
. 
Property 
(  
p  !
=>" $
p% &
.& '
ImageUrl' /
)/ 0
. 
HasConversion "
(" #
v 
=> 
v 
== 
null  $
?% &
null' +
:, -
v. /
./ 0
ToString0 8
(8 9
)9 :
,: ;
v   
=>   
v   
==   
null    $
?  % &
null  ' +
:  , -
new  . 1
Uri  2 5
(  5 6
v  6 7
)  7 8
)  8 9
;  9 :
entity"" 
."" 
HasOne"" 
("" 
c"" 
=>""  "
c""# $
.""$ %
ParentCategory""% 3
)""3 4
.## 
WithMany## 
(## 
)## 
.$$ 
HasForeignKey$$ "
($$" #
c$$# $
=>$$% '
c$$( )
.$$) *
ParentCategoryId$$* :
)$$: ;
;$$; <
}%% 
)%% 
;%% 
modelBuilder'' 
.'' 
Entity'' 
<''  
Product''  '
>''' (
(''( )
entity'') /
=>''0 2
{(( 
entity)) 
.)) 
HasKey)) 
()) 
e)) 
=>))  "
e))# $
.))$ %
Id))% '
)))' (
;))( )
entity++ 
.++ 
Property++ 
(++  
e++  !
=>++" $
e++% &
.++& '
Name++' +
)+++ ,
.,, 

IsRequired,, !
(,,! "
),," #
.-- 
HasMaxLength-- #
(--# $
$num--$ &
)--& '
;--' (
entity// 
.// 
Property// 
(//  
p//  !
=>//" $
p//% &
.//& '
Description//' 2
)//2 3
.00 

IsRequired00 
(00  
false00  %
)00% &
;00& '
entity22 
.22 
Property22 
(22  
e22  !
=>22" $
e22% &
.22& '
Price22' ,
)22, -
.22- .

IsRequired22. 8
(228 9
)229 :
;22: ;
entity44 
.44 
Property44 
(44  
e44  !
=>44" $
e44% &
.44& '
Amount44' -
)44- .
.44. /

IsRequired44/ 9
(449 :
)44: ;
;44; <
entity66 
.66 
HasOne66 
(66 
p66 
=>66  "
p66# $
.66$ %
Category66% -
)66- .
.77 
WithMany77 
(77 
)77 
.88 
HasForeignKey88 "
(88" #
p88# $
=>88% '
p88( )
.88) *

CategoryId88* 4
)884 5
.99 

IsRequired99 
(99  
)99  !
.:: 
OnDelete:: 
(:: 
DeleteBehavior:: ,
.::, -
Cascade::- 4
)::4 5
;::5 6
};; 
);; 
;;; 
modelBuilder== 
.== 
Entity== 
<==  
Outbox==  &
>==& '
(==' (
entity==( .
=>==/ 1
{>> 
entity?? 
.?? 
HasKey?? 
(?? 
e?? 
=>??  "
e??# $
.??$ %
Id??% '
)??' (
;??( )
entity@@ 
.@@ 
Property@@ 
(@@  
e@@  !
=>@@" $
e@@% &
.@@& '
	EventType@@' 0
)@@0 1
.@@1 2

IsRequired@@2 <
(@@< =
)@@= >
.@@> ?
HasMaxLength@@? K
(@@K L
$num@@L O
)@@O P
;@@P Q
entityAA 
.AA 
PropertyAA 
(AA  
eAA  !
=>AA" $
eAA% &
.AA& '
PayloadAA' .
)AA. /
.AA/ 0

IsRequiredAA0 :
(AA: ;
)AA; <
;AA< =
entityBB 
.BB 
PropertyBB 
(BB  
eBB  !
=>BB" $
eBB% &
.BB& '
IsProcessedBB' 2
)BB2 3
.BB3 4
HasDefaultValueBB4 C
(BBC D
falseBBD I
)BBI J
;BBJ K
entityCC 
.CC 
PropertyCC 
(CC  
eCC  !
=>CC" $
eCC% &
.CC& '
	CreatedAtCC' 0
)CC0 1
.CC1 2
HasDefaultValueSqlCC2 D
(CCD E
$strCCE S
)CCS T
;CCT U
}DD 
)DD 
;DD 
}EE 	
}FF 
}GG ◊{
xC:\netMentoring\04_layered_architectures\CartServiceConsoleApp\CatalogService.DataAccess\Databases\LiteDbCartDatabase.cs
	namespace 	
CatalogService
 
. 
Domain 
.  
	Databases  )
{ 
public 

class 
LiteDbCartDatabase #
:$ %
ICartDatabase& 3
<3 4
Cart4 8
>8 9
,9 :
IDisposable; F
{		 
private

 
readonly

 
LiteDatabase

 %
_db

& )
;

) *
private 
readonly 
SemaphoreSlim &

_semaphore' 1
;1 2
private 
volatile 
bool 
	_disposed '
;' (
private 
readonly #
CancellationTokenSource 0
_cts1 5
=6 7
new8 ;#
CancellationTokenSource< S
(S T
)T U
;U V
public 
LiteDbCartDatabase !
(! "
string" (

connection) 3
)3 4
{ 	
try 
{ 
var 
connectionString $
=% &
new' *
ConnectionString+ ;
(; <

connection< F
)F G
{H I

ConnectionJ T
=U V
ConnectionTypeW e
.e f
Sharedf l
}m n
;n o
_db 
= 
new 
LiteDatabase &
(& '
connectionString' 7
)7 8
;8 9

_semaphore 
= 
new  
SemaphoreSlim! .
(. /
$num/ 0
,0 1
$num2 3
)3 4
;4 5
} 
catch 
( 
	Exception 
ex 
)  
{ 
Console 
. 
	WriteLine !
(! "
$"" $
$str$ X
{X Y
exY [
.[ \
Message\ c
}c d
"d e
)e f
;f g
throw 
; 
} 
} 	
public 
Cart 
FindById 
( 
Guid !
id" $
)$ %
{ 	
try   
{!! 
return"" 
ExecuteWithLock"" &
(""& '
(""' (
)""( )
=>""* ,
{## 
CheckDisposed$$ !
($$! "
)$$" #
;$$# $
var%% 

collection%% "
=%%# $
_db%%% (
.%%( )
GetCollection%%) 6
<%%6 7
Cart%%7 ;
>%%; <
(%%< =
$str%%= D
)%%D E
;%%E F
return&& 

collection&& %
.&&% &
FindById&&& .
(&&. /
id&&/ 1
)&&1 2
;&&2 3
}'' 
)'' 
;'' 
}(( 
catch)) 
()) 
LiteException))  
ex))! #
)))# $
{** 
Console++ 
.++ 
	WriteLine++ !
(++! "
$"++" $
$str++$ K
{++K L
id++L N
}++N O
$str++O R
{++R S
ex++S U
.++U V
Message++V ]
}++] ^
"++^ _
)++_ `
;++` a
throw,, 
new,, !
DatabaseReadException,, /
(,,/ 0
$",,0 2
$str,,2 O
{,,O P
id,,P R
},,R S
$str,,S T
",,T U
,,,U V
ex,,W Y
),,Y Z
;,,Z [
}-- 
}.. 	
public00 
IEnumerable00 
<00 
Cart00 
>00  
GetAll00! '
(00' (
)00( )
{11 	
try22 
{33 
return44 
ExecuteWithLock44 &
(44& '
(44' (
)44( )
=>44* ,
{55 
CheckDisposed66 !
(66! "
)66" #
;66# $
var77 

collection77 "
=77# $
_db77% (
.77( )
GetCollection77) 6
<776 7
Cart777 ;
>77; <
(77< =
$str77= D
)77D E
;77E F
return88 

collection88 %
.88% &
FindAll88& -
(88- .
)88. /
;88/ 0
}99 
)99 
;99 
}:: 
catch;; 
(;; 
LiteException;;  
ex;;! #
);;# $
{<< 
Console== 
.== 
	WriteLine== !
(==! "
$"==" $
$str==$ J
{==J K
ex==K M
.==M N
Message==N U
}==U V
"==V W
)==W X
;==X Y
throw>> 
new>> !
DatabaseReadException>> /
(>>/ 0
$str>>0 I
,>>I J
ex>>K M
)>>M N
;>>N O
}?? 
}@@ 	
publicBB 
voidBB 
UpsertBB 
(BB 
CartBB 
itemBB  $
)BB$ %
{CC 	
tryDD 
{EE 
ExecuteWithLockFF 
(FF  
(FF  !
)FF! "
=>FF# %
{GG 
CheckDisposedHH !
(HH! "
)HH" #
;HH# $
varII 

collectionII "
=II# $
_dbII% (
.II( )
GetCollectionII) 6
<II6 7
CartII7 ;
>II; <
(II< =
$strII= D
)IID E
;IIE F

collectionJJ 
.JJ 
UpsertJJ %
(JJ% &
itemJJ& *
)JJ* +
;JJ+ ,
}KK 
)KK 
;KK 
}LL 
catchMM 
(MM 
LiteExceptionMM  
exMM! #
)MM# $
{NN 
ConsoleOO 
.OO 
	WriteLineOO !
(OO! "
$"OO" $
$strOO$ I
{OOI J
itemOOJ N
.OON O
IdOOO Q
}OOQ R
$strOOR U
{OOU V
exOOV X
.OOX Y
MessageOOY `
}OO` a
"OOa b
)OOb c
;OOc d
throwPP 
newPP "
DatabaseWriteExceptionPP 0
(PP0 1
$"PP1 3
$strPP3 R
{PPR S
itemPPS W
.PPW X
IdPPX Z
}PPZ [
$strPP[ \
"PP\ ]
,PP] ^
exPP_ a
)PPa b
;PPb c
}QQ 
}RR 	
publicTT 
voidTT 
DeleteTT 
(TT 
GuidTT 
idTT  "
)TT" #
{UU 	
tryVV 
{WW 
ExecuteWithLockXX 
(XX  
(XX  !
)XX! "
=>XX# %
{YY 
CheckDisposedZZ !
(ZZ! "
)ZZ" #
;ZZ# $
var[[ 

collection[[ "
=[[# $
_db[[% (
.[[( )
GetCollection[[) 6
<[[6 7
Cart[[7 ;
>[[; <
([[< =
$str[[= D
)[[D E
;[[E F
if]] 
(]] 

collection]] "
.]]" #
FindById]]# +
(]]+ ,
id]], .
)]]. /
==]]0 2
null]]3 7
)]]7 8
{^^ 
throw__ 
new__ !!
CartNotFoundException__" 7
(__7 8
id__8 :
)__: ;
;__; <
}`` 

collectionbb 
.bb 
Deletebb %
(bb% &
idbb& (
)bb( )
;bb) *
}cc 
)cc 
;cc 
}dd 
catchee 
(ee 
LiteExceptionee  
exee! #
)ee# $
{ff 
Consolegg 
.gg 
	WriteLinegg !
(gg! "
$"gg" $
$strgg$ I
{ggI J
idggJ L
}ggL M
$strggM P
{ggP Q
exggQ S
.ggS T
MessageggT [
}gg[ \
"gg\ ]
)gg] ^
;gg^ _
throwhh 
newhh "
DatabaseWriteExceptionhh 0
(hh0 1
$"hh1 3
$strhh3 R
{hhR S
idhhS U
}hhU V
$strhhV W
"hhW X
,hhX Y
exhhZ \
)hh\ ]
;hh] ^
}ii 
}jj 	
privatell 
Tll 
ExecuteWithLockll !
<ll! "
Tll" #
>ll# $
(ll$ %
Funcll% )
<ll) *
Tll* +
>ll+ ,
actionll- 3
)ll3 4
{mm 	
CheckDisposednn 
(nn 
)nn 
;nn 
trypp 
{qq 
_ctsrr 
.rr 
Tokenrr 
.rr (
ThrowIfCancellationRequestedrr 7
(rr7 8
)rr8 9
;rr9 :
ifss 
(ss 
!ss 

_semaphoress 
.ss  
Waitss  $
(ss$ %
Timeoutss% ,
.ss, -
Infinitess- 5
,ss5 6
_ctsss7 ;
.ss; <
Tokenss< A
)ssA B
)ssB C
{tt 
throwuu 
newuu &
OperationCanceledExceptionuu 8
(uu8 9
$struu9 W
)uuW X
;uuX Y
}vv 
tryww 
{xx 
returnyy 
actionyy !
(yy! "
)yy" #
;yy# $
}zz 
finally{{ 
{|| 

_semaphore}} 
.}} 
Release}} &
(}}& '
)}}' (
;}}( )
}~~ 
} 
catch
ÄÄ 
(
ÄÄ %
ObjectDisposedException
ÄÄ *
ex
ÄÄ+ -
)
ÄÄ- .
{
ÅÅ 
Console
ÇÇ 
.
ÇÇ 
	WriteLine
ÇÇ !
(
ÇÇ! "
$"
ÇÇ" $
$str
ÇÇ$ M
{
ÇÇM N
ex
ÇÇN P
.
ÇÇP Q
Message
ÇÇQ X
}
ÇÇX Y
"
ÇÇY Z
)
ÇÇZ [
;
ÇÇ[ \
throw
ÉÉ 
;
ÉÉ 
}
ÑÑ 
catch
ÖÖ 
(
ÖÖ (
OperationCanceledException
ÖÖ -
ex
ÖÖ. 0
)
ÖÖ0 1
{
ÜÜ 
Console
áá 
.
áá 
	WriteLine
áá !
(
áá! "
$"
áá" $
$str
áá$ M
{
ááM N
ex
ááN P
.
ááP Q
Message
ááQ X
}
ááX Y
"
ááY Z
)
ááZ [
;
áá[ \
throw
àà 
;
àà 
}
ââ 
}
ää 	
private
åå 
void
åå 
ExecuteWithLock
åå $
(
åå$ %
Action
åå% +
action
åå, 2
)
åå2 3
{
çç 	
CheckDisposed
éé 
(
éé 
)
éé 
;
éé 
try
èè 
{
êê 
_cts
ëë 
.
ëë 
Token
ëë 
.
ëë *
ThrowIfCancellationRequested
ëë 7
(
ëë7 8
)
ëë8 9
;
ëë9 :
if
íí 
(
íí 
!
íí 

_semaphore
íí 
.
íí  
Wait
íí  $
(
íí$ %
Timeout
íí% ,
.
íí, -
Infinite
íí- 5
,
íí5 6
_cts
íí7 ;
.
íí; <
Token
íí< A
)
ííA B
)
ííB C
{
ìì 
throw
îî 
new
îî (
OperationCanceledException
îî 8
(
îî8 9
$str
îî9 W
)
îîW X
;
îîX Y
}
ïï 
try
ññ 
{
óó 
action
òò 
(
òò 
)
òò 
;
òò 
}
ôô 
finally
öö 
{
õõ 

_semaphore
úú 
.
úú 
Release
úú &
(
úú& '
)
úú' (
;
úú( )
}
ùù 
}
ûû 
catch
üü 
(
üü %
ObjectDisposedException
üü *
ex
üü+ -
)
üü- .
{
†† 
Console
°° 
.
°° 
	WriteLine
°° !
(
°°! "
$"
°°" $
$str
°°$ M
{
°°M N
ex
°°N P
.
°°P Q
Message
°°Q X
}
°°X Y
"
°°Y Z
)
°°Z [
;
°°[ \
throw
¢¢ 
;
¢¢ 
}
££ 
catch
§§ 
(
§§ (
OperationCanceledException
§§ -
ex
§§. 0
)
§§0 1
{
•• 
Console
¶¶ 
.
¶¶ 
	WriteLine
¶¶ !
(
¶¶! "
$"
¶¶" $
$str
¶¶$ M
{
¶¶M N
ex
¶¶N P
.
¶¶P Q
Message
¶¶Q X
}
¶¶X Y
"
¶¶Y Z
)
¶¶Z [
;
¶¶[ \
throw
ßß 
;
ßß 
}
®® 
}
©© 	
private
´´ 
void
´´ 
CheckDisposed
´´ "
(
´´" #
)
´´# $
{
¨¨ 	
if
≠≠ 
(
≠≠ 
	_disposed
≠≠ 
)
≠≠ 
{
ÆÆ 
throw
ØØ 
new
ØØ %
ObjectDisposedException
ØØ 1
(
ØØ1 2
nameof
ØØ2 8
(
ØØ8 9 
LiteDbCartDatabase
ØØ9 K
)
ØØK L
,
ØØL M
$str
ØØN {
)
ØØ{ |
;
ØØ| }
}
∞∞ 
}
±± 	
public
≥≥ 
void
≥≥ 
Dispose
≥≥ 
(
≥≥ 
)
≥≥ 
{
¥¥ 	
if
µµ 
(
µµ 
!
µµ 
	_disposed
µµ 
)
µµ 
{
∂∂ 
try
∑∑ 
{
∏∏ 
_cts
ππ 
.
ππ 
Cancel
ππ 
(
ππ  
)
ππ  !
;
ππ! "
_db
∫∫ 
?
∫∫ 
.
∫∫ 
Dispose
∫∫  
(
∫∫  !
)
∫∫! "
;
∫∫" #
Console
ªª 
.
ªª 
	WriteLine
ªª %
(
ªª% &
$str
ªª& \
)
ªª\ ]
;
ªª] ^
}
ºº 
catch
ΩΩ 
(
ΩΩ 
	Exception
ΩΩ  
ex
ΩΩ! #
)
ΩΩ# $
{
ææ 
Console
øø 
.
øø 
	WriteLine
øø %
(
øø% &
$"
øø& (
$str
øø( T
{
øøT U
ex
øøU W
.
øøW X
Message
øøX _
}
øø_ `
"
øø` a
)
øøa b
;
øøb c
}
¿¿ 
try
¡¡ 
{
¬¬ 

_semaphore
√√ 
?
√√ 
.
√√  
Dispose
√√  '
(
√√' (
)
√√( )
;
√√) *
Console
ƒƒ 
.
ƒƒ 
	WriteLine
ƒƒ %
(
ƒƒ% &
$str
ƒƒ& ]
)
ƒƒ] ^
;
ƒƒ^ _
}
≈≈ 
catch
∆∆ 
(
∆∆ 
	Exception
∆∆  
ex
∆∆! #
)
∆∆# $
{
«« 
Console
»» 
.
»» 
	WriteLine
»» %
(
»»% &
$"
»»& (
$str
»»( X
{
»»X Y
ex
»»Y [
.
»»[ \
Message
»»\ c
}
»»c d
"
»»d e
)
»»e f
;
»»f g
}
…… 
try
   
{
ÀÀ 
_cts
ÃÃ 
?
ÃÃ 
.
ÃÃ 
Dispose
ÃÃ !
(
ÃÃ! "
)
ÃÃ" #
;
ÃÃ# $
Console
ÕÕ 
.
ÕÕ 
	WriteLine
ÕÕ %
(
ÕÕ% &
$str
ÕÕ& k
)
ÕÕk l
;
ÕÕl m
}
ŒŒ 
catch
œœ 
(
œœ 
	Exception
œœ  
ex
œœ! #
)
œœ# $
{
–– 
Console
—— 
.
—— 
	WriteLine
—— %
(
——% &
$"
——& (
$str
——( f
{
——f g
ex
——g i
.
——i j
Message
——j q
}
——q r
"
——r s
)
——s t
;
——t u
}
““ 
	_disposed
”” 
=
”” 
true
””  
;
””  !
}
‘‘ 
}
’’ 	
}
÷÷ 
}◊◊ ÷
zC:\netMentoring\04_layered_architectures\CartServiceConsoleApp\CatalogService.DataAccess\Databases\InMemoryCartDatabase.cs
	namespace 	
CatalogService
 
. 

DataAccess #
.# $
	Databases$ -
{ 
public 

class  
InMemoryCartDatabase %
:& '
ICartDatabase( 5
<5 6
Cart6 :
>: ;
{ 
private 
readonly 

Dictionary #
<# $
Guid$ (
,( )
Cart* .
>. /
_store0 6
=7 8
new9 <
(< =
)= >
;> ?
public

 
Cart

 
FindById

 
(

 
Guid

 !
id

" $
)

$ %
{ 	
_store 
. 
TryGetValue 
( 
id !
,! "
out# &
var' *
cart+ /
)/ 0
;0 1
return 
cart 
; 
} 	
public 
void 
Upsert 
( 
Cart 
item  $
)$ %
{ 	
_store 
[ 
item 
. 
Id 
] 
= 
item "
;" #
} 	
public 
void 
Delete 
( 
Guid 
id  "
)" #
{ 	
_store 
. 
Remove 
( 
id 
) 
; 
} 	
public 
IEnumerable 
< 
Cart 
>  
GetAll! '
(' (
)( )
{ 	
return 
_store 
. 
Values  
.  !
ToList! '
(' (
)( )
;) *
} 	
} 
} ˘:
~C:\netMentoring\04_layered_architectures\CartServiceConsoleApp\CatalogService.DataAccess\BackgroundServices\OutboxProcessor.cs
	namespace

 	
CatalogService


 
.

 
Application

 $
.

$ %
BackgroundServices

% 7
{ 
public 

class 
OutboxProcessor  
:! "
BackgroundService# 4
{ 
private 
readonly  
IServiceScopeFactory - 
_serviceScopeFactory. B
;B C
private 
readonly 
RabbitMqSettings )
	_settings* 3
;3 4
public 
OutboxProcessor 
(  
IServiceScopeFactory 3
serviceScopeFactory4 G
,G H
IOptionsI Q
<Q R
RabbitMqSettingsR b
>b c
optionsd k
)k l
{ 	 
_serviceScopeFactory  
=! "
serviceScopeFactory# 6
;6 7
	_settings 
= 
options 
.  
Value  %
;% &
} 	
	protected 
override 
async  
Task! %
ExecuteAsync& 2
(2 3
CancellationToken3 D
cancellationTokenE V
)V W
{ 	
try 
{ 
while 
( 
! 
cancellationToken )
.) *#
IsCancellationRequested* A
)A B
{ 
using 
var 
scope #
=$ % 
_serviceScopeFactory& :
.: ;
CreateScope; F
(F G
)G H
;H I
var 
	dbContext !
=" #
scope$ )
.) *
ServiceProvider* 9
.9 :
GetRequiredService: L
<L M
CatalogDbContextM ]
>] ^
(^ _
)_ `
;` a
var   
unprocessedEvents   )
=  * +
await  , 1
	dbContext  2 ;
.  ; <
Outbox  < B
.!! 
Where!! 
(!! 
e!!  
=>!!! #
!!!$ %
e!!% &
.!!& '
IsProcessed!!' 2
)!!2 3
."" 
ToListAsync"" $
(""$ %
cancellationToken""% 6
)""6 7
;""7 8
if$$ 
($$ 
unprocessedEvents$$ )
.$$) *
Count$$* /
==$$0 2
$num$$3 4
)$$4 5
{%% 
await&& 
Task&& "
.&&" #
Delay&&# (
(&&( )
$num&&) -
,&&- .
cancellationToken&&/ @
)&&@ A
;&&A B
continue''  
;''  !
}(( 
var** 
factory** 
=**  !
new**" %
ConnectionFactory**& 7
{++ 
HostName,,  
=,,! "
	_settings,,# ,
.,,, -
HostName,,- 5
,,,5 6
Port-- 
=-- 
	_settings-- (
.--( )
Port--) -
,--- .
UserName..  
=..! "
	_settings..# ,
..., -
UserName..- 5
,..5 6
Password//  
=//! "
	_settings//# ,
.//, -
Password//- 5
}00 
;00 
using22 
var22 

connection22 (
=22) *
await22+ 0
factory221 8
.228 9!
CreateConnectionAsync229 N
(22N O
)22O P
;22P Q
using33 
var33 
channel33 %
=33& '
await33( -

connection33. 8
.338 9
CreateChannelAsync339 K
(33K L
)33L M
;33M N
await55 
channel55 !
.55! " 
ExchangeDeclareAsync55" 6
(556 7
exchange557 ?
:55? @
$str55A Q
,55Q R
type55S W
:55W X
ExchangeType55Y e
.55e f
Direct55f l
,55l m
cancellationToken55n 
:	55 Ä
cancellationToken
55Å í
)
55í ì
;
55ì î
foreach77 
(77 
var77  
outboxEvent77! ,
in77- /
unprocessedEvents770 A
)77A B
{88 
cancellationToken99 )
.99) *(
ThrowIfCancellationRequested99* F
(99F G
)99G H
;99H I
try:: 
{;; 
var<< 
payloadBytes<<  ,
=<<- .
Encoding<</ 7
.<<7 8
UTF8<<8 <
.<<< =
GetBytes<<= E
(<<E F
outboxEvent<<F Q
.<<Q R
Payload<<R Y
)<<Y Z
;<<Z [
var== 
props==  %
===& '
new==( +
BasicProperties==, ;
{>> 

Persistent??  *
=??+ ,
true??- 1
}@@ 
;@@ 
awaitAA !
channelAA" )
.AA) *
BasicPublishAsyncAA* ;
(AA; <
exchangeBB  (
:BB( )
$strBB* :
,BB: ;

routingKeyCC  *
:CC* +
$strCC, =
,CC= >
	mandatoryDD  )
:DD) *
trueDD+ /
,DD/ 0
basicPropertiesEE  /
:EE/ 0
propsEE1 6
,EE6 7
bodyFF  $
:FF$ %
payloadBytesFF& 2
)FF2 3
;FF3 4
ConsoleHH #
.HH# $
	WriteLineHH$ -
(HH- .
$"HH. 0
$strHH0 J
{HHJ K
outboxEventHHK V
.HHV W
PayloadHHW ^
}HH^ _
"HH_ `
)HH` a
;HHa b
outboxEventJJ '
.JJ' (
IsProcessedJJ( 3
=JJ4 5
trueJJ6 :
;JJ: ;
outboxEventKK '
.KK' (
ProcessedAtKK( 3
=KK4 5
DateTimeKK6 >
.KK> ?
UtcNowKK? E
;KKE F
	dbContextMM %
.MM% &
OutboxMM& ,
.MM, -
UpdateMM- 3
(MM3 4
outboxEventMM4 ?
)MM? @
;MM@ A
}NN 
catchOO 
(OO 
	ExceptionOO (
exOO) +
)OO+ ,
{PP 
ConsoleQQ #
.QQ# $
	WriteLineQQ$ -
(QQ- .
$"QQ. 0
$strQQ0 R
{QQR S
outboxEventQQS ^
.QQ^ _
IdQQ_ a
}QQa b
$strQQb e
{QQe f
exQQf h
.QQh i
MessageQQi p
}QQp q
"QQq r
)QQr s
;QQs t
}RR 
}SS 
awaitUU 
	dbContextUU #
.UU# $
SaveChangesAsyncUU$ 4
(UU4 5
cancellationTokenUU5 F
)UUF G
;UUG H
}VV 
}WW 
catchXX 
(XX &
OperationCanceledExceptionXX -
exXX. 0
)XX0 1
{YY 
ConsoleZZ 
.ZZ 
	WriteLineZZ !
(ZZ! "
$"ZZ" $
$strZZ$ A
{ZZA B
exZZB D
}ZZD E
"ZZE F
)ZZF G
;ZZG H
return[[ 
;[[ 
}\\ 
catch]] 
(]] 
	Exception]] 
ex]] 
)]]  
{^^ 
Console__ 
.__ 
	WriteLine__ !
(__! "
$"__" $
$str__$ 8
{__8 9
ex__9 ;
}__; <
"__< =
)__= >
;__> ?
}`` 
}aa 	
}bb 
}cc 